<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Natalanalysrapport</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700;800&family=Space+Grotesk:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #1a1f2a;
      --ink-soft: #4a5569;
      --paper: #fbf7f1;
      --paper-soft: #f5eee4;
      --line: rgba(26, 31, 42, 0.12);
      --gold: #d8a24d;
      --gold-deep: #9a6a25;
      --teal: #1f9c93;
      --plum: #59334d;
      --shadow: 0 24px 70px rgba(8, 11, 22, 0.22);
      --radius: 22px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      color: var(--ink);
      font-family: "Space Grotesk", sans-serif;
      background:
        radial-gradient(1000px 520px at 8% -12%, rgba(216, 162, 77, 0.24), transparent 66%),
        radial-gradient(900px 500px at 96% 0%, rgba(31, 156, 147, 0.2), transparent 70%),
        linear-gradient(160deg, #101723 0%, #0d1320 68%, #18111c 100%);
      padding: 22px 14px 36px;
    }

    .page {
      width: min(1100px, 100%);
      margin: 0 auto;
      display: grid;
      gap: 14px;
    }

    .sheet {
      background: linear-gradient(170deg, #fffaf2 0%, var(--paper) 56%, #f3ebe0 100%);
      border: 1px solid rgba(255, 255, 255, 0.65);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      padding: 24px;
      display: grid;
      gap: 16px;
    }

    .sheet::before {
      content: "";
      position: absolute;
      width: 320px;
      height: 320px;
      top: -120px;
      right: -120px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(216, 162, 77, 0.2), transparent 70%);
      pointer-events: none;
    }

    .sheet::after {
      content: "";
      position: absolute;
      width: 260px;
      height: 260px;
      bottom: -120px;
      left: -100px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(31, 156, 147, 0.16), transparent 72%);
      pointer-events: none;
    }

    .cover {
      min-height: 560px;
      align-content: center;
      background:
        radial-gradient(1200px 520px at -16% -20%, rgba(216, 162, 77, 0.28), transparent 70%),
        radial-gradient(1000px 420px at 110% 4%, rgba(31, 156, 147, 0.22), transparent 72%),
        linear-gradient(145deg, #fff9f0 0%, #f5ecde 44%, #f1e7d8 100%);
    }

    .cover-topline {
      font-size: 0.78rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #665133;
      font-weight: 800;
    }

    .cover-title {
      margin: 0;
      font-family: "Fraunces", serif;
      font-size: clamp(2.3rem, 6.4vw, 4rem);
      line-height: 0.96;
      letter-spacing: -0.02em;
      max-width: 12ch;
    }

    .cover-subtitle {
      margin: 0;
      font-size: 1.04rem;
      color: var(--ink-soft);
      line-height: 1.6;
      max-width: 66ch;
    }

    .gift-line {
      margin: 0;
      font-family: "Fraunces", serif;
      font-size: clamp(1.3rem, 3vw, 1.8rem);
      color: #4f3427;
    }

    .cover-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .cover-intro {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 164px;
      gap: 14px;
      align-items: start;
    }

    .cover-copy {
      display: grid;
      gap: 10px;
    }

    .cover-avatar-wrap {
      margin: 0;
      border: 1px solid rgba(89, 51, 77, 0.2);
      border-radius: 18px;
      padding: 8px;
      background: linear-gradient(155deg, rgba(255, 255, 255, 0.9), rgba(246, 238, 227, 0.72));
      display: grid;
      gap: 6px;
      box-shadow: 0 10px 22px rgba(14, 16, 27, 0.14);
    }

    .cover-avatar {
      width: 100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid rgba(89, 51, 77, 0.16);
      background: rgba(255, 255, 255, 0.86);
    }

    .cover-avatar-caption {
      margin: 0;
      text-align: center;
      font-size: 0.72rem;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: #635b67;
      font-weight: 800;
    }

    .chip {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.58);
      display: grid;
      gap: 3px;
      backdrop-filter: blur(1px);
    }

    .chip label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #665f51;
      font-weight: 800;
    }

    .chip span {
      font-size: 0.94rem;
      font-weight: 700;
      color: #1d2632;
    }

    .quote {
      border: 1px solid var(--line);
      border-left: 4px solid var(--gold);
      border-radius: 16px;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.7);
      font-size: 1rem;
      line-height: 1.62;
      color: #3f2e23;
      max-width: 80ch;
    }

    .cover-natal-mini {
      display: none;
    }

    .cover-natal-mini h3 {
      margin: 0;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #665f51;
      font-weight: 800;
    }

    .cover-natal-wheel-stage {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.88), rgba(246, 238, 227, 0.72));
      min-height: 250px;
      max-width: 320px;
      width: 100%;
      padding: 8px;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .cover-natal-wheel-stage svg {
      width: 100%;
      height: auto;
      max-width: 292px;
      display: block;
    }

    .cover-natal-wheel-note {
      margin: 0;
      font-size: 0.78rem;
      line-height: 1.4;
      color: #5b6272;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      position: relative;
      z-index: 2;
    }

    .btn {
      border: 0;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 0.9rem;
      font-weight: 800;
      cursor: pointer;
      transition: transform 150ms ease, filter 150ms ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
    }

    .btn.primary {
      background: linear-gradient(120deg, #e0aa54, #b16f2d);
      color: #fff;
    }

    .btn.ghost {
      background: rgba(29, 38, 50, 0.07);
      border: 1px solid rgba(29, 38, 50, 0.2);
      color: #283240;
    }

    .sheet-head {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-end;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--line);
      position: relative;
      z-index: 1;
    }

    .eyebrow {
      margin: 0;
      font-size: 0.74rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #6d6d75;
      font-weight: 800;
    }

    .sheet-title {
      margin: 0;
      font-family: "Fraunces", serif;
      font-size: clamp(1.5rem, 3.5vw, 2rem);
      line-height: 1.1;
      letter-spacing: -0.01em;
    }

    .sheet-kicker {
      margin: 0;
      color: var(--ink-soft);
      font-size: 0.93rem;
      max-width: 38ch;
      text-align: right;
      line-height: 1.45;
    }

    .triad {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    .triad-card {
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.7);
      padding: 14px;
      display: grid;
      gap: 8px;
    }

    .triad-label {
      margin: 0;
      font-size: 0.74rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #665f51;
      font-weight: 800;
    }

    .triad-value {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 800;
      color: #1e2732;
    }

    .triad-note {
      margin: 0;
      color: #4a566a;
      font-size: 0.89rem;
      line-height: 1.5;
    }

    .narrative-box {
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.72);
      padding: 16px;
      color: #2a3342;
      line-height: 1.7;
      font-size: 1rem;
      position: relative;
      z-index: 1;
    }

    .planet-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    .natal-wheel-card {
      gap: 10px;
    }

    .natal-wheel-stage {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.9), rgba(248, 239, 227, 0.75));
      min-height: 520px;
      display: grid;
      place-items: center;
      overflow: hidden;
      padding: 10px;
    }

    .natal-wheel-stage svg {
      width: 100%;
      height: auto;
      max-width: 620px;
      display: block;
    }

    .planet-card {
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.76);
      padding: 14px;
      display: grid;
      gap: 8px;
      min-height: 170px;
    }

    .planet-head {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .planet-symbol {
      width: 28px;
      height: 28px;
      border-radius: 9px;
      border: 1px solid rgba(89, 51, 77, 0.25);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(89, 51, 77, 0.09);
      font-size: 0.98rem;
    }

    .planet-name {
      margin: 0;
      font-size: 1.03rem;
      font-weight: 800;
      color: #211b29;
    }

    .planet-meta {
      margin: 0;
      color: #596277;
      font-size: 0.84rem;
      font-weight: 600;
      line-height: 1.45;
    }

    .planet-text {
      margin: 0;
      color: #2f3950;
      font-size: 0.92rem;
      line-height: 1.55;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.74);
      padding: 14px;
      display: grid;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .card h3 {
      margin: 0;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #605a6f;
    }

    .card h4 {
      margin: 0;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #686273;
    }

    .guide-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .guide-block {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 11px;
      background: rgba(255, 255, 255, 0.7);
      display: grid;
      gap: 8px;
    }

    .guide-copy {
      display: grid;
      gap: 8px;
    }

    .guide-copy p {
      margin: 0;
      color: #2d3550;
      line-height: 1.62;
      font-size: 0.9rem;
    }

    .life-areas-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .life-areas-card {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 11px;
      background: rgba(255, 255, 255, 0.68);
      display: grid;
      gap: 6px;
    }

    .life-areas-card h4 {
      margin: 0;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #5e6073;
      font-weight: 800;
    }

    .life-areas-card p {
      margin: 0;
      color: #2f3950;
      font-size: 0.9rem;
      line-height: 1.58;
    }

    .tables-grid {
      display: grid;
      gap: 12px;
    }

    .table-wrap {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.68);
      display: grid;
      gap: 8px;
    }

    .table-scroll {
      overflow-x: auto;
      border: 1px solid rgba(89, 51, 77, 0.18);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.92);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 620px;
      font-size: 0.84rem;
      color: #2b3448;
    }

    .data-table th,
    .data-table td {
      border-bottom: 1px solid rgba(89, 51, 77, 0.14);
      padding: 7px 8px;
      text-align: left;
      vertical-align: top;
      line-height: 1.45;
    }

    .data-table th {
      background: rgba(89, 51, 77, 0.08);
      color: #42384e;
      font-weight: 800;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .table-empty {
      margin: 0;
      padding: 9px 10px;
      color: #596172;
      font-size: 0.88rem;
    }

    .kv {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .kv-item {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 9px 10px;
      background: rgba(255, 255, 255, 0.62);
      display: grid;
      gap: 3px;
    }

    .kv-item label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #676274;
      font-weight: 800;
    }

    .kv-item span {
      font-size: 0.9rem;
      font-weight: 700;
      color: #222a36;
    }

    .split {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      align-items: start;
      position: relative;
      z-index: 1;
    }

    .zodiac-hero {
      border: 1px solid var(--line);
      border-radius: 14px;
      background:
        radial-gradient(180px 120px at 14% 14%, rgba(216, 162, 77, 0.2), transparent 70%),
        radial-gradient(180px 120px at 90% 82%, rgba(31, 156, 147, 0.16), transparent 72%),
        rgba(255, 255, 255, 0.76);
      padding: 12px;
      display: grid;
      grid-template-columns: 124px minmax(0, 1fr);
      gap: 12px;
      align-items: center;
      min-height: 160px;
    }

    .zodiac-emblem {
      width: 124px;
      min-height: 132px;
      border-radius: 14px;
      border: 1px solid rgba(89, 51, 77, 0.26);
      display: grid;
      place-items: center;
      grid-template-rows: auto auto;
      gap: 4px;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.8);
    }

    .zodiac-icon-large {
      font-size: 3rem;
      line-height: 1;
    }

    .zodiac-char-large {
      font-size: 2.2rem;
      line-height: 1;
      font-weight: 800;
      color: #34253f;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.86);
    }

    .zodiac-hero-copy {
      display: grid;
      gap: 4px;
    }

    .zodiac-animal {
      margin: 0;
      font-size: 1rem;
      color: #222a36;
      font-weight: 800;
    }

    .zodiac-style {
      margin: 0;
      color: #505c71;
      font-size: 0.88rem;
      line-height: 1.45;
    }

    .zodiac-meta {
      margin: 2px 0 0;
      color: #47506a;
      font-size: 0.8rem;
      line-height: 1.4;
      font-weight: 700;
    }

    .zodiac-explain {
      display: grid;
      gap: 8px;
    }

    .zodiac-explain-item {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 9px 10px;
      background: rgba(255, 255, 255, 0.64);
      display: grid;
      gap: 4px;
    }

    .zodiac-explain-head {
      margin: 0;
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #676274;
      font-weight: 800;
    }

    .zodiac-explain-value {
      margin: 0;
      color: #232c3a;
      font-weight: 800;
      font-size: 0.9rem;
      line-height: 1.35;
    }

    .zodiac-explain-text {
      margin: 0;
      color: #3b4760;
      font-size: 0.84rem;
      line-height: 1.45;
    }

    .hd-visual-card {
      gap: 12px;
    }

    .hd-visual-grid {
      display: grid;
      grid-template-columns: 1.15fr 1fr;
      gap: 12px;
    }

    .hd-visual-panel {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.68);
      display: grid;
      gap: 8px;
    }

    .hd-visual-panel h4 {
      margin: 0;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #5e6073;
      font-weight: 800;
    }

    .hd-bodygraph-wrap {
      border: 1px solid rgba(89, 51, 77, 0.2);
      border-radius: 12px;
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.9), rgba(248, 239, 227, 0.75));
      padding: 8px;
      min-height: 320px;
      display: grid;
      place-items: center;
    }

    .hd-bodygraph-svg {
      width: 100%;
      max-width: 360px;
      height: auto;
    }

    .hd-bars {
      display: grid;
      gap: 8px;
    }

    .hd-bar-item {
      display: grid;
      gap: 4px;
    }

    .hd-bar-head {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.8rem;
      color: #343f56;
      font-weight: 700;
    }

    .hd-bar-track {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(89, 51, 77, 0.14);
      overflow: hidden;
    }

    .hd-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(120deg, #1f9c93, #d8a24d);
      width: 0%;
    }

    .hd-gate-columns {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .mini-label {
      margin: 0 0 4px;
      font-size: 0.66rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #696379;
      font-weight: 800;
    }

    .hd-gate-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .hd-gate-chip {
      border-radius: 999px;
      border: 1px solid rgba(89, 51, 77, 0.22);
      background: rgba(89, 51, 77, 0.08);
      color: #3b3048;
      padding: 3px 8px;
      font-size: 0.75rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .hd-feature-card {
      gap: 12px;
    }

    .hd-feature-frame {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.7);
      padding: 10px;
      display: grid;
      justify-items: center;
    }

    .hd-feature-stage {
      position: relative;
      width: min(100%, 460px);
      aspect-ratio: 556 / 928;
      border: 1px solid rgba(89, 51, 77, 0.22);
      border-radius: 10px;
      background-image: url("/human-design-bodychart-556x928.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow: hidden;
    }

    .hd-feature-stage svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .hd-feature-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .hd-feature-legend-chip {
      border-radius: 999px;
      border: 1px solid rgba(89, 51, 77, 0.22);
      background: rgba(255, 255, 255, 0.65);
      color: #332d44;
      padding: 4px 9px;
      font-size: 0.78rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .hd-feature-legend-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      display: inline-block;
      box-shadow: 0 0 0 1px rgba(20, 20, 30, 0.12);
    }

    .hd-feature-explain {
      display: grid;
      gap: 8px;
    }

    .hd-feature-explain-item {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 9px 10px;
      background: rgba(255, 255, 255, 0.66);
      display: grid;
      gap: 4px;
    }

    .hd-feature-explain-item h4 {
      margin: 0;
      font-size: 0.71rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #5f6071;
      font-weight: 800;
    }

    .hd-feature-explain-item p {
      margin: 0;
      font-size: 0.86rem;
      line-height: 1.5;
      color: #2f3950;
    }

    .tag-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag {
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(89, 51, 77, 0.06);
      color: #3c3148;
      padding: 6px 10px;
      font-size: 0.81rem;
      font-weight: 700;
    }

    .muted {
      margin: 0;
      color: #5b6272;
      line-height: 1.55;
      font-size: 0.92rem;
    }

    .deep-stack {
      display: grid;
      gap: 8px;
    }

    .deep-block {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 11px;
      background: rgba(255, 255, 255, 0.62);
      display: grid;
      gap: 5px;
    }

    .deep-block h4 {
      margin: 0;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #5f6071;
      font-weight: 800;
    }

    .deep-block p {
      margin: 0;
      color: #2f3950;
      font-size: 0.9rem;
      line-height: 1.52;
    }

    .deep-list {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 5px;
    }

    .deep-list li {
      color: #303a4f;
      font-size: 0.88rem;
      line-height: 1.45;
    }

    .synthesis-list {
      margin: 0;
      padding-left: 20px;
      display: grid;
      gap: 8px;
    }

    .synthesis-list li {
      line-height: 1.55;
      color: #2e374a;
      font-size: 0.94rem;
    }

    .life-summary-card {
      gap: 12px;
    }

    .life-summary-lead {
      margin: 0;
      color: #5a6273;
      font-size: 0.94rem;
      line-height: 1.55;
      font-weight: 600;
    }

    .life-summary-body {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px 15px;
      background: rgba(255, 255, 255, 0.66);
      display: grid;
      gap: 10px;
      min-height: 520px;
    }

    .life-summary-body p {
      margin: 0;
      color: #2f3850;
      font-size: 0.95rem;
      line-height: 1.72;
      text-wrap: pretty;
    }

    .term-pill {
      display: inline;
      padding: 0.03em 0.26em;
      border-radius: 0.42em;
      font-weight: 800;
      letter-spacing: 0.01em;
      border: 1px solid transparent;
      box-decoration-break: clone;
      -webkit-box-decoration-break: clone;
    }

    .term-astro {
      color: #1f3558;
      background: rgba(120, 185, 255, 0.24);
      border-color: rgba(83, 139, 206, 0.36);
    }

    .term-hd {
      color: #4d2f57;
      background: rgba(205, 144, 255, 0.2);
      border-color: rgba(144, 92, 184, 0.34);
    }

    .term-zodiac {
      color: #224a3d;
      background: rgba(120, 224, 183, 0.22);
      border-color: rgba(68, 154, 122, 0.34);
    }

    .report-footer {
      text-align: center;
      color: #6b7180;
      font-size: 0.84rem;
      margin-top: 6px;
      position: relative;
      z-index: 1;
    }

    .empty {
      color: #6b7180;
      font-size: 0.9rem;
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.55);
    }

    @media screen {
      :root {
        --ink: #efe7d8;
        --ink-soft: #c8bda8;
        --paper: #18131f;
        --paper-soft: #21182a;
        --line: rgba(255, 245, 224, 0.14);
        --gold: #ffb347;
        --gold-deep: #db4a2b;
        --teal: #2b7a78;
        --plum: #83689c;
        --shadow: 0 30px 80px rgba(2, 2, 8, 0.58);
      }

      body {
        background:
          radial-gradient(1100px 560px at 8% -14%, rgba(255, 179, 71, 0.2), transparent 64%),
          radial-gradient(860px 520px at 96% 0%, rgba(43, 122, 120, 0.2), transparent 68%),
          linear-gradient(166deg, #08090f 0%, #15111d 58%, #0d0d16 100%);
      }

      .sheet {
        background:
          radial-gradient(400px 220px at 92% 8%, rgba(255, 179, 71, 0.12), transparent 74%),
          radial-gradient(340px 220px at 4% 90%, rgba(43, 122, 120, 0.14), transparent 74%),
          linear-gradient(150deg, rgba(27, 22, 36, 0.94), rgba(17, 14, 24, 0.96));
        border-color: rgba(255, 255, 255, 0.14);
      }

      .sheet::before {
        background: radial-gradient(circle, rgba(255, 179, 71, 0.24), transparent 70%);
      }

      .sheet::after {
        background: radial-gradient(circle, rgba(43, 122, 120, 0.24), transparent 72%);
      }

      .cover {
        background:
          radial-gradient(1100px 520px at -10% -22%, rgba(255, 179, 71, 0.28), transparent 68%),
          radial-gradient(900px 420px at 112% 4%, rgba(43, 122, 120, 0.24), transparent 72%),
          linear-gradient(150deg, rgba(30, 24, 41, 0.95) 0%, rgba(18, 15, 26, 0.96) 58%, rgba(11, 11, 18, 0.98) 100%);
      }

      .cover-topline {
        color: #ffd9a2;
      }

      .cover-title,
      .gift-line,
      .sheet-title {
        color: #fff2df;
      }

      .cover-subtitle,
      .sheet-kicker,
      .life-summary-lead,
      .muted,
      .report-footer {
        color: var(--ink-soft);
      }

      .cover-avatar-wrap {
        background: linear-gradient(155deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.05));
        border-color: rgba(255, 255, 255, 0.24);
        box-shadow: 0 16px 28px rgba(1, 2, 6, 0.38);
      }

      .cover-avatar {
        border-color: rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.25);
      }

      .chip,
      .quote,
      .triad-card,
      .narrative-box,
      .planet-card,
      .card,
      .guide-block,
      .deep-block,
      .life-areas-card,
      .table-wrap,
      .kv-item,
      .zodiac-hero,
      .zodiac-emblem,
      .zodiac-explain-item,
      .hd-visual-panel,
      .hd-feature-frame,
      .hd-feature-explain-item,
      .life-summary-body,
      .table-scroll,
      .empty {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.09), rgba(255, 255, 255, 0.03));
        border-color: rgba(255, 255, 255, 0.17);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }

      .sheet-head {
        border-bottom-color: rgba(255, 255, 255, 0.13);
      }

      .eyebrow,
      .card h3,
      .card h4,
      .triad-label,
      .chip label,
      .kv-item label,
      .mini-label,
      .zodiac-explain-head,
      .planet-meta,
      .deep-block h4,
      .hd-visual-panel h4,
      .hd-feature-explain-item h4 {
        color: #d7c8b0;
      }

      .chip span,
      .triad-value,
      .planet-name,
      .kv-item span,
      .zodiac-animal,
      .zodiac-explain-value,
      .zodiac-char-large {
        color: #fff1de;
      }

      .quote {
        border-left-color: #ffb347;
        color: #f2e4d2;
      }

      .triad-note,
      .planet-text,
      .life-areas-card p,
      .zodiac-style,
      .zodiac-meta,
      .zodiac-explain-text,
      .guide-copy p,
      .narrative-box,
      .deep-block p,
      .deep-list li,
      .synthesis-list li,
      .life-summary-body p {
        color: #ddd0bf;
      }

      .planet-symbol {
        border-color: rgba(255, 255, 255, 0.24);
        background: rgba(255, 255, 255, 0.1);
      }

      .tag,
      .hd-gate-chip,
      .hd-feature-legend-chip {
        color: #efe1ce;
        border-color: rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.1);
      }

      .hd-bodygraph-wrap {
        border-color: rgba(255, 255, 255, 0.2);
        background: linear-gradient(160deg, rgba(18, 16, 27, 0.92), rgba(12, 11, 18, 0.9));
      }

      .natal-wheel-stage {
        border-color: rgba(255, 255, 255, 0.2);
        background: linear-gradient(160deg, rgba(18, 16, 27, 0.92), rgba(12, 11, 18, 0.9));
      }

      .hd-feature-stage {
        border-color: rgba(255, 255, 255, 0.24);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.07);
      }

      .hd-bar-head {
        color: #e8dccb;
      }

      .hd-bar-track {
        background: rgba(255, 255, 255, 0.14);
      }

      .hd-bar-fill {
        background: linear-gradient(120deg, #2b7a78, #ffb347);
      }

      .table-scroll {
        background: rgba(5, 6, 10, 0.5);
      }

      .data-table {
        color: #eadfce;
      }

      .data-table th {
        background: rgba(255, 255, 255, 0.1);
        color: #f3e7d6;
      }

      .data-table th,
      .data-table td {
        border-bottom-color: rgba(255, 255, 255, 0.13);
      }

      .btn.primary {
        background: linear-gradient(120deg, #db4a2b, #ff7b56);
        box-shadow: 0 10px 24px rgba(219, 74, 43, 0.3);
      }

      .btn.ghost {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #efe3d0;
      }

      .sheet-core {
        background:
          radial-gradient(420px 240px at 8% 4%, rgba(95, 179, 255, 0.2), transparent 72%),
          radial-gradient(360px 220px at 94% 90%, rgba(255, 184, 109, 0.18), transparent 74%),
          linear-gradient(150deg, rgba(18, 20, 34, 0.97), rgba(12, 13, 22, 0.98));
        border-color: rgba(124, 184, 255, 0.32);
      }

      .sheet-core .triad-card,
      .sheet-core .narrative-box {
        background: linear-gradient(150deg, rgba(14, 18, 30, 0.9), rgba(30, 22, 42, 0.82));
        border-color: rgba(122, 189, 255, 0.34);
      }

      .sheet-core .triad-card:nth-child(1) {
        border-left: 3px solid rgba(255, 182, 101, 0.9);
      }

      .sheet-core .triad-card:nth-child(2) {
        border-left: 3px solid rgba(120, 196, 255, 0.9);
      }

      .sheet-core .triad-card:nth-child(3) {
        border-left: 3px solid rgba(123, 224, 183, 0.9);
      }

      .sheet-core .narrative-box {
        border-left: 4px solid rgba(122, 189, 255, 0.82);
      }

      .sheet-planets {
        background:
          radial-gradient(440px 240px at 12% -8%, rgba(133, 118, 255, 0.24), transparent 72%),
          radial-gradient(400px 230px at 92% 92%, rgba(106, 201, 255, 0.2), transparent 74%),
          linear-gradient(150deg, rgba(24, 18, 34, 0.97), rgba(11, 11, 22, 0.98));
        border-color: rgba(140, 157, 255, 0.34);
      }

      .sheet-planets .natal-wheel-card {
        border-left: 4px solid rgba(130, 206, 255, 0.9);
        background: linear-gradient(150deg, rgba(22, 22, 40, 0.94), rgba(12, 14, 29, 0.93));
      }

      .sheet-planets .card:not(.natal-wheel-card) {
        border-left: 4px solid rgba(110, 191, 255, 0.8);
        background: linear-gradient(150deg, rgba(19, 24, 36, 0.9), rgba(17, 13, 28, 0.9));
      }

      .sheet-planets #planet-grid .planet-card:nth-child(odd) {
        background: linear-gradient(145deg, rgba(29, 24, 48, 0.72), rgba(17, 15, 34, 0.82));
        border-color: rgba(150, 168, 255, 0.44);
        border-left: 3px solid rgba(150, 168, 255, 0.86);
      }

      .sheet-planets #planet-grid .planet-card:nth-child(even) {
        background: linear-gradient(145deg, rgba(16, 31, 47, 0.74), rgba(19, 17, 36, 0.82));
        border-color: rgba(109, 208, 255, 0.42);
        border-left: 3px solid rgba(109, 208, 255, 0.84);
      }

      .sheet-planets .natal-wheel-stage {
        border-color: rgba(132, 187, 255, 0.52);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      }

      .sheet-integration {
        background:
          radial-gradient(460px 240px at 8% 0%, rgba(100, 199, 190, 0.2), transparent 72%),
          radial-gradient(400px 260px at 94% 100%, rgba(255, 156, 112, 0.16), transparent 74%),
          linear-gradient(150deg, rgba(19, 17, 30, 0.97), rgba(12, 11, 21, 0.98));
        border-color: rgba(129, 197, 195, 0.32);
      }

      .sheet-integration .card {
        background: linear-gradient(150deg, rgba(17, 19, 33, 0.9), rgba(25, 20, 36, 0.86));
        border-color: rgba(134, 196, 210, 0.3);
      }

      .sheet-integration .report-guide-card {
        border-left: 4px solid rgba(255, 189, 106, 0.86);
      }

      .sheet-integration .hd-signature-card {
        border-left: 4px solid rgba(126, 196, 255, 0.86);
      }

      .sheet-integration .zodiac-signature-card {
        border-left: 4px solid rgba(132, 220, 157, 0.86);
      }

      .sheet-integration .hd-feature-card {
        border-left: 4px solid rgba(255, 164, 124, 0.86);
      }

      .sheet-integration .hd-visual-card {
        border-left: 4px solid rgba(118, 215, 210, 0.86);
      }

      .sheet-integration .synthesis-card {
        border-left: 4px solid rgba(255, 210, 122, 0.86);
      }

      .sheet-integration .life-areas-main-card {
        border-left: 4px solid rgba(255, 165, 113, 0.86);
      }

      .sheet-integration .hd-modal-card {
        border-left: 4px solid rgba(157, 187, 255, 0.86);
      }

      .sheet-integration .report-tables-card {
        border-left: 4px solid rgba(126, 225, 215, 0.86);
      }

      .sheet-integration .life-summary-card {
        border-left: 4px solid rgba(255, 187, 120, 0.86);
      }

      .sheet-integration .guide-block,
      .sheet-integration .life-areas-card,
      .sheet-integration .deep-block,
      .sheet-integration .kv-item,
      .sheet-integration .zodiac-explain-item,
      .sheet-integration .hd-visual-panel,
      .sheet-integration .table-wrap,
      .sheet-integration .life-summary-body,
      .sheet-integration .zodiac-hero,
      .sheet-integration .zodiac-emblem {
        background: linear-gradient(150deg, rgba(12, 15, 26, 0.9), rgba(24, 20, 35, 0.9));
        border-color: rgba(137, 197, 216, 0.36);
      }

      .sheet-integration .hd-feature-explain {
        gap: 10px;
      }

      .sheet-integration .hd-feature-explain-item {
        background: linear-gradient(152deg, rgba(44, 53, 86, 0.78), rgba(27, 33, 58, 0.88));
        border-color: rgba(162, 203, 255, 0.48);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.12),
          0 8px 16px rgba(3, 6, 16, 0.24);
      }

      .sheet-integration .hd-feature-explain-item h4 {
        color: #ffe1b7;
        font-size: 0.86rem;
        letter-spacing: 0.12em;
      }

      .sheet-integration .hd-feature-explain-item p {
        color: #f6f0e4;
        font-size: 1rem;
        line-height: 1.64;
        font-weight: 500;
      }

      .sheet-integration .table-scroll {
        background: rgba(7, 9, 14, 0.74);
        border-color: rgba(138, 201, 220, 0.3);
      }

      .sheet-integration .data-table th {
        background: rgba(124, 160, 201, 0.22);
      }

      .sheet-integration .card h3,
      .sheet-integration .card h4,
      .sheet-integration .guide-block h4,
      .sheet-integration .life-areas-card h4,
      .sheet-integration .kv-item label,
      .sheet-integration .zodiac-explain-head {
        color: #ffd9a8;
      }

      .sheet-integration .muted,
      .sheet-integration .guide-copy p,
      .sheet-integration .life-areas-card p,
      .sheet-integration .deep-block p,
      .sheet-integration .deep-list li,
      .sheet-integration .synthesis-list li,
      .sheet-integration .zodiac-style,
      .sheet-integration .zodiac-meta,
      .sheet-integration .zodiac-explain-text,
      .sheet-integration .life-summary-body p {
        color: #f0e5d7;
      }

      .sheet-integration .kv-item span,
      .sheet-integration .zodiac-animal,
      .sheet-integration .zodiac-explain-value,
      .sheet-integration .zodiac-char-large {
        color: #fff4e4;
      }

      .sheet-integration .tag,
      .sheet-integration .hd-gate-chip,
      .sheet-integration .hd-feature-legend-chip {
        background: rgba(255, 255, 255, 0.14);
        border-color: rgba(172, 216, 231, 0.36);
      }

      .empty {
        color: #cfc3b0;
      }

      .term-astro {
        color: #dff1ff;
        background: rgba(106, 193, 255, 0.22);
        border-color: rgba(106, 193, 255, 0.44);
      }

      .term-hd {
        color: #f5e5ff;
        background: rgba(194, 132, 255, 0.2);
        border-color: rgba(194, 132, 255, 0.4);
      }

      .term-zodiac {
        color: #e4ffef;
        background: rgba(111, 226, 173, 0.2);
        border-color: rgba(111, 226, 173, 0.4);
      }
    }

    @media (max-width: 980px) {
      .cover-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .triad,
      .planet-grid,
      .split,
      .hd-visual-grid,
      .hd-gate-columns,
      .guide-grid,
      .life-areas-grid {
        grid-template-columns: 1fr;
      }

      .cover-intro {
        grid-template-columns: 1fr;
      }

      .cover-avatar-wrap {
        max-width: 210px;
      }

      .sheet-kicker {
        text-align: left;
      }

      .sheet-head {
        display: grid;
      }

      .natal-wheel-stage {
        min-height: 360px;
      }
    }

    @media (max-width: 620px) {
      body {
        padding: 10px 8px 20px;
      }

      .sheet {
        border-radius: 18px;
        padding: 14px;
      }

      .cover-grid {
        grid-template-columns: 1fr;
      }

      .kv {
        grid-template-columns: 1fr;
      }

      .zodiac-hero {
        grid-template-columns: 1fr;
      }

      .zodiac-emblem {
        width: 100%;
        min-height: 120px;
      }
    }

    @page {
      size: A4;
      margin: 6mm 7mm 7mm;
    }

    @media print {
      :root {
        --ink: #efe7d8;
        --ink-soft: #c8bda8;
        --paper: #18131f;
        --paper-soft: #21182a;
        --line: rgba(255, 245, 224, 0.14);
        --gold: #ffb347;
        --gold-deep: #db4a2b;
        --teal: #2b7a78;
        --plum: #83689c;
      }

      * {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      html,
      body {
        background:
          radial-gradient(1100px 560px at 8% -14%, rgba(255, 179, 71, 0.2), transparent 64%),
          radial-gradient(860px 520px at 96% 0%, rgba(43, 122, 120, 0.2), transparent 68%),
          linear-gradient(166deg, #08090f 0%, #15111d 58%, #0d0d16 100%) !important;
      }

      body {
        padding: 8mm 6mm 9mm;
        color: var(--ink);
        font-size: 10.8pt;
      }

      .page {
        width: 100%;
        max-width: none;
        gap: 4mm;
      }

      .sheet {
        background:
          radial-gradient(400px 220px at 92% 8%, rgba(255, 179, 71, 0.12), transparent 74%),
          radial-gradient(340px 220px at 4% 90%, rgba(43, 122, 120, 0.14), transparent 74%),
          linear-gradient(150deg, rgba(27, 22, 36, 0.94), rgba(17, 14, 24, 0.96));
        border-color: rgba(255, 255, 255, 0.14);
        border-radius: 16px;
        box-shadow: none;
        margin: 0;
        padding: 14px;
        overflow: visible;
        page-break-after: auto;
        break-after: auto;
        break-inside: auto;
        page-break-inside: auto;
        display: block;
      }

      .sheet > * + * {
        margin-top: 8px;
      }

      .sheet::before {
        background: radial-gradient(circle, rgba(255, 179, 71, 0.24), transparent 70%);
        opacity: 0.72;
      }

      .sheet::after {
        background: radial-gradient(circle, rgba(43, 122, 120, 0.24), transparent 72%);
        opacity: 0.72;
      }

      .cover {
        min-height: 262mm;
        display: grid;
        align-content: start;
        gap: 10px;
        background:
          radial-gradient(1100px 520px at -10% -22%, rgba(255, 179, 71, 0.28), transparent 68%),
          radial-gradient(900px 420px at 112% 4%, rgba(43, 122, 120, 0.24), transparent 72%),
          linear-gradient(150deg, rgba(30, 24, 41, 0.95) 0%, rgba(18, 15, 26, 0.96) 58%, rgba(11, 11, 18, 0.98) 100%);
        page-break-after: always;
        break-after: page;
      }

      .cover-topline {
        color: #ffd9a2;
      }

      .cover-title,
      .gift-line,
      .sheet-title {
        color: #fff2df;
      }

      .cover-subtitle,
      .sheet-kicker,
      .life-summary-lead,
      .muted,
      .report-footer {
        color: var(--ink-soft);
      }

      .cover-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
      }

      .cover-intro {
        grid-template-columns: 1fr 108px;
        gap: 9px;
      }

      .cover-avatar-wrap {
        background: linear-gradient(155deg, rgba(255, 255, 255, 0.12), rgba(255, 255, 255, 0.05));
        border-color: rgba(255, 255, 255, 0.24);
        box-shadow: none;
        padding: 5px;
      }

      .cover-avatar {
        border-color: rgba(255, 255, 255, 0.2);
        background: rgba(0, 0, 0, 0.25);
      }

      .cover-avatar-caption {
        display: none;
      }

      .cover-natal-mini {
        display: grid;
        gap: 6px;
        margin-top: 6px;
        max-width: 338px;
        break-inside: avoid-page;
        page-break-inside: avoid;
      }

      .cover-natal-mini h3 {
        color: #d7c8b0;
      }

      .cover-natal-wheel-stage {
        border-color: rgba(255, 255, 255, 0.24);
        background: linear-gradient(160deg, rgba(18, 16, 27, 0.92), rgba(12, 11, 18, 0.9));
        min-height: 240px;
        max-width: 320px;
      }

      .cover-natal-wheel-note {
        color: #bcae98;
      }

      .chip,
      .quote,
      .triad-card,
      .narrative-box,
      .planet-card,
      .card,
      .guide-block,
      .deep-block,
      .life-areas-card,
      .table-wrap,
      .kv-item,
      .zodiac-hero,
      .zodiac-emblem,
      .zodiac-explain-item,
      .hd-visual-panel,
      .hd-feature-frame,
      .hd-feature-explain-item,
      .life-summary-body,
      .table-scroll,
      .empty {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.09), rgba(255, 255, 255, 0.03));
        border-color: rgba(255, 255, 255, 0.17);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }

      .sheet-head {
        border-bottom-color: rgba(255, 255, 255, 0.13);
        margin-bottom: 4px;
      }

      .eyebrow,
      .card h3,
      .card h4,
      .triad-label,
      .chip label,
      .kv-item label,
      .mini-label,
      .zodiac-explain-head,
      .planet-meta,
      .deep-block h4,
      .hd-visual-panel h4,
      .hd-feature-explain-item h4 {
        color: #d7c8b0;
      }

      .chip span,
      .triad-value,
      .planet-name,
      .kv-item span,
      .zodiac-animal,
      .zodiac-explain-value,
      .zodiac-char-large {
        color: #fff1de;
      }

      .triad-note,
      .planet-text,
      .life-areas-card p,
      .zodiac-style,
      .zodiac-meta,
      .zodiac-explain-text,
      .guide-copy p,
      .narrative-box,
      .deep-block p,
      .deep-list li,
      .synthesis-list li,
      .life-summary-body p {
        color: #ddd0bf;
      }

      .quote {
        border-left-color: #ffb347;
        color: #f2e4d2;
      }

      .term-astro {
        color: #dff1ff;
        background: rgba(106, 193, 255, 0.22);
        border-color: rgba(106, 193, 255, 0.44);
      }

      .term-hd {
        color: #f5e5ff;
        background: rgba(194, 132, 255, 0.2);
        border-color: rgba(194, 132, 255, 0.4);
      }

      .term-zodiac {
        color: #e4ffef;
        background: rgba(111, 226, 173, 0.2);
        border-color: rgba(111, 226, 173, 0.4);
      }

      .planet-symbol {
        border-color: rgba(255, 255, 255, 0.24);
        background: rgba(255, 255, 255, 0.1);
      }

      .tag,
      .hd-gate-chip,
      .hd-feature-legend-chip {
        color: #efe1ce;
        border-color: rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.1);
      }

      .hd-bodygraph-wrap,
      .natal-wheel-stage {
        border-color: rgba(255, 255, 255, 0.2);
        background: linear-gradient(160deg, rgba(18, 16, 27, 0.92), rgba(12, 11, 18, 0.9));
        min-height: 320px;
      }

      .hd-feature-stage {
        border-color: rgba(255, 255, 255, 0.24);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.07);
      }

      .hd-bar-head {
        color: #e8dccb;
      }

      .hd-bar-track {
        background: rgba(255, 255, 255, 0.14);
      }

      .hd-bar-fill {
        background: linear-gradient(120deg, #2b7a78, #ffb347);
      }

      .planet-grid {
        display: block;
      }

      .planet-grid .planet-card {
        min-height: 0;
        margin-bottom: 8px;
        break-inside: avoid-page;
        page-break-inside: avoid;
      }

      .planet-grid .planet-card:last-child {
        margin-bottom: 0;
      }

      .sheet-planets > .card:not(.natal-wheel-card) {
        break-inside: avoid-page;
        page-break-inside: avoid;
      }

      .sheet-planets .natal-wheel-card {
        display: none !important;
      }

      #planet-aspects-card {
        break-before: page;
        page-break-before: always;
        break-inside: avoid-page;
        page-break-inside: avoid;
      }

      .guide-grid,
      .life-areas-grid,
      .tables-grid {
        display: block;
      }

      .guide-grid > *,
      .life-areas-grid > *,
      .tables-grid > * {
        margin-bottom: 8px;
      }

      .guide-grid > *:last-child,
      .life-areas-grid > *:last-child,
      .tables-grid > *:last-child {
        margin-bottom: 0;
      }

      .hd-visual-grid {
        display: block;
      }

      .split {
        display: block;
      }

      .split > .card {
        margin-bottom: 8px;
      }

      .split > .card:last-child {
        margin-bottom: 0;
      }

      .zodiac-signature-card {
        break-before: page;
        page-break-before: always;
        break-inside: avoid-page;
        page-break-inside: avoid;
      }

      .hd-feature-card {
        break-before: page;
        page-break-before: always;
        break-inside: avoid-page;
        page-break-inside: avoid;
      }

      .hd-visual-card {
        break-before: page;
        page-break-before: always;
      }

      .hd-feature-stage {
        width: min(100%, 390px);
      }

      .hd-visual-panel {
        margin-bottom: 8px;
        break-inside: avoid-page;
        page-break-inside: avoid;
      }

      .hd-visual-panel:last-child {
        margin-bottom: 0;
      }

      .table-scroll {
        background: rgba(5, 6, 10, 0.5);
        overflow: visible !important;
      }

      .report-guide-card,
      .synthesis-card,
      .life-areas-main-card {
        break-inside: avoid-page;
        page-break-inside: avoid;
      }

      .life-summary-card {
        break-before: page;
        page-break-before: always;
        break-inside: avoid-page;
        page-break-inside: avoid;
      }

      .data-table {
        color: #eadfce;
        min-width: 0;
        width: 100%;
        table-layout: auto;
      }

      .data-table thead {
        display: table-header-group;
      }

      .data-table tr {
        break-inside: avoid;
        page-break-inside: avoid;
      }

      .data-table th {
        background: rgba(255, 255, 255, 0.1);
        color: #f3e7d6;
        position: static;
      }

      .data-table th,
      .data-table td {
        border-bottom-color: rgba(255, 255, 255, 0.13);
        overflow-wrap: break-word;
      }

      .actions {
        display: none !important;
      }

      .triad-card,
      .planet-card,
      .life-areas-card,
      .kv-item,
      .narrative-box,
      .zodiac-explain-item,
      .hd-feature-explain-item {
        break-inside: avoid-page;
        page-break-inside: avoid;
      }

      .guide-block,
      .table-wrap,
      .deep-block,
      .life-summary-body,
      .hd-feature-frame {
        break-inside: auto;
        page-break-inside: auto;
      }

      .life-summary-body,
      .hd-feature-frame {
        break-inside: auto;
        page-break-inside: auto;
        min-height: 0;
      }

      .report-footer {
        font-size: 0.75rem;
        margin-top: 4px;
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <section class="sheet cover">
      <div class="cover-intro">
        <div class="cover-copy">
          <p class="cover-topline" id="cover-brand">Genererad av Sputnet</p>
          <h1 class="cover-title" id="cover-title">Natalanalysrapport</h1>
          <p class="cover-subtitle" id="cover-subtitle"></p>
          <p class="gift-line" id="cover-gift-line"></p>
        </div>
        <figure class="cover-avatar-wrap" id="cover-avatar-wrap">
          <img
            id="cover-avatar"
            class="cover-avatar"
            src="/avatars/Default.jpg"
            alt="Profilavatar"
            loading="lazy"
          />
        </figure>
      </div>

      <div class="cover-grid">
        <div class="chip">
          <label id="chip-label-name">Namn</label>
          <span id="chip-name">-</span>
        </div>
        <div class="chip">
          <label id="chip-label-birth">Födelsedata</label>
          <span id="chip-birth">-</span>
        </div>
        <div class="chip">
          <label id="chip-label-core">Kärnsignatur</label>
          <span id="chip-core">-</span>
        </div>
        <div class="chip">
          <label id="chip-label-created">Skapad</label>
          <span id="chip-created">-</span>
        </div>
      </div>

      <p class="quote" id="cover-quote"></p>

      <article class="cover-natal-mini" id="cover-natal-mini">
        <h3 id="cover-natal-title">Runt natalchart</h3>
        <div id="cover-natal-wheel-stage" class="cover-natal-wheel-stage"></div>
        <p class="cover-natal-wheel-note" id="cover-natal-wheel-note"></p>
      </article>

      <div class="actions">
        <button class="btn primary" type="button" id="print-btn">Skriv ut / Spara PDF</button>
        <button class="btn ghost" type="button" id="close-btn">Stäng</button>
      </div>
    </section>

    <section class="sheet sheet-core">
      <header class="sheet-head">
        <div>
          <p class="eyebrow" id="core-eyebrow">Kärna</p>
          <h2 class="sheet-title" id="core-title">Din kosmiska grundton</h2>
        </div>
        <p class="sheet-kicker" id="core-kicker"></p>
      </header>

      <div class="triad">
        <article class="triad-card">
          <p class="triad-label" id="triad-sun-label">Solen</p>
          <p class="triad-value" id="triad-sun-value">-</p>
          <p class="triad-note" id="triad-sun-note"></p>
        </article>
        <article class="triad-card">
          <p class="triad-label" id="triad-moon-label">Månen</p>
          <p class="triad-value" id="triad-moon-value">-</p>
          <p class="triad-note" id="triad-moon-note"></p>
        </article>
        <article class="triad-card">
          <p class="triad-label" id="triad-asc-label">Ascendent</p>
          <p class="triad-value" id="triad-asc-value">-</p>
          <p class="triad-note" id="triad-asc-note"></p>
        </article>
      </div>

      <article class="narrative-box" id="core-narrative"></article>
    </section>

    <section class="sheet sheet-planets">
      <header class="sheet-head">
        <div>
          <p class="eyebrow" id="planet-eyebrow">Planetberättelser</p>
          <h2 class="sheet-title" id="planet-title">Varje planet, en egen scen</h2>
        </div>
        <p class="sheet-kicker" id="planet-kicker"></p>
      </header>

      <article class="card natal-wheel-card">
        <h3 id="natal-wheel-title">Runt natalchart</h3>
        <p class="muted" id="natal-wheel-subtitle"></p>
        <div id="natal-wheel-stage" class="natal-wheel-stage"></div>
        <p class="muted" id="natal-wheel-note"></p>
      </article>

      <div class="planet-grid" id="planet-grid"></div>

      <article class="card" id="planet-aspects-card">
        <h3 id="aspect-title">Aspekter som färgar dynamiken</h3>
        <div class="tag-cloud" id="aspect-tags"></div>
      </article>
    </section>

	    <section class="sheet sheet-integration">
	      <header class="sheet-head">
	        <div>
	          <p class="eyebrow" id="integration-eyebrow">Integrering</p>
	          <h2 class="sheet-title" id="integration-title">Helhetsbild för vardag och riktning</h2>
	        </div>
	        <p class="sheet-kicker" id="integration-kicker"></p>
	      </header>

	      <article class="card report-guide-card">
	        <h3 id="report-guide-title">Så läser du rapporten</h3>
	        <div class="guide-grid">
	          <section class="guide-block">
	            <h4 id="guide-beginner-title">För dig som är ny</h4>
	            <div id="guide-beginner-body" class="guide-copy"></div>
	          </section>
	          <section class="guide-block">
	            <h4 id="guide-expert-title">För dig som är expert</h4>
	            <div id="guide-expert-body" class="guide-copy"></div>
	          </section>
	        </div>
	      </article>

	      <div class="split">
	        <article class="card hd-signature-card">
	          <h3 id="hd-title">Human Design-signatur</h3>
          <div class="kv" id="hd-kv"></div>
          <p class="muted" id="hd-note"></p>
          <div class="deep-stack" id="hd-deep"></div>
          <div class="deep-stack" id="hd-standalone"></div>
          <div class="tag-cloud" id="center-tags"></div>
          <div class="tag-cloud" id="channel-tags"></div>
        </article>

        <article class="card zodiac-signature-card">
          <h3 id="zodiac-title">Kinesisk zodiak</h3>
          <div class="zodiac-hero" id="zodiac-hero">
            <div class="zodiac-emblem">
              <span id="zodiac-icon" class="zodiac-icon-large">🐉</span>
              <span id="zodiac-char-large" class="zodiac-char-large">龍</span>
            </div>
            <div class="zodiac-hero-copy">
              <p class="zodiac-animal" id="zodiac-animal-line">Draken</p>
              <p class="zodiac-style" id="zodiac-style-line"></p>
              <p class="zodiac-meta" id="zodiac-meta-line"></p>
            </div>
          </div>
          <div class="kv" id="zodiac-kv"></div>
          <div class="zodiac-explain" id="zodiac-explain"></div>
          <p class="muted" id="zodiac-note"></p>
        </article>
      </div>

      <article class="card hd-feature-card">
        <h3 id="hd-feature-title">Human Design-chart · Full karta</h3>
        <p class="muted" id="hd-feature-subtitle"></p>
        <div class="hd-feature-frame">
          <div class="hd-feature-stage">
            <svg
              id="hd-feature-bodygraph"
              viewBox="0 0 556 928"
              preserveAspectRatio="xMidYMid meet"
              aria-label="Human Design full bodygraph"
            ></svg>
          </div>
        </div>
        <div class="hd-feature-legend" id="hd-feature-legend"></div>
      </article>

      <article class="card hd-visual-card">
        <h3 id="hd-visual-title">Human Design · Grafisk översikt</h3>
        <div class="hd-visual-grid">
          <section class="hd-visual-panel">
            <h4 id="hd-bodygraph-title">Center och kanaler</h4>
            <div class="hd-bodygraph-wrap">
              <svg
                id="hd-super-bodygraph"
                class="hd-bodygraph-svg"
                viewBox="0 0 360 520"
                preserveAspectRatio="xMidYMid meet"
                aria-label="Human Design bodygraph"
              ></svg>
            </div>
            <p class="muted" id="hd-bodygraph-note"></p>
          </section>
          <section class="hd-visual-panel">
            <h4 id="hd-bars-title">Energiindex</h4>
            <div class="hd-bars" id="hd-bars"></div>
            <h4 id="hd-gates-title">Gate-översikt</h4>
            <div class="hd-gate-columns">
              <div>
                <p class="mini-label" id="hd-gates-personality-label">Personlighet</p>
                <div class="hd-gate-list" id="hd-gates-personality"></div>
              </div>
              <div>
                <p class="mini-label" id="hd-gates-design-label">Design</p>
                <div class="hd-gate-list" id="hd-gates-design"></div>
              </div>
            </div>
          </section>
        </div>
      </article>

	      <article class="card synthesis-card">
	        <h3 id="synthesis-title">Praktisk vägledning</h3>
	        <ol class="synthesis-list" id="synthesis-list"></ol>
	      </article>

	      <article class="card life-areas-main-card">
	        <h3 id="life-areas-title">Beslut, relationer, arbete, hälsa</h3>
	        <div class="life-areas-grid">
	          <section class="life-areas-card">
	            <h4 id="life-area-decision-title">Beslutstips</h4>
	            <p id="life-area-decision">—</p>
	          </section>
	          <section class="life-areas-card">
	            <h4 id="life-area-relationships-title">Relationer</h4>
	            <p id="life-area-relationships">—</p>
	          </section>
	          <section class="life-areas-card">
	            <h4 id="life-area-work-title">Arbete</h4>
	            <p id="life-area-work">—</p>
	          </section>
	          <section class="life-areas-card">
	            <h4 id="life-area-health-title">Hälsa</h4>
	            <p id="life-area-health">—</p>
	          </section>
	        </div>
	      </article>

	      <article class="card hd-modal-card">
	        <h3 id="hd-modal-full-title">Human Design · Komplett modalinnehåll</h3>
	        <p class="muted" id="hd-modal-full-note"></p>

	        <section class="guide-block">
	          <h4 id="hd-modal-essence-title">Essens</h4>
	          <p class="muted" id="hd-modal-essence">—</p>
	        </section>

	        <div class="guide-grid">
	          <section class="guide-block">
	            <h4 id="hd-modal-core-title">Typ, strategi, auktoritet, profil, inkarnationskors</h4>
	            <div class="kv" id="hd-modal-core-kv"></div>
	          </section>
	          <section class="guide-block">
	            <h4 id="hd-modal-report-for-title">Rapport för</h4>
	            <ul class="deep-list" id="hd-modal-report-for-list"></ul>
	          </section>
	        </div>

	        <div class="guide-grid">
	          <section class="guide-block">
	            <h4 id="hd-modal-defined-title">Definierade center</h4>
	            <ul class="deep-list" id="hd-modal-defined-list"></ul>
	          </section>
	          <section class="guide-block">
	            <h4 id="hd-modal-undefined-title">Odefinierade center</h4>
	            <ul class="deep-list" id="hd-modal-undefined-list"></ul>
	          </section>
	        </div>

	        <div class="guide-grid">
	          <section class="guide-block">
	            <h4 id="hd-modal-channels-title">Definierade kanaler</h4>
	            <ul class="deep-list" id="hd-modal-channels-list"></ul>
	          </section>
	          <section class="guide-block">
	            <h4 id="hd-modal-gates-personality-title">Personlighet-gates</h4>
	            <ul class="deep-list" id="hd-modal-gates-personality-list"></ul>
	          </section>
	        </div>

	        <section class="guide-block">
	          <h4 id="hd-modal-gates-design-title">Design-gates</h4>
	          <ul class="deep-list" id="hd-modal-gates-design-list"></ul>
	        </section>
	      </article>

	      <article class="card report-tables-card">
	        <h3 id="report-tables-title">Charts och tabeller</h3>
        <div class="tables-grid">
          <section class="table-wrap">
            <h4 id="table-planets-title">Astrologi · Planetplaceringar</h4>
            <div class="table-scroll" id="table-planets"></div>
          </section>
          <section class="table-wrap">
            <h4 id="table-aspects-title">Astrologi · Aspekter</h4>
            <div class="table-scroll" id="table-aspects"></div>
          </section>
          <section class="table-wrap">
            <h4 id="table-houses-title">Astrologi · Hus</h4>
            <div class="table-scroll" id="table-houses"></div>
          </section>
          <section class="table-wrap">
            <h4 id="table-centers-title">Human Design · Center</h4>
            <div class="table-scroll" id="table-centers"></div>
          </section>
          <section class="table-wrap">
            <h4 id="table-channels-title">Human Design · Kanaler</h4>
            <div class="table-scroll" id="table-channels"></div>
          </section>
          <section class="table-wrap">
            <h4 id="table-gates-title">Human Design · Gates</h4>
            <div class="table-scroll" id="table-gates"></div>
          </section>
          <section class="table-wrap">
            <h4 id="table-zodiac-title">Kinesisk zodiak · Översikt</h4>
            <div class="table-scroll" id="table-zodiac"></div>
          </section>
        </div>
      </article>

      <article class="card life-summary-card">
        <h3 id="life-summary-title">Möjlig livsresa</h3>
        <p class="life-summary-lead" id="life-summary-lead"></p>
        <div class="life-summary-body" id="life-summary-body"></div>
      </article>

      <div class="report-footer" id="footer-line"></div>
    </section>
  </main>

  <script src="vendor/astrochart.js"></script>
  <script>
    const fallbackData = {
      locale: "sv-SE",
      generatedAt: new Date().toISOString(),
      user: {
        name: "Sputnet User",
        username: "user",
        avatarUrl: "/avatars/Default.jpg",
        avatarCandidates: ["/avatars/Default.jpg"],
        birthDate: null,
        birthTime: null,
        birthPlace: null,
      },
      astrology: {
        sun: null,
        moon: null,
        ascendant: null,
        planets: [],
        aspects: [],
      },
      humanDesign: {
        type: null,
        strategy: null,
        authority: null,
        profile: null,
        role: null,
        definition: null,
        notSelf: null,
        signature: null,
        incarnationCross: null,
        channels: [],
        definedCenters: [],
      },
      humanDesignStandalone: null,
      chineseZodiac: {
        animal: null,
        yinYang: null,
        element: null,
        trine: null,
        earthlyBranch: null,
        animalChar: null,
      },
    };

    const PLANET_SYMBOL = {
      Sun: "☉",
      Moon: "☾",
      Mercury: "☿",
      Venus: "♀",
      Mars: "♂",
      Jupiter: "♃",
      Saturn: "♄",
      Uranus: "♅",
      Neptune: "♆",
      Pluto: "♇",
      "North Node": "☊",
      Lilith: "⚸",
      Chiron: "⚷",
    };

    const SIGN_SV = {
      Aries: "Väduren",
      Taurus: "Oxen",
      Gemini: "Tvillingarna",
      Cancer: "Kräftan",
      Leo: "Lejonet",
      Virgo: "Jungfrun",
      Libra: "Vågen",
      Scorpio: "Skorpionen",
      Sagittarius: "Skytten",
      Capricorn: "Stenbocken",
      Aquarius: "Vattumannen",
      Pisces: "Fiskarna",
    };

    const PLANET_SV = {
      Sun: "Solen",
      Moon: "Månen",
      Mercury: "Merkurius",
      Venus: "Venus",
      Mars: "Mars",
      Jupiter: "Jupiter",
      Saturn: "Saturnus",
      Uranus: "Uranus",
      Neptune: "Neptunus",
      Pluto: "Pluto",
      "North Node": "Norra noden",
      Lilith: "Lilith",
      Chiron: "Chiron",
    };

    const SIGN_TONE_SV = {
      Aries: "gå rakt på och väcka rörelse",
      Taurus: "bygga trygg takt och hållbar form",
      Gemini: "leka med språk och perspektiv",
      Cancer: "skydda det mjuka och viktiga",
      Leo: "synas med hjärta och värme",
      Virgo: "förfina detaljer till tydlig kvalitet",
      Libra: "balansera relationer med takt och känsla",
      Scorpio: "gå till djupet utan att väja",
      Sagittarius: "söka frihet, mening och nya horisonter",
      Capricorn: "steg för steg skapa något långsiktigt",
      Aquarius: "tänka nytt och visa alternativa vägar",
      Pisces: "lyssna in det subtila och ge plats för fantasi",
    };

    const SIGN_NOTE_EN = {
      Aries: "bold, direct, and pioneering",
      Taurus: "grounded, calm, and steady",
      Gemini: "curious, flexible, and expressive",
      Cancer: "protective, sensitive, and caring",
      Leo: "radiant, warm, and creative",
      Virgo: "precise, thoughtful, and practical",
      Libra: "relational, fair, and diplomatic",
      Scorpio: "intense, private, and transformative",
      Sagittarius: "adventurous, open, and future-facing",
      Capricorn: "disciplined, patient, and resilient",
      Aquarius: "independent, original, and visionary",
      Pisces: "intuitive, empathic, and imaginative",
    };

    const PLANET_ARCHETYPE_SV = {
      Sun: "Solen visar din livseld och den roll du växer in i.",
      Moon: "Månen visar ditt känslohav och vad som ger inre trygghet.",
      Mercury: "Merkurius visar hur du tänker, lär och formulerar sanning.",
      Venus: "Venus visar vad du värderar, attraherar och vill ge närhet till.",
      Mars: "Mars visar hur du agerar när något verkligen betyder något.",
      Jupiter: "Jupiter visar var du växer genom tillit, mod och mening.",
      Saturn: "Saturnus visar var du bygger ryggrad genom ansvar och tid.",
      Uranus: "Uranus visar var frihet, förnyelse och originalitet vill fram.",
      Neptune: "Neptunus visar var dröm, intuition och andlighet färgar vägen.",
      Pluto: "Pluto visar var djup förändring och återfödelse blir nödvändig.",
      "North Node": "Norra noden visar riktningen för utveckling över livstid.",
      Lilith: "Lilith visar den råa sanning du inte längre vill förminska.",
      Chiron: "Chiron visar såret som över tid blir en källa till visdom.",
    };

    const PLANET_GIFT_SV = {
      Sun: "leda med äkthet i stället för anpassning",
      Moon: "ta hand om känslor utan att tappa dig själv",
      Mercury: "skapa klarhet där andra fastnar i brus",
      Venus: "bygga relationer som känns både vackra och sanna",
      Mars: "ta modiga beslut när stunden kräver handling",
      Jupiter: "öppna möjligheter där andra ser begränsningar",
      Saturn: "förvalta ansvar utan att tappa hjärtats riktning",
      Uranus: "frigöra potential genom nya perspektiv",
      Neptune: "lyssna in subtila signaler och kreativ inspiration",
      Pluto: "transformera det gamla till en starkare kärna",
      "North Node": "välja utveckling även när den känns obekväm",
      Lilith: "stå i din kraft utan att be om ursäkt",
      Chiron: "göra erfaren smärta till läkande närvaro",
    };

    const PLANET_ARCHETYPE_EN = {
      Sun: "The Sun shows your identity fire and the role you grow into.",
      Moon: "The Moon describes emotional rhythm and your need for safety.",
      Mercury: "Mercury shows how you think, learn, and express truth.",
      Venus: "Venus describes values, attraction, and your style of love.",
      Mars: "Mars shows action, desire, and how you move forward.",
      Jupiter: "Jupiter points to growth, faith, and expanded meaning.",
      Saturn: "Saturn describes structure, discipline, and long-term mastery.",
      Uranus: "Uranus highlights change, freedom, and originality.",
      Neptune: "Neptune shows intuition, dreamlife, and subtle inspiration.",
      Pluto: "Pluto reveals deep power, release, and transformation.",
      "North Node": "The North Node points to long-term growth direction.",
      Lilith: "Lilith reveals unapologetic instinct and untamed truth.",
      Chiron: "Chiron shows the wound that can become wisdom.",
    };

    const HOUSE_THEME_SV = {
      1: "identitet, personligt uttryck och första intryck",
      2: "värderingar, resurser och självvärde",
      3: "kommunikation, lärande och vardagstempo",
      4: "hem, rötter och emotionell grund",
      5: "kreativitet, glädje och hjärtats uttryck",
      6: "arbete, hälsa och dagliga rutiner",
      7: "partnerskap och närhet",
      8: "sårbarhet, fördjupning och transformation",
      9: "mening, tro och perspektiv",
      10: "karriär, ambition och synlighet",
      11: "vänskap, nätverk och framtidsvision",
      12: "inre värld, återhämtning och andligt djup",
    };

    const HOUSE_THEME_EN = {
      1: "identity, style, and first impression",
      2: "values, resources, and self-worth",
      3: "communication, learning, and daily rhythm",
      4: "home, roots, and emotional foundation",
      5: "creativity, joy, and self-expression",
      6: "work, health, and routines",
      7: "partnerships and close bonds",
      8: "depth, vulnerability, and transformation",
      9: "meaning, belief, and perspective",
      10: "career, visibility, and long-term ambition",
      11: "community, networks, and future vision",
      12: "inner life, restoration, and spiritual depth",
    };

    const ZODIAC_STYLE_SV = {
      Rat: "råttans snabbhet och skärpa",
      Ox: "oxens uthålliga och stabila kraft",
      Tiger: "tigerns modiga, direkta eld",
      Rabbit: "kaninens mjuka diplomati",
      Dragon: "drakens stora närvaro och vision",
      Snake: "ormens strategiska intuition",
      Horse: "hästens frihetsdrivna momentum",
      Goat: "getens kreativa känslighet",
      Monkey: "apans lekfulla intelligens",
      Rooster: "tuppens precision och tydlighet",
      Dog: "hundens lojalitet och beskydd",
      Pig: "grisens värme och generositet",
    };
    const ZODIAC_STYLE_SV_KEY = {
      rat: "råttans snabbhet och skärpa",
      ox: "oxens uthålliga och stabila kraft",
      tiger: "tigerns modiga, direkta eld",
      rabbit: "kaninens mjuka diplomati",
      dragon: "drakens stora närvaro och vision",
      snake: "ormens strategiska intuition",
      horse: "hästens frihetsdrivna momentum",
      goat: "getens kreativa känslighet",
      monkey: "apans lekfulla intelligens",
      rooster: "tuppens precision och tydlighet",
      dog: "hundens lojalitet och beskydd",
      pig: "grisens värme och generositet",
    };
    const ZODIAC_ICON = {
      rat: "🐀",
      ox: "🐂",
      tiger: "🐅",
      rabbit: "🐇",
      dragon: "🐉",
      snake: "🐍",
      horse: "🐎",
      goat: "🐐",
      monkey: "🐒",
      rooster: "🐓",
      dog: "🐕",
      pig: "🐖",
    };
    const ZODIAC_CHAR = {
      rat: "鼠",
      ox: "牛",
      tiger: "虎",
      rabbit: "兔",
      dragon: "龍",
      snake: "蛇",
      horse: "馬",
      goat: "羊",
      monkey: "猴",
      rooster: "雞",
      dog: "狗",
      pig: "豬",
    };
    const ZODIAC_PINYIN = {
      rat: "shǔ",
      ox: "niú",
      tiger: "hǔ",
      rabbit: "tù",
      dragon: "lóng",
      snake: "shé",
      horse: "mǎ",
      goat: "yáng",
      monkey: "hóu",
      rooster: "jī",
      dog: "gǒu",
      pig: "zhū",
    };
    const ZODIAC_EARTHLY_BRANCH = {
      rat: "子 zǐ",
      ox: "丑 chǒu",
      tiger: "寅 yín",
      rabbit: "卯 mǎo",
      dragon: "辰 chén",
      snake: "巳 sì",
      horse: "午 wǔ",
      goat: "未 wèi",
      monkey: "申 shēn",
      rooster: "酉 yǒu",
      dog: "戌 xū",
      pig: "亥 hài",
    };
    const ZODIAC_ELEMENT_CN = {
      wood: "木 mù",
      fire: "火 huǒ",
      earth: "土 tǔ",
      metal: "金 jīn",
      water: "水 shuǐ",
    };
    const ZODIAC_YINYANG_CN = {
      yin: "陰 yīn",
      yang: "陽 yáng",
    };
    const ZODIAC_TRINE_CN = {
      "1st": "第一三合 · 水局",
      "2nd": "第二三合 · 金局",
      "3rd": "第三三合 · 火局",
      "4th": "第四三合 · 木局",
    };
    const ZODIAC_TRINE_BY_ANIMAL = {
      rat: "1st",
      dragon: "1st",
      monkey: "1st",
      ox: "2nd",
      snake: "2nd",
      rooster: "2nd",
      tiger: "3rd",
      horse: "3rd",
      dog: "3rd",
      rabbit: "4th",
      goat: "4th",
      pig: "4th",
    };

    const HD_CENTER_LAYOUT = {
      head: { x: 180, y: 60, short: "Hd" },
      ajna: { x: 180, y: 122, short: "Aj" },
      throat: { x: 180, y: 188, short: "Th" },
      g: { x: 180, y: 258, short: "G" },
      ego: { x: 252, y: 258, short: "Eg" },
      spleen: { x: 108, y: 258, short: "Sp" },
      sacral: { x: 180, y: 338, short: "Sa" },
      solar: { x: 252, y: 338, short: "So" },
      root: { x: 180, y: 420, short: "Rt" },
    };
    const HD_FULL_CHANNEL_PAIRS = [
      [1, 8], [2, 14], [3, 60], [4, 63], [5, 15], [6, 59], [7, 31], [9, 52],
      [10, 20], [10, 34], [10, 57], [11, 56], [12, 22], [13, 33], [16, 48],
      [17, 62], [18, 58], [19, 49], [20, 34], [20, 57], [21, 45], [23, 43],
      [24, 61], [25, 51], [26, 44], [27, 50], [28, 38], [29, 46], [30, 41],
      [32, 54], [34, 57], [35, 36], [37, 40], [39, 55], [42, 53], [47, 64]
    ];
    const HD_FULL_GATE_POSITIONS = {
      64: { x: 254.6231, y: 97.6231 }, 61: { x: 278.4154, y: 97.6231 }, 63: { x: 304.3462, y: 97.6231 },
      47: { x: 254.6231, y: 134.3462 }, 24: { x: 279.4846, y: 134.3462 }, 4: { x: 304.3461, y: 134.3461 },
      17: { x: 255.6923, y: 206.5923 }, 43: { x: 278.4154, y: 221.9693 }, 11: { x: 302.3462, y: 206.5923 },
      62: { x: 253.5539, y: 273.2769 }, 23: { x: 279.4846, y: 273.2769 }, 56: { x: 303.4154, y: 273.2769 },
      35: { x: 319.3462, y: 302.5539 }, 16: { x: 237.4846, y: 302.5539 }, 12: { x: 318.2769, y: 333.5539 },
      20: { x: 238.5539, y: 334.6231 }, 45: { x: 320.4154, y: 354.4846 }, 31: { x: 254.6231, y: 365.5539 },
      8: { x: 279.4846, y: 365.5539 }, 33: { x: 303.4154, y: 366.6231 }, 1: { x: 279.5539, y: 412.2077 },
      7: { x: 257.3462, y: 430.2769 }, 13: { x: 300.5539, y: 430.2769 }, 10: { x: 223.4154, y: 466.3462 },
      25: { x: 332.4846, y: 474.6923 }, 21: { x: 398.8615, y: 506.0 }, 15: { x: 255.4846, y: 512.9693 },
      46: { x: 301.4154, y: 512.9693 }, 2: { x: 278.4154, y: 530.7616 }, 51: { x: 381.7231, y: 521.2769 },
      26: { x: 356.9308, y: 558.4846 }, 40: { x: 426.9308, y: 571.5538 }, 48: { x: 54.5231, y: 603.4154 },
      36: { x: 504.2384, y: 603.4154 }, 57: { x: 75.5231, y: 614.4154 }, 22: { x: 483.3769, y: 613.3461 },
      5: { x: 253.5539, y: 620.2770 }, 14: { x: 279.4846, y: 620.2769 }, 29: { x: 304.4846, y: 620.2770 },
      37: { x: 459.2384, y: 627.4846 }, 44: { x: 106.5231, y: 633.3462 }, 34: { x: 233.2077, y: 647.4154 },
      50: { x: 132.5923, y: 660.7615 }, 6: { x: 426.5846, y: 659.6923 }, 49: { x: 454.4461, y: 682.6231 },
      27: { x: 231.0692, y: 683.2077 }, 32: { x: 103.4539, y: 681.6231 }, 59: { x: 320.4154, y: 687.4846 },
      55: { x: 476.4461, y: 696.6231 }, 28: { x: 83.5923, y: 694.4846 }, 9: { x: 303.4154, y: 711.6230 },
      3: { x: 279.5539, y: 711.6231 }, 42: { x: 253.5538, y: 710.5538 }, 18: { x: 58.8693, y: 709.4846 },
      30: { x: 499.1692, y: 710.5538 }, 53: { x: 253.5539, y: 763.3462 }, 60: { x: 279.4846, y: 763.3461 },
      52: { x: 302.3462, y: 763.3461 }, 38: { x: 237.4846, y: 811.4154 }, 54: { x: 238.5539, y: 786.4154 },
      19: { x: 319.3462, y: 786.4154 }, 39: { x: 319.3462, y: 810.3462 }, 41: { x: 320.4154, y: 839.3462 },
      58: { x: 236.4154, y: 840.4154 }
    };
    const HD_FULL_CENTER_GATES = {
      head: [64, 61, 63],
      ajna: [47, 24, 4, 17, 43, 11],
      throat: [62, 23, 56, 35, 16, 12, 20, 45, 31, 8, 33],
      g: [1, 7, 13, 10, 15, 46, 2, 25],
      ego: [21, 51, 26, 40],
      spleen: [48, 57, 44, 50, 32, 28, 18],
      solar: [36, 22, 37, 6, 49, 55, 30],
      sacral: [5, 14, 29, 34, 27, 59, 9, 3, 42],
      root: [53, 60, 52, 38, 54, 19, 39, 41, 58]
    };
    const ZODIAC_ANIMAL_SV = {
      rat: "Råttan",
      ox: "Oxen",
      tiger: "Tigern",
      rabbit: "Kaninen",
      dragon: "Draken",
      snake: "Ormen",
      horse: "Hästen",
      goat: "Geten",
      monkey: "Apan",
      rooster: "Tuppen",
      dog: "Hunden",
      pig: "Grisen",
    };
    const ZODIAC_ELEMENT_SV = {
      wood: "Trä",
      fire: "Eld",
      earth: "Jord",
      metal: "Metall",
      water: "Vatten",
    };
    const ZODIAC_YINYANG_SV = {
      yin: "Yin",
      yang: "Yang",
    };
    const ZODIAC_TRINE_SV = {
      "1st": "1:a",
      "2nd": "2:a",
      "3rd": "3:e",
      "4th": "4:e",
    };

    const HD_TYPE_SV = {
      generator: "Generator",
      "manifesting generator": "Manifesterande generator",
      projector: "Projektor",
      manifestor: "Manifestor",
      reflector: "Reflektor",
    };

    const HD_STRATEGY_SV = {
      "wait to respond": "Vänta på respons",
      "wait to respond, then inform": "Vänta på respons och informera sedan",
      "wait to respond then inform": "Vänta på respons och informera sedan",
      "wait for the invitation": "Vänta på inbjudan",
      "wait for invitation": "Vänta på inbjudan",
      "inform before acting": "Informera före handling",
      inform: "Informera före handling",
      "wait a lunar cycle": "Vänta en måncykel",
      "wait for a lunar cycle": "Vänta en måncykel",
    };

    const HD_AUTHORITY_SV = {
      "emotional authority": "Emotionell auktoritet",
      "emotional (solar plexus) authority": "Emotionell auktoritet (solarplexus)",
      "sacral authority": "Sakral auktoritet",
      "splenic authority": "Mjältauktoritet",
      "ego authority": "Egoauktoritet",
      "ego projected authority": "Egoauktoritet",
      "self-projected authority": "Självprojicerad auktoritet",
      "mental authority": "Mental auktoritet",
      "environmental authority": "Mental auktoritet",
      "lunar authority": "Lunar auktoritet",
      "no inner authority": "Ingen inre auktoritet",
    };

    const HD_DEFINITION_SV = {
      "single definition": "Enkel definition",
      single: "Enkel definition",
      "split definition": "Delad definition",
      split: "Delad definition",
      "triple split definition": "Trippel-delad definition",
      "triple split": "Trippel-delad definition",
      "quadruple split definition": "Kvadrupel-delad definition",
      "quadruple split": "Kvadrupel-delad definition",
    };
    const HD_CROSS_SV_EXACT = {
      "the right angle cross of explanation": "Det rätvinkliga korset för förklaring",
      "right angle cross of explanation": "Det rätvinkliga korset för förklaring",
    };
    const HD_CROSS_TERM_SV = {
      explanation: "förklaring",
      laws: "lagar",
      planning: "planering",
      service: "tjänst",
      sphinx: "sfinksen",
      rulership: "ledarskap",
      penetration: "genomträngning",
      contagion: "smitta",
      incarnation: "inkarnation",
      consciousness: "medvetande",
      tension: "spänning",
      vessel: "kärlet",
      love: "kärlek",
    };

    const HD_NOTSELF_SV = {
      frustration: "Frustration",
      anger: "Ilska",
      bitterness: "Bitterhet",
      disappointment: "Besvikelse",
    };

    const HD_SIGNATURE_SV = {
      satisfaction: "Tillfredsställelse",
      peace: "Frid",
      success: "Framgång",
      surprise: "Överraskning",
    };

    const HD_ROLE_SV = {
      investigator: "Utforskare",
      hermit: "Eremit",
      martyr: "Prövare",
      opportunist: "Nätverkare",
      heretic: "Kättare",
      "role model": "Förebild",
    };

    const HD_TYPE_DETAIL_SV = {
      generator:
        "Din aura är öppen och magnetisk. Du är byggd för uthållig livskraft och mår bäst när kroppen får svara med ett tydligt ja eller nej innan huvudet tar över.",
      "manifesting generator":
        "Du kombinerar generatorns arbetsmotor med manifestorns snabbhet. Din väg är ofta icke-linjär: testa, justera, byt riktning snabbt och låt entusiasmen visa nästa steg.",
      projector:
        "Du är här för att se system, människor och energi på djupet. När du blir sedd och inbjuden kan din vägledning skapa enorm precision utan att du behöver driva allt själv.",
      manifestor:
        "Du är initierande energi. Din styrka är att starta nya rörelser och öppna dörrar. När du informerar innan handling minskar motståndet i omgivningen.",
      reflector:
        "Du speglar kvaliteten i miljön och i grupper du är i. Din tydlighet växer med tid, rätt plats och rätt människor. Din närvaro visar ofta sanningen i systemet omkring dig.",
    };

    const HD_STRATEGY_DETAIL_SV = {
      "wait to respond":
        "Låt livet komma till dig först. När något externt triggar respons i kroppen blir handlingen mer korrekt och hållbar.",
      "wait to respond, then inform":
        "Först respons i kroppen, sedan information till berörda. Det skapar fart med mindre friktion i relationer och samarbeten.",
      "wait for the invitation":
        "Vänta på genuin inbjudan i viktiga livsområden. Då blir din skärpa väl mottagen och du slipper slösa energi på att försöka övertyga.",
      "inform before acting":
        "Din kraft är att initiera. När du informerar innan du agerar minskar missförstånd och du får friare väg framåt.",
      "wait a lunar cycle":
        "Ge större beslut en måncykel. Tydligheten landar när du hinner känna flera perspektiv genom tiden, inte i första impulsen.",
    };

    const HD_AUTHORITY_DETAIL_SV = {
      "emotional authority":
        "Vänta igenom den känslomässiga vågen innan beslut. Sann klarhet kommer när topp och dal fått passera.",
      "sacral authority":
        "Lita på kroppens omedelbara respons. Ett levande ja känns fysiskt, ett nej känns tungt eller stängt.",
      "splenic authority":
        "Din intuition är lågmäld och snabb. Den talar i nuet, ofta bara en gång, och känns som en stilla visshet.",
      "ego authority":
        "Din vilja är beslutsverktyget. Rätt val känns som något du verkligen kan och vill stå för fullt ut.",
      "self-projected authority":
        "Klarhet kommer när du hör dig själv tala högt. Din identitet och riktning visar vägen genom ord.",
      "mental authority":
        "Du vinner på att processa med rätt människor och miljö. Beslut klarnar i dialog och rätt sammanhang.",
      "lunar authority":
        "Tid är din vän. Genom att vänta en måncykel blir beslut förankrade i helhet snarare än dagsform.",
      "no inner authority":
        "När inre auktoritet saknas blir miljö, spegling och timing extra viktiga för att fatta hållbara beslut.",
    };

    const HD_DEFINITION_DETAIL_SV = {
      "single definition":
        "Energiflödet är mer internt sammanhängande. Du kan ofta processa och integrera saker självständigt.",
      "split definition":
        "Du har två energiklungor som ibland behöver 'broar' via andra människor eller rätt sammanhang för att kännas helt synkade.",
      "triple split definition":
        "Tre energiklungor gör att rörelse mellan miljöer och människor ofta hjälper dig att få mental och emotionell klarhet.",
      "quadruple split definition":
        "Flera energiklungor gör att du mår bra av tid, variation och att låta insikter falla på plats stegvis.",
    };

    const HD_PROFILE_LINE_DETAIL_SV = {
      1: "Linje 1 söker trygghet genom kunskap, grund och fördjupning.",
      2: "Linje 2 bär naturlig talang och behöver också tid för återhämtning i sin egen rytm.",
      3: "Linje 3 lär genom erfarenhet, test och korrigering i verkligheten.",
      4: "Linje 4 bygger möjligheter genom relationer, nätverk och tillit.",
      5: "Linje 5 projiceras på av andra och är stark i praktiska lösningar under press.",
      6: "Linje 6 mognar i faser och blir över tid en förebild med helhetsperspektiv.",
    };

    const safe = (value) => (value === null || value === undefined || value === "" ? "—" : String(value));
    const esc = (value) => String(value ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");

    const hashRaw = window.location.hash.startsWith("#") ? window.location.hash.slice(1) : "";
    const params = new URLSearchParams(hashRaw);
    const shouldPrint = params.get("print") === "1";

    let data = fallbackData;
    if (params.get("data")) {
      try {
        const decoded = decodeURIComponent(params.get("data"));
        const parsed = JSON.parse(decoded);
        if (parsed && typeof parsed === "object") {
          data = parsed;
        }
      } catch {
        data = fallbackData;
      }
    }

    const locale = String(data?.locale || "sv-SE");
    const isSwedish = locale.toLowerCase().startsWith("sv");
    const t = (sv, en) => (isSwedish ? sv : en);
    document.documentElement.lang = isSwedish ? "sv" : "en";
    document.title = t("Natalanalysrapport", "Natal Analysis Report");

    const setText = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    };

    let cachedAttributeHighlighter = null;
    const highlightAttributeText = (value) => {
      if (!cachedAttributeHighlighter) {
        cachedAttributeHighlighter = createLifeSummaryHighlighter();
      }
      return cachedAttributeHighlighter(rawText(value));
    };

    const setHighlightedText = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = highlightAttributeText(value);
    };

    const fmtDate = (value, opts) => {
      if (!value) return "—";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "—";
      return date.toLocaleString(locale, opts || {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    };

    const rawText = (value) => {
      if (value === null || value === undefined) return "";
      return String(value).trim();
    };

    const shortBirthPlace = (value) => {
      const raw = rawText(value);
      if (!raw) return "";
      const parts = raw
        .split(",")
        .map((part) => part.trim())
        .filter(Boolean);
      if (parts.length <= 1) return raw;
      const city = parts[0];
      let country = parts[parts.length - 1];
      while (parts.length > 1 && /^\d[\d\s-]*$/.test(country)) {
        parts.pop();
        country = parts[parts.length - 1] || "";
      }
      if (!country) return city;
      if (city.toLowerCase() === country.toLowerCase()) return city;
      return `${city}, ${country}`;
    };

    const norm = (value) => rawText(value)
      .toLowerCase()
      .replace(/[\u2010-\u2015]/g, "-")
      .replace(/[^a-z0-9]+/g, " ")
      .replace(/\s+/g, " ")
      .trim();

    const localizeLookup = (value, map) => {
      const raw = rawText(value);
      if (!raw) return "";
      if (map[raw]) return map[raw];
      const key = norm(raw);
      if (!key) return "";
      if (map[key]) return map[key];
      const hit = Object.entries(map).find(([candidate]) => norm(candidate) === key);
      return hit ? hit[1] : "";
    };

    const localizeHdFromMap = (value, map) => {
      const raw = rawText(value);
      if (!raw) return "—";
      if (!isSwedish) return raw;
      return localizeLookup(raw, map) || raw;
    };

    const localizeHdList = (value, map) => {
      const raw = rawText(value);
      if (!raw) return "—";
      if (!isSwedish) return raw;
      const parts = raw
        .split(/[\/,]/)
        .map((part) => part.trim())
        .filter(Boolean);
      if (!parts.length) return raw;
      return parts.map((part) => localizeLookup(part, map) || part).join(" / ");
    };

    const localizeHdRole = (role) => {
      const raw = rawText(role);
      if (!raw) return "";
      if (!isSwedish) return raw;
      return raw
        .split("/")
        .map((part) => part.trim())
        .filter(Boolean)
        .map((part) => localizeLookup(part, HD_ROLE_SV) || part)
        .join(" / ");
    };

    const localizeHdType = (value) => localizeHdFromMap(value, HD_TYPE_SV);
    const localizeHdStrategy = (value) => localizeHdFromMap(value, HD_STRATEGY_SV);
    const localizeHdAuthority = (value) => localizeHdFromMap(value, HD_AUTHORITY_SV);
    const localizeHdDefinition = (value) => localizeHdFromMap(value, HD_DEFINITION_SV);
    const localizeHdNotSelf = (value) => localizeHdList(value, HD_NOTSELF_SV);
    const localizeHdSignature = (value) => localizeHdList(value, HD_SIGNATURE_SV);
    const localizeHdCross = (value) => {
      const raw = rawText(value);
      if (!raw) return "—";
      if (!isSwedish) return raw;
      const key = norm(raw);
      if (HD_CROSS_SV_EXACT[key]) return HD_CROSS_SV_EXACT[key];
      const cleaned = raw.replace(/^the\s+/i, "").trim();
      const match = cleaned.match(/^(right angle|left angle|juxtaposition)\s+cross\s+of\s+(.+)$/i);
      if (!match) return raw;
      const orientationKey = norm(match[1]);
      const orientation =
        orientationKey === "right angle"
          ? "Det rätvinkliga"
          : orientationKey === "left angle"
            ? "Det vänstervinkliga"
            : "Juxtapositions";
      const tail = String(match[2] || "")
        .split(/\s+/)
        .map((part) => {
          const term = norm(part);
          return HD_CROSS_TERM_SV[term] || String(part).toLowerCase();
        })
        .join(" ")
        .trim();
      if (!tail) return raw;
      return orientationKey === "juxtaposition"
        ? `${orientation}korset för ${tail}`
        : `${orientation} korset för ${tail}`;
    };
    const localizeZodiacAnimal = (value) => {
      const raw = rawText(value);
      if (!raw) return "—";
      if (!isSwedish) return raw;
      return localizeLookup(raw, ZODIAC_ANIMAL_SV) || raw;
    };
    const localizeZodiacElement = (value) => {
      const raw = rawText(value);
      if (!raw) return "—";
      if (!isSwedish) return raw;
      return localizeLookup(raw, ZODIAC_ELEMENT_SV) || raw;
    };
    const localizeZodiacYinYang = (value) => {
      const raw = rawText(value);
      if (!raw) return "—";
      if (!isSwedish) return raw;
      return localizeLookup(raw, ZODIAC_YINYANG_SV) || raw;
    };
    const localizeZodiacTrine = (value) => {
      const raw = rawText(value);
      if (!raw) return "—";
      if (!isSwedish) return raw;
      return localizeLookup(raw, ZODIAC_TRINE_SV) || raw;
    };

    const resolveZodiacKey = (value) => {
      const raw = rawText(value);
      if (!raw) return "";
      const key = raw
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, " ")
        .trim();
      const aliases = {
        rat: "rat",
        rattan: "rat",
        ox: "ox",
        oxe: "ox",
        oxen: "ox",
        tiger: "tiger",
        rabbit: "rabbit",
        kanin: "rabbit",
        kaninen: "rabbit",
        dragon: "dragon",
        drake: "dragon",
        draken: "dragon",
        snake: "snake",
        orm: "snake",
        ormen: "snake",
        horse: "horse",
        hast: "horse",
        hasten: "horse",
        goat: "goat",
        get: "goat",
        geten: "goat",
        sheep: "goat",
        monkey: "monkey",
        apa: "monkey",
        apan: "monkey",
        rooster: "rooster",
        tupp: "rooster",
        tuppen: "rooster",
        chicken: "rooster",
        dog: "dog",
        hund: "dog",
        hunden: "dog",
        pig: "pig",
        gris: "pig",
        grisen: "pig",
        boar: "pig",
      };
      return aliases[key] || key;
    };

    const resolveElementKey = (value) => {
      const raw = norm(value);
      if (!raw) return "";
      const aliases = {
        wood: "wood",
        tra: "wood",
        tre: "wood",
        fire: "fire",
        eld: "fire",
        earth: "earth",
        jord: "earth",
        metal: "metal",
        metall: "metal",
        water: "water",
        vatten: "water",
      };
      return aliases[raw] || "";
    };

    const resolveYinYangKey = (value) => {
      const raw = norm(value);
      if (!raw) return "";
      const aliases = {
        yin: "yin",
        yang: "yang",
      };
      return aliases[raw] || "";
    };

    const resolveTrineKey = (value, zodiacKey) => {
      const raw = rawText(value);
      const n = String(raw).match(/[1-4]/)?.[0] || "";
      if (n === "1") return "1st";
      if (n === "2") return "2nd";
      if (n === "3") return "3rd";
      if (n === "4") return "4th";
      return ZODIAC_TRINE_BY_ANIMAL[zodiacKey] || "";
    };

    const localizeHdCenter = (center) => {
      const raw = rawText(center);
      if (!raw) return "—";
      if (!isSwedish) return raw;
      const key = raw.toLowerCase().replace(/[\s_-]+/g, "");
      if (key === "head" || key === "crown") return "Hjässa";
      if (key === "ajna") return "Ajna";
      if (key === "throat") return "Hals";
      if (key === "g" || key === "gcenter" || key === "identity") return "G-center";
      if (key === "ego" || key === "heart" || key === "will") return "Ego/Hjärta";
      if (key === "spleen") return "Mjälte";
      if (key === "sacral") return "Sakral";
      if (key === "solarplexus" || key === "emotional") return "Solarplexus";
      if (key === "root") return "Rot";
      return raw;
    };

    const hdDetailText = (value, map, svFallback, enFallback) => {
      const raw = rawText(value);
      if (!raw) return t(svFallback, enFallback);
      if (!isSwedish) return enFallback;
      return localizeLookup(raw, map) || svFallback;
    };

    const describeHdProfile = (profileRaw) => {
      const raw = rawText(profileRaw);
      const match = raw.match(/([1-6])\s*\/\s*([1-6])/);
      if (!match) {
        return t(
          "Profilen visar hur du lär, relaterar och utvecklas genom livet.",
          "Profile shows how you learn, relate, and evolve through life."
        );
      }
      const first = Number(match[1]);
      const second = Number(match[2]);
      if (!isSwedish) {
        return `Profile ${first}/${second} combines two core lines that shape your learning style and relational pattern.`;
      }
      const firstText = HD_PROFILE_LINE_DETAIL_SV[first] || "Den första linjen beskriver hur du tar in världen.";
      const secondText = HD_PROFILE_LINE_DETAIL_SV[second] || "Den andra linjen beskriver hur du delar din energi med andra.";
      return `Profil ${first}/${second}: ${firstText} ${secondText}`;
    };

    const localizeSign = (sign) => {
      if (!sign) return "—";
      return isSwedish ? SIGN_SV[sign] || sign : sign;
    };

    const localizePlanet = (planet) => {
      if (!planet) return "—";
      return isSwedish ? PLANET_SV[planet] || planet : planet;
    };

    const escapeRegExp = (value) => String(value).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

    const uniqTerms = (terms) => {
      const seen = new Set();
      return (Array.isArray(terms) ? terms : [])
        .map((term) => rawText(term))
        .filter((term) => term && term !== "—")
        .filter((term) => {
          const key = term.toLowerCase();
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
    };

    const buildTermRegex = (terms) => {
      const alternatives = uniqTerms(terms)
        .sort((a, b) => b.length - a.length)
        .map((term) =>
          escapeRegExp(term)
            .replace(/\\\s+/g, "\\s+")
            .replace(/\\-/g, "(?:-|–|—)")
        );
      if (!alternatives.length) return null;
      return new RegExp(
        `(^|[^A-Za-zÀ-ÖØ-öø-ÿ0-9])(${alternatives.join("|")})(?=$|[^A-Za-zÀ-ÖØ-öø-ÿ0-9])`,
        "giu"
      );
    };

    const makeDomainHighlighter = (specs) => {
      const compiled = (Array.isArray(specs) ? specs : [])
        .map((spec, priority) => {
          const regex = buildTermRegex(spec?.terms || []);
          if (!regex) return null;
          return {
            className: spec.className,
            regex,
            priority,
          };
        })
        .filter(Boolean);

      return (text) => {
        const source = String(text ?? "");
        if (!source) return "";
        if (!compiled.length) return esc(source);

        const matches = [];
        compiled.forEach((entry) => {
          entry.regex.lastIndex = 0;
          let found;
          while ((found = entry.regex.exec(source))) {
            const prefix = found[1] || "";
            const body = found[2] || "";
            const start = found.index + prefix.length;
            const end = start + body.length;
            if (end > start) {
              matches.push({
                start,
                end,
                className: entry.className,
                priority: entry.priority,
              });
            }
            if (entry.regex.lastIndex === found.index) entry.regex.lastIndex += 1;
          }
        });

        if (!matches.length) return esc(source);

        matches.sort(
          (a, b) =>
            a.start - b.start ||
            (b.end - b.start) - (a.end - a.start) ||
            a.priority - b.priority
        );

        const accepted = [];
        let occupiedUntil = -1;
        matches.forEach((match) => {
          if (match.start < occupiedUntil) return;
          accepted.push(match);
          occupiedUntil = match.end;
        });

        let out = "";
        let cursor = 0;
        accepted.forEach((match) => {
          if (match.start > cursor) {
            out += esc(source.slice(cursor, match.start));
          }
          out += `<span class="term-pill ${match.className}">${esc(source.slice(match.start, match.end))}</span>`;
          cursor = match.end;
        });
        if (cursor < source.length) {
          out += esc(source.slice(cursor));
        }
        return out;
      };
    };

    const createLifeSummaryHighlighter = () => {
      const aspects = Array.isArray(data?.astrology?.aspects) ? data.astrology.aspects : [];
      const channels = Array.isArray(data?.humanDesign?.channels) ? data.humanDesign.channels : [];
      const definedCenters = Array.isArray(data?.humanDesign?.definedCenters) ? data.humanDesign.definedCenters : [];
      const zodiacAnimal = localizeZodiacAnimal(data?.chineseZodiac?.animal);
      const zodiacElement = localizeZodiacElement(data?.chineseZodiac?.element);
      const zodiacYinYang = localizeZodiacYinYang(data?.chineseZodiac?.yinYang);
      const zodiacTrine = localizeZodiacTrine(data?.chineseZodiac?.trine);

      const hdType = localizeHdType(data?.humanDesign?.type);
      const hdStrategy = localizeHdStrategy(data?.humanDesign?.strategy);
      const hdAuthority = localizeHdAuthority(data?.humanDesign?.authority);
      const hdDefinition = localizeHdDefinition(data?.humanDesign?.definition);
      const hdCross = localizeHdCross(data?.humanDesign?.incarnationCross);
      const hdProfile = rawText(data?.humanDesign?.profile);
      const hdNotSelf = localizeHdNotSelf(data?.humanDesign?.notSelf);
      const hdSignature = localizeHdSignature(data?.humanDesign?.signature);

      const houseTerms = Array.from({ length: 12 }, (_, idx) => houseLabel(idx + 1));
      const aspectTerms = aspects.map((aspect) => rawText(aspect?.type));
      const channelTerms = channels
        .map((channel) =>
          Array.isArray(channel?.gates) && channel.gates.length >= 2
            ? `${channel.gates[0]}-${channel.gates[1]}`
            : ""
        )
        .filter(Boolean);
      const centerTerms = [
        ...definedCenters.map((center) => localizeHdCenter(center)),
        ...["head", "crown", "ajna", "throat", "g", "ego", "heart", "spleen", "sacral", "solar", "solar plexus", "root"]
          .map((center) => localizeHdCenter(center)),
      ];

      const astroTerms = [
        "Astrologi",
        "astrologins",
        "astrology",
        "astrological",
        "natalchart",
        "natal chart",
        "Sol",
        "Solen",
        "Måne",
        "Månen",
        "Ascendent",
        "Ascendenten",
        "Sun",
        "Moon",
        "Ascendant",
        "aspekt",
        "aspekter",
        "aspect",
        "aspects",
        "retrograd",
        "retrogradt",
        "retrograde",
        ...Object.keys(SIGN_SV),
        ...Object.values(SIGN_SV),
        ...Object.keys(PLANET_SV),
        ...Object.values(PLANET_SV),
        ...houseTerms,
        ...aspectTerms,
      ];

      const hdTerms = [
        "Human Design",
        "Human Design-signaturen",
        "Human Design-typen",
        "Human Designs",
        "bodygraph",
        "typ",
        "type",
        "strategi",
        "strategy",
        "auktoritet",
        "authority",
        "profil",
        "profile",
        "definition",
        "inkarnationskors",
        "incarnation cross",
        "center",
        "centers",
        "kanal",
        "kanaler",
        "channel",
        "channels",
        "gate",
        "gates",
        "icke-jag-tema",
        "not-self",
        "signatur",
        "signature",
        ...Object.keys(HD_TYPE_SV),
        ...Object.values(HD_TYPE_SV),
        ...Object.keys(HD_STRATEGY_SV),
        ...Object.values(HD_STRATEGY_SV),
        ...Object.keys(HD_AUTHORITY_SV),
        ...Object.values(HD_AUTHORITY_SV),
        ...Object.keys(HD_DEFINITION_SV),
        ...Object.values(HD_DEFINITION_SV),
        ...Object.keys(HD_NOTSELF_SV),
        ...Object.values(HD_NOTSELF_SV),
        ...Object.keys(HD_SIGNATURE_SV),
        ...Object.values(HD_SIGNATURE_SV),
        hdType,
        hdStrategy,
        hdAuthority,
        hdDefinition,
        hdCross,
        hdProfile,
        hdNotSelf,
        hdSignature,
        ...centerTerms,
        ...channelTerms,
      ];

      const zodiacTerms = [
        "Kinesisk zodiak",
        "Chinese zodiac",
        "zodiak",
        "zodiac",
        "årsdjur",
        "Year animal",
        "Yin/Yang",
        "yin",
        "yang",
        "element",
        "trigon",
        "trine",
        "jordgren",
        "earthly branch",
        ...Object.keys(ZODIAC_ANIMAL_SV),
        ...Object.values(ZODIAC_ANIMAL_SV),
        ...Object.keys(ZODIAC_ELEMENT_SV),
        ...Object.values(ZODIAC_ELEMENT_SV),
        ...Object.keys(ZODIAC_YINYANG_SV),
        ...Object.values(ZODIAC_YINYANG_SV),
        ...Object.keys(ZODIAC_TRINE_SV),
        ...Object.values(ZODIAC_TRINE_SV),
        zodiacAnimal,
        zodiacElement,
        zodiacYinYang,
        zodiacTrine,
        rawText(data?.chineseZodiac?.earthlyBranch),
        rawText(data?.chineseZodiac?.animalChar),
      ];

      return makeDomainHighlighter([
        { className: "term-astro", terms: astroTerms },
        { className: "term-hd", terms: hdTerms },
        { className: "term-zodiac", terms: zodiacTerms },
      ]);
    };

    const houseLabel = (house) => {
      if (!Number.isFinite(Number(house))) return isSwedish ? "okänt hus" : "unknown house";
      const n = Number(house);
      if (!isSwedish) {
        if (n === 1) return "1st House";
        if (n === 2) return "2nd House";
        if (n === 3) return "3rd House";
        return `${n}th House`;
      }
      if (n === 1) return "1:a huset";
      if (n === 2) return "2:a huset";
      if (n === 3) return "3:e huset";
      return `${n}:e huset`;
    };

    const houseTheme = (house) => {
      const n = Number(house);
      if (!Number.isFinite(n)) return t("ett viktigt livsområde", "an important life area");
      return isSwedish
        ? HOUSE_THEME_SV[n] || "ett viktigt livsområde"
        : HOUSE_THEME_EN[n] || "an important life area";
    };

    const signTone = (sign) => {
      if (!sign) return t("uttrycka sig på sitt eget sätt", "express in its own style");
      if (isSwedish) return SIGN_TONE_SV[sign] || "uttrycka sig på sitt eget sätt";
      return SIGN_NOTE_EN[sign] || "express in its own style";
    };

    const displayName = data?.user?.name || data?.user?.username || t("Mottagaren", "Recipient");
    const birthBits = [
      data?.user?.birthDate || null,
      data?.user?.birthTime || null,
      shortBirthPlace(data?.user?.birthPlace) || null,
    ].filter(Boolean);

    const buildCoreNarrative = () => {
      const sun = localizeSign(data?.astrology?.sun);
      const moon = localizeSign(data?.astrology?.moon);
      const asc = localizeSign(data?.astrology?.ascendant);
      const hdType = localizeHdType(data?.humanDesign?.type);
      const authority = localizeHdAuthority(data?.humanDesign?.authority);
      const animal = localizeZodiacAnimal(data?.chineseZodiac?.animal);

      if (isSwedish) {
        return `${displayName} bär en Sol i ${sun}, en Måne i ${moon} och en Ascendent i ${asc}. Tillsammans ger de en signatur där vilja, känsla och uttryck möts i samma berättelse. Human Design-typen ${hdType} med auktoriteten ${authority} visar hur beslut blir mest sanna i praktiken. I bakgrunden färgar årsdjuret ${animal} ditt sociala grundtempo. Helheten pekar mot ett liv där tydlig riktning och inre lyhördhet behöver gå hand i hand.`;
      }

      return `${displayName} carries a Sun in ${sun}, a Moon in ${moon}, and an Ascendant in ${asc}. Together they shape how identity, emotional rhythm, and outer presence work as one story. Human Design type ${hdType} with authority ${authority} shows how your decisions become most aligned in practice. In the background, the year animal ${animal} colors your social baseline. The full picture points toward a life path where clear direction and inner sensitivity need to work together.`;
    };

    const planetNarrative = (planet) => {
      const name = String(planet?.name || "");
      const sign = planet?.sign || null;
      const house = planet?.house;
      const signName = localizeSign(sign);
      const degree = planet?.degree || null;
      const retro = Boolean(planet?.retrograde);

      if (isSwedish) {
        const arch = PLANET_ARCHETYPE_SV[name] || "Den här planeten visar en viktig livsenergi.";
        const signSentence = sign
          ? `I ${signName} vill energin ${signTone(sign)}.`
          : "Energin är mer rå och mindre färgad av ett specifikt tecken.";
        const houseSentence = Number.isFinite(Number(house))
          ? `I ${houseLabel(house)} handlar detta särskilt om ${houseTheme(house)}.`
          : "Det här märks i flera livsområden samtidigt.";
        const gift = PLANET_GIFT_SV[name] || "låta din mognad guida dina val.";
        const retroSentence = retro
          ? "Eftersom planeten är retrograd blir processen mer inre, reflekterande och fördjupande."
          : "Här rör sig energin mer direkt och synligt i vardagen.";
        return `${arch} ${signSentence} ${houseSentence} Gåvan här är att ${gift}. ${retroSentence} ${degree ? `Placeringen på ${degree} visar en tydlig spets i just detta tema.` : ""}`.trim();
      }

      const arch = PLANET_ARCHETYPE_EN[name] || "This planet marks an important life theme.";
      const signSentence = sign
        ? `In ${signName}, this energy tends to ${signTone(sign)}.`
        : "This energy acts in a more raw, less sign-colored way.";
      const houseSentence = Number.isFinite(Number(house))
        ? `In the ${houseLabel(house)}, it focuses on ${houseTheme(house)}.`
        : "This can show up across several life areas at once.";
      const retroSentence = retro
        ? "Because this planet is retrograde, the process is often more internal and reflective."
        : "This energy moves more directly and visibly in daily life.";
      return `${arch} ${signSentence} ${houseSentence} ${retroSentence}`.trim();
    };

    const dominantValue = (values) => {
      const filtered = values.filter((value) => value !== null && value !== undefined && String(value).trim() !== "");
      if (!filtered.length) return null;
      const counts = new Map();
      filtered.forEach((value) => {
        const key = String(value);
        counts.set(key, (counts.get(key) || 0) + 1);
      });
      let top = null;
      let topCount = -1;
      counts.forEach((count, key) => {
        if (count > topCount) {
          top = key;
          topCount = count;
        }
      });
      return top;
    };

    const buildLifeJourneySummary = () => {
      const planets = Array.isArray(data?.astrology?.planets) ? data.astrology.planets : [];
      const aspects = Array.isArray(data?.astrology?.aspects) ? data.astrology.aspects : [];
      const retroCount = planets.filter((p) => Boolean(p?.retrograde)).length;
      const dominantSignRaw = dominantValue(planets.map((p) => p?.sign || null));
      const dominantHouseRaw = dominantValue(planets.map((p) => {
        if (!Number.isFinite(Number(p?.house))) return null;
        return Number(p.house);
      }));
      const dominantSign = dominantSignRaw ? localizeSign(dominantSignRaw) : t("okänt tecken", "unknown sign");
      const dominantHouse = dominantHouseRaw ? houseLabel(Number(dominantHouseRaw)) : t("okänt hus", "unknown house");

      const sun = localizeSign(data?.astrology?.sun);
      const moon = localizeSign(data?.astrology?.moon);
      const asc = localizeSign(data?.astrology?.ascendant);
      const hdType = localizeHdType(data?.humanDesign?.type);
      const hdStrategy = localizeHdStrategy(data?.humanDesign?.strategy);
      const hdAuthority = localizeHdAuthority(data?.humanDesign?.authority);
      const hdProfile = rawText(data?.humanDesign?.profile) || "—";
      const hdDefinition = localizeHdDefinition(data?.humanDesign?.definition);
      const zodiacAnimal = localizeZodiacAnimal(data?.chineseZodiac?.animal);
      const zodiacElement = localizeZodiacElement(data?.chineseZodiac?.element);
      const zodiacYinYang = localizeZodiacYinYang(data?.chineseZodiac?.yinYang);
      const centers = Array.isArray(data?.humanDesign?.definedCenters) ? data.humanDesign.definedCenters : [];
      const channels = Array.isArray(data?.humanDesign?.channels) ? data.humanDesign.channels : [];
      const centerList = centers.slice(0, 5).map((center) => localizeHdCenter(center));
      const majorAspects = aspects.slice(0, 6).map((a) => {
        const aName = localizePlanet(a?.a || "");
        const bName = localizePlanet(a?.b || "");
        const type = rawText(a?.type) || t("aspekt", "aspect");
        return `${aName} ${type} ${bName}`;
      });
      const strongAspects = majorAspects.slice(0, 3).join(", ");
      const houseThemeText = houseTheme(Number(dominantHouseRaw || 0));

      if (isSwedish) {
        const p1 = `I den här helsidesläsningen framträder en tydlig grundsignatur: Sol i ${sun}, Måne i ${moon} och Ascendent i ${asc}. Tillsammans beskriver de en person vars identitet, känslorytm och sätt att möta världen sannolikt utvecklas stegvis snarare än linjärt. Den starkaste astrologiska betoningen ligger i ${dominantSign} och ${dominantHouse}, vilket ofta betyder att just teman kring ${houseThemeText} återkommer genom livet som en röd tråd.`;
        const p2 = `Tidigt i livet brukar den här typen av karta visa ett barn med stark inre känslighet men också tydlig egenmotor. Månen i ${moon} pekar på hur trygghet byggs genom rätt emotionell ton i vardagen, medan Ascendenten i ${asc} visar hur omgivningen först kommer uppfatta barnet. Om det yttre bemötandet harmonierar med det inre tempot läggs en stabil grund för självkänsla, gränssättning och tillit.`;
        const p3 = `Human Design-signaturen fördjupar bilden: ${hdType} med strategin ${hdStrategy} och auktoriteten ${hdAuthority}. Här blir beslutshygien central. När beslut får följa kroppens egen timing i stället för yttre press tenderar både självförtroende och riktning att växa mer naturligt. Profil ${hdProfile} och ${hdDefinition} beskriver dessutom att lärandet sker genom levd erfarenhet över tid, inte genom att prestera rätt från start.`;
        const p4 = `I praktiken betyder det här att miljöval blir avgörande under uppväxten: rätt tempo, rätt relationer och ett språk för inre signaler. Om barnet tidigt får träna på att känna efter, vänta in klarhet och uttrycka sina behov utan skam, minskar risken för att leva i andras rytm. I stället byggs ett mönster där individen får stå i sin egen ton med både mjukhet och integritet.`;
        const p5 = `Kinesisk zodiak adderar social färg till helheten. ${zodiacAnimal} med elementet ${zodiacElement}${zodiacYinYang && zodiacYinYang !== "—" ? ` och ${zodiacYinYang.toLowerCase()}-polaritet` : ""} pekar ofta på ett grundtemperament som påverkar relationer, gruppdynamik och hur personen reagerar under press. Denna nivå fungerar som ett bakgrundstempo: subtil men tydlig, särskilt i övergångar och nya livsfaser.`;
        const p6 = `Med ${centers.length} definierade center och ${channels.length} aktiva kanaler syns samtidigt en potential för både inre stabilitet och social precision. ${centerList.length ? `Särskilt center som ${centerList.join(", ")} kan bli bärande resurser när livet kräver fokus och återhämtning.` : ""} Det här talar för en person som över tid kan utveckla förmågan att vara både mottaglig och riktad: känslig för omgivningen men inte uppslukad av den.`;
        const p7 = majorAspects.length
          ? `Aspekterna ger ytterligare djup. Kombinationer som ${strongAspects} pekar ofta på inre dialoger där vilja, känsla och relationstempo behöver synkas om flera gånger i livet. Det behöver inte tolkas som problem, utan som en mognadsväg där varje fas lär individen att förvandla friktion till klarhet.`
          : `Även med begränsad aspektlista syns en utvecklingslinje där mognad byggs genom balans mellan inre lyhördhet och yttre handling.`;
        const p8 = retroCount > 0
          ? `Att ${retroCount} planet${retroCount === 1 ? "" : "er"} står retrogradt antyder också perioder av stark inre omkalibrering. I sådana faser kan livet upplevas långsammare utåt, men rikare inåt. När omgivningen förstår detta blir dessa perioder inte stopp, utan avgörande integrationsfaser där riktning förfinas.`
          : "Frånvaron av tydlig retrograd tyngd kan ge en mer direkt rytm i flera livsområden, med snabbare övergång mellan insikt och handling.";
        const p9 = `En möjlig livsbana här är därför inte ett enda förutbestämt spår, utan en serie återkommande fördjupningar: först trygghet och identitet, sedan relationell mognad, därefter tydligare kallelse i arbete eller skapande. Med rätt stöd finns stark potential för ett liv där individen både bygger något eget och blir viktig för andra genom närvaro, vägledning eller kreativt uttryck.`;
        const p10 = `Sammanfattat visar kartan en person med kapacitet att leva både sant och betydelsefullt: att stå stadigt i sig själv utan att stänga hjärtat. När astrologins riktning, Human Designs beslutskompass och zodiakens sociala ton får samspela, pekar helheten mot ett liv med tydlig riktning, djup relationell intelligens och långsiktig inre hållbarhet.`;
        return [p1, p2, p3, p4, p5, p6, p7, p8, p9, p10];
      }

      const p1 = `This full-page reading shows a layered core signature: Sun in ${sun}, Moon in ${moon}, and Ascendant in ${asc}. Identity, emotional rhythm, and social expression are likely to unfold in phases rather than all at once. The strongest emphasis appears in ${dominantSign} and ${dominantHouse}, often pointing to recurring themes around ${houseThemeText}.`;
      const p2 = `In early development, this chart often describes a child who needs both emotional attunement and room for authentic self-direction. Moon in ${moon} speaks to inner safety patterns, while Ascendant in ${asc} shapes first impressions and social adaptation. When outer guidance respects inner rhythm, confidence grows with less internal conflict.`;
      const p3 = `Human Design deepens this pattern: ${hdType} with strategy ${hdStrategy} and authority ${hdAuthority}. Decision hygiene becomes central. When choices are made in body-based timing instead of pressure-based urgency, direction, trust, and sustainable momentum strengthen over time. Profile ${hdProfile} and ${hdDefinition} suggest growth through lived process rather than instant perfection.`;
      const p4 = `Practically, this often means environment matters as much as talent. The right pace, the right relational field, and language for inner signals can make a dramatic difference. A child raised with permission to pause, sense, and then act usually develops a healthier relationship to both ambition and boundaries.`;
      const p5 = `Chinese zodiac adds social tone: ${zodiacAnimal} with ${zodiacElement}${zodiacYinYang && zodiacYinYang !== "—" ? ` and ${zodiacYinYang.toLowerCase()} polarity` : ""}. This layer often shapes instinctive social movement, stress response, and relational style during transitions.`;
      const p6 = `With ${centers.length} defined centers and ${channels.length} active channels, the chart suggests potential for both inner steadiness and interpersonal influence. ${centerList.length ? `Centers like ${centerList.join(", ")} may become core strengths under pressure.` : ""} This can support a life path where sensitivity and structure grow together instead of competing.`;
      const p7 = majorAspects.length
        ? `Aspect dialogues such as ${strongAspects} point to recurring integration work between emotion, agency, and relational timing. These are not flaws but maturation cycles that often convert friction into depth.`
        : `Even with partial aspect data, the pattern suggests maturation through repeated alignment between emotion, action, and meaning.`;
      const p8 = retroCount > 0
        ? `${retroCount} retrograde planet${retroCount === 1 ? "" : "s"} may indicate periods of internal recalibration. Outward pace can look slower in those phases, yet inner clarity often deepens.`
        : `Lower retrograde emphasis can correlate with more direct transitions from insight to outward action in multiple life areas.`;
      const p9 = `A likely trajectory here is not a single fixed destiny, but a sequence of deepening stages: secure identity, relational refinement, and eventually a clearer vocation through contribution or creative leadership.`;
      const p10 = `Taken together, astrology, Human Design, and Chinese zodiac point toward a life where direction and sensitivity can coexist. With the right support, this profile can become both self-led and deeply meaningful to others.`;
      return [p1, p2, p3, p4, p5, p6, p7, p8, p9, p10];
    };

    const buildSynthesis = () => {
      const points = [];
      const sun = localizeSign(data?.astrology?.sun);
      const moon = localizeSign(data?.astrology?.moon);
      const asc = localizeSign(data?.astrology?.ascendant);
      const hdType = localizeHdType(data?.humanDesign?.type);
      const strategy = localizeHdStrategy(data?.humanDesign?.strategy);
      const authority = localizeHdAuthority(data?.humanDesign?.authority);
      const zodiacAnimal = localizeZodiacAnimal(data?.chineseZodiac?.animal);
      const zodiacElement = localizeZodiacElement(data?.chineseZodiac?.element);
      const centers = Array.isArray(data?.humanDesign?.definedCenters) ? data.humanDesign.definedCenters : [];
      const channels = Array.isArray(data?.humanDesign?.channels) ? data.humanDesign.channels : [];

      if (isSwedish) {
        points.push(`Triaden Sol ${sun}, Måne ${moon} och Ascendent ${asc} beskriver både ditt inre driv och hur du blir läst av andra. När de får samspela minskar friktionen i vardagen.`);
        points.push(`I beslut: luta dig mot din auktoritet (${authority}) och låt strategin (${strategy}) styra timing. Det gör att rätt steg känns tydliga även under osäkerhet.`);
        points.push(`Human Design-typen ${hdType} visar hur din energi fungerar mest hållbart över tid. Planera veckan så att du arbetar med, inte emot, den rytmen.`);
        points.push(`Årsdjuret ${zodiacAnimal} med elementet ${zodiacElement} färgar din sociala stil. Under press är det här ofta din första reaktionston.`);
        points.push(`Definierade center (${centers.length}) och aktiva kanaler (${channels.length}) visar var du har naturlig stabilitet. Lägg viktiga åtaganden i de områden där energin redan är robust.`);
      } else {
        points.push(`The Sun ${sun}, Moon ${moon}, and Ascendant ${asc} describe both your inner drive and your social presence. Alignment between these three lowers day-to-day friction.`);
        points.push(`In decisions: trust your authority (${authority}) and let strategy (${strategy}) guide timing. This keeps direction clear even under uncertainty.`);
        points.push(`Human Design type ${hdType} shows how your energy works sustainably over time. Plan your week to support that rhythm instead of fighting it.`);
        points.push(`Year animal ${zodiacAnimal} with element ${zodiacElement} colors your social baseline. Under pressure, this is often your first-response style.`);
        points.push(`Defined centers (${centers.length}) and active channels (${channels.length}) show where your energy is naturally stable. Place key commitments where that stability already exists.`);
      }

      return points;
    };

    const normalizeHdCenterKey = (value) => {
      const key = norm(value);
      if (!key) return null;
      if (key === "head" || key === "crown") return "head";
      if (key === "ajna") return "ajna";
      if (key === "throat") return "throat";
      if (key === "g" || key === "g center" || key === "gcenter" || key === "identity") return "g";
      if (key === "ego" || key === "heart" || key === "will") return "ego";
      if (key === "spleen") return "spleen";
      if (key === "sacral") return "sacral";
      if (key === "solar" || key === "solar plexus" || key === "solarplexus" || key === "emotional") return "solar";
      if (key === "root") return "root";
      return null;
    };

    const renderHdFeatureChart = ({ definedCenters, channels, pGates, dGates }) => {
      setText("hd-feature-title", t("Human Design-chart · Full karta", "Human Design chart · Full map"));
      setText(
        "hd-feature-subtitle",
        t(
          "Detta är din fulla bodygraph-visualisering. Här ser du exakt vilka gates som är aktiva, vilka kanaler som blir hela, och hur center-statusen formar din energi i vardagen.",
          "This is your full bodygraph visualization. It shows exactly which gates are active, which channels are complete, and how center status shapes your daily energy."
        )
      );

      const pGateSet = new Set((pGates || []).map((entry) => Number(entry?.gate)).filter(Number.isFinite));
      const dGateSet = new Set((dGates || []).map((entry) => Number(entry?.gate)).filter(Number.isFinite));
      const activeGateSet = new Set([...pGateSet, ...dGateSet]);

      const svg = document.getElementById("hd-feature-bodygraph");
      if (svg) {
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        const createEl = (name, attrs) => {
          const el = document.createElementNS("http://www.w3.org/2000/svg", name);
          Object.entries(attrs || {}).forEach(([k, v]) => el.setAttribute(k, String(v)));
          return el;
        };
        const GATE_RADIUS = 8;
        const CHANNEL_PAD = 6;

        const uniqueChannels = [];
        const seen = new Set();
        (channels || []).forEach((channel) => {
          const gates = Array.isArray(channel?.gates) ? channel.gates.map((g) => Number(g)).filter(Number.isFinite) : [];
          if (gates.length < 2) return;
          const pair = gates.slice(0, 2).sort((a, b) => a - b).join("-");
          if (seen.has(pair)) return;
          seen.add(pair);
          uniqueChannels.push({ gates: gates.slice(0, 2) });
        });

        uniqueChannels.forEach((channel, idx) => {
          const g1 = channel.gates[0];
          const g2 = channel.gates[1];
          const a = HD_FULL_GATE_POSITIONS[g1];
          const b = HD_FULL_GATE_POSITIONS[g2];
          if (!a || !b) return;
          const hasP = pGateSet.has(g1) || pGateSet.has(g2);
          const hasD = dGateSet.has(g1) || dGateSet.has(g2);
          const stroke =
            hasP && hasD ? "#efe9fa" : hasP ? "#35ff6f" : hasD ? "#ff3bbf" : idx % 2 ? "#35ff6f" : "#ff3bbf";
          const dx = b.x - a.x;
          const dy = b.y - a.y;
          const len = Math.sqrt(dx * dx + dy * dy) || 1;
          const ux = dx / len;
          const uy = dy / len;
          const startX = a.x + ux * (GATE_RADIUS + CHANNEL_PAD);
          const startY = a.y + uy * (GATE_RADIUS + CHANNEL_PAD);
          const endX = b.x - ux * (GATE_RADIUS + CHANNEL_PAD);
          const endY = b.y - uy * (GATE_RADIUS + CHANNEL_PAD);
          svg.appendChild(createEl("line", {
            x1: startX, y1: startY, x2: endX, y2: endY,
            stroke,
            "stroke-width": 5,
            "stroke-linecap": "round",
            opacity: "0.96",
          }));
        });

        HD_FULL_CHANNEL_PAIRS.forEach(([g1, g2]) => {
          const has1 = activeGateSet.has(g1);
          const has2 = activeGateSet.has(g2);
          if (has1 === has2) return;
          const from = has1 ? g1 : g2;
          const to = has1 ? g2 : g1;
          const a = HD_FULL_GATE_POSITIONS[from];
          const b = HD_FULL_GATE_POSITIONS[to];
          if (!a || !b) return;
          const dx = b.x - a.x;
          const dy = b.y - a.y;
          const len = Math.sqrt(dx * dx + dy * dy) || 1;
          const ux = dx / len;
          const uy = dy / len;
          const startX = a.x + ux * (GATE_RADIUS + CHANNEL_PAD);
          const startY = a.y + uy * (GATE_RADIUS + CHANNEL_PAD);
          const halfLen = Math.max((len / 2) - (GATE_RADIUS + CHANNEL_PAD), 4);
          const endX = a.x + ux * halfLen;
          const endY = a.y + uy * halfLen;
          svg.appendChild(createEl("line", {
            x1: startX, y1: startY, x2: endX, y2: endY,
            stroke: "#35ff6f",
            "stroke-width": 4,
            "stroke-linecap": "round",
            "stroke-dasharray": "6 6",
            opacity: "0.9",
          }));
        });

        const allGateEntries = [...(pGates || []), ...(dGates || [])];
        const gateSeen = new Set();
        allGateEntries.forEach((entry) => {
          const gateNum = Number(entry?.gate);
          if (!Number.isFinite(gateNum)) return;
          const pos = HD_FULL_GATE_POSITIONS[gateNum];
          if (!pos) return;
          const typeRaw = String(entry?.type || "").toUpperCase();
          const type = typeRaw === "D" ? "D" : "P";
          const key = `${gateNum}-${type}`;
          if (gateSeen.has(key)) return;
          gateSeen.add(key);
          const hasBoth = pGateSet.has(gateNum) && dGateSet.has(gateNum);
          const offset = type === "D" && hasBoth ? 15 : 0;
          svg.appendChild(createEl("circle", {
            cx: pos.x + offset,
            cy: pos.y,
            r: GATE_RADIUS,
            fill: "#f4ede2",
            stroke: "rgba(57, 54, 48, 0.75)",
            "stroke-width": 2,
          }));
          const text = createEl("text", {
            x: pos.x + offset,
            y: pos.y + 3,
            "text-anchor": "middle",
            "font-size": "7",
            "font-weight": "700",
            fill: type === "D" ? "#ff3bbf" : "#35ff6f",
          });
          text.textContent = String(gateNum);
          svg.appendChild(text);
        });
      }

      const legendEl = document.getElementById("hd-feature-legend");
      if (legendEl) {
        const mk = (color, text) =>
          `<span class="hd-feature-legend-chip"><span class="hd-feature-legend-dot" style="background:${color}"></span>${esc(text)}</span>`;
        legendEl.innerHTML = [
          mk("#35ff6f", t("Personlighet (medveten energi)", "Personality (conscious energy)")),
          mk("#ff3bbf", t("Design (omedveten kroppskod)", "Design (unconscious body code)")),
          mk("#efe9fa", t("Hel kanal (både personlighet + design)", "Full channel (personality + design)")),
          mk("#35ff6f", t("Streckad halvkanal = hängande gate", "Dashed half-channel = hanging gate")),
        ].join("");
      }

      // Detailed explanatory block was removed from this section to avoid duplicated content.
    };

    const ensureAvatar = () => {
      const img = document.getElementById("cover-avatar");
      if (!img) return;
      const rawCandidates = Array.isArray(data?.user?.avatarCandidates) ? data.user.avatarCandidates : [];
      const fallbackCandidates = [
        rawText(data?.user?.avatarUrl),
        rawText(data?.user?.username) ? `/avatars/${rawText(data.user.username)}.jpg` : "",
        rawText(data?.user?.username) ? `/avatars/${rawText(data.user.username).toLowerCase()}.jpg` : "",
        rawText(data?.user?.name) ? `/avatars/${rawText(data.user.name)}.jpg` : "",
        rawText(data?.user?.name) ? `/avatars/${rawText(data.user.name).toLowerCase()}.jpg` : "",
        "/avatars/Default.jpg",
      ];
      const queue = Array.from(new Set([...rawCandidates, ...fallbackCandidates].filter(Boolean)));
      let index = 0;
      const loadNext = () => {
        if (index >= queue.length) {
          img.removeAttribute("src");
          return;
        }
        img.src = queue[index];
        index += 1;
      };
      img.onerror = loadNext;
      loadNext();
    };

    const renderHdVisuals = () => {
      setText("hd-visual-title", t("Human Design · Grafisk översikt", "Human Design · Visual Overview"));
      setText("hd-bodygraph-title", t("Center och kanaler", "Centers and Channels"));
      setText("hd-bars-title", t("Energiindex", "Energy Index"));
      setText("hd-gates-title", t("Gate-översikt", "Gate overview"));
      setText("hd-gates-personality-label", t("Personlighet", "Personality"));
      setText("hd-gates-design-label", t("Design", "Design"));

      const standaloneChart = data?.humanDesignStandalone?.chart || {};
      const pGates = Array.isArray(standaloneChart?.personalityGates) ? standaloneChart.personalityGates : [];
      const dGates = Array.isArray(standaloneChart?.designGates) ? standaloneChart.designGates : [];
      const definedRaw = Array.isArray(data?.humanDesign?.definedCenters) ? data.humanDesign.definedCenters : [];
      const definedCenters = Array.from(
        new Set(
          definedRaw
            .map((center) => normalizeHdCenterKey(center))
            .filter(Boolean)
        )
      );
      const channelsRaw = Array.isArray(data?.humanDesign?.channels) ? data.humanDesign.channels : [];
      const channels = channelsRaw
        .map((channel) => {
          const centers = Array.isArray(channel?.centers) ? channel.centers.map((center) => normalizeHdCenterKey(center)).filter(Boolean) : [];
          if (centers.length < 2) return null;
          return {
            c1: centers[0],
            c2: centers[1],
            gates: Array.isArray(channel?.gates) ? channel.gates : [],
          };
        })
        .filter(Boolean);

      renderHdFeatureChart({
        definedCenters,
        channels,
        pGates,
        dGates,
      });

      const barsEl = document.getElementById("hd-bars");
      if (barsEl) {
        const gateCount = pGates.length + dGates.length;
        const bars = [
          { label: t("Definierade center", "Defined centers"), value: definedCenters.length, max: 9 },
          { label: t("Aktiva kanaler", "Active channels"), value: channels.length, max: Math.max(12, channels.length || 1) },
          { label: t("Personlighet-gates", "Personality gates"), value: pGates.length, max: Math.max(13, pGates.length || 1) },
          { label: t("Design-gates", "Design gates"), value: dGates.length, max: Math.max(13, dGates.length || 1) },
          { label: t("Totalt gates", "Total gates"), value: gateCount, max: Math.max(26, gateCount || 1) },
        ];
        barsEl.innerHTML = bars
          .map((bar) => {
            const ratio = Math.max(0, Math.min(1, bar.max > 0 ? bar.value / bar.max : 0));
            return `
              <div class="hd-bar-item">
                <div class="hd-bar-head">
                  <span>${esc(bar.label)}</span>
                  <span>${esc(`${bar.value}`)}</span>
                </div>
                <div class="hd-bar-track">
                  <div class="hd-bar-fill" style="width: ${(ratio * 100).toFixed(1)}%"></div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      const gateChipText = (entry) => {
        const gate = Number(entry?.gate);
        if (!Number.isFinite(gate)) return "—";
        const line = Number(entry?.line);
        return Number.isFinite(line) && line > 0 ? `${gate}.${line}` : `${gate}`;
      };
      const renderGateChips = (id, entries) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (!entries.length) {
          el.innerHTML = `<span class="hd-gate-chip">${esc("—")}</span>`;
          return;
        }
        el.innerHTML = entries
          .slice(0, 24)
          .map((entry) => `<span class="hd-gate-chip">${esc(gateChipText(entry))}</span>`)
          .join("");
      };
      renderGateChips("hd-gates-personality", pGates);
      renderGateChips("hd-gates-design", dGates);

      const svg = document.getElementById("hd-super-bodygraph");
      if (svg) {
        while (svg.firstChild) svg.removeChild(svg.firstChild);
        const make = (name, attrs) => {
          const el = document.createElementNS("http://www.w3.org/2000/svg", name);
          Object.entries(attrs || {}).forEach(([k, v]) => el.setAttribute(k, String(v)));
          return el;
        };

        const uniqueChannels = [];
        const seenPairs = new Set();
        channels.forEach((channel) => {
          const key = [channel.c1, channel.c2].sort().join("-");
          if (seenPairs.has(key)) return;
          seenPairs.add(key);
          uniqueChannels.push(channel);
        });

        uniqueChannels.forEach((channel, idx) => {
          const a = HD_CENTER_LAYOUT[channel.c1];
          const b = HD_CENTER_LAYOUT[channel.c2];
          if (!a || !b) return;
          const line = make("line", {
            x1: a.x,
            y1: a.y,
            x2: b.x,
            y2: b.y,
            stroke: idx % 2 === 0 ? "#d8a24d" : "#1f9c93",
            "stroke-width": 5,
            "stroke-linecap": "round",
            opacity: "0.94",
          });
          svg.appendChild(line);
        });

        Object.entries(HD_CENTER_LAYOUT).forEach(([center, point]) => {
          const isDefinedCenter = definedCenters.includes(center);
          const circle = make("circle", {
            cx: point.x,
            cy: point.y,
            r: 22,
            fill: isDefinedCenter ? "#e6be79" : "rgba(255,255,255,0.88)",
            stroke: "rgba(49, 43, 56, 0.58)",
            "stroke-width": 2,
          });
          const txt = make("text", {
            x: point.x,
            y: point.y + 4,
            "text-anchor": "middle",
            "font-size": 11,
            "font-weight": 800,
            fill: "#2b3242",
          });
          txt.textContent = point.short;
          svg.appendChild(circle);
          svg.appendChild(txt);
        });

        if (!uniqueChannels.length && !definedCenters.length) {
          const empty = make("text", {
            x: 180,
            y: 258,
            "text-anchor": "middle",
            "font-size": 13,
            "font-weight": 700,
            fill: "#5c6477",
          });
          empty.textContent = t("Ingen HD-grafdata tillgänglig ännu.", "No HD graph data available yet.");
          svg.appendChild(empty);
        }
      }

      setText(
        "hd-bodygraph-note",
        t(
          `Grafen visar ${definedCenters.length} definierade center och ${channels.length} aktiva kanaler från din chart.`,
          `Graph shows ${definedCenters.length} defined centers and ${channels.length} active channels from your chart.`
        )
      );
    };

    const setCover = () => {
      setText("cover-brand", t("SPUTNET WORLD", "SPUTNET WORLD"));
      setText("cover-title", t("Natalanalysrapport", "Natal Analysis report"));
      setText("cover-subtitle", t(
        "En metodisk sammanställning baserad på Astrologi, Human Design och den Kinesiska Zodiaken.",
        "A methodical synthesis based on Astrology, Human Design, and the Chinese Zodiac."
      ));
      setText("cover-gift-line", t(`Tillägnad ${displayName} som en guide i livet.`, `Dedicated to ${displayName}, to offer guidance on the coming journey.`));

      setText("chip-label-name", t("Namn", "Name"));
      setText("chip-label-birth", t("Födelsedata", "Birth data"));
      setText("chip-label-core", t("Kärnsignatur", "Core signature"));
      setText("chip-label-created", t("Skapad", "Generated"));

      setText("chip-name", safe(displayName));
      setText("chip-birth", birthBits.length ? birthBits.join(" · ") : "—");
      const coreSignature = [
        localizeSign(data?.astrology?.sun),
        localizeHdType(data?.humanDesign?.type),
        localizeZodiacAnimal(data?.chineseZodiac?.animal),
      ]
        .filter((v) => v && v !== "—")
        .join(" · ");
      setText("chip-core", coreSignature || "—");
      setText("chip-created", fmtDate(data?.generatedAt));

      ensureAvatar();

      const zodiacAnimalRaw = rawText(data?.chineseZodiac?.animal);
      const zodiacAnimal = localizeZodiacAnimal(zodiacAnimalRaw);
      const zodiacStyle =
        ZODIAC_STYLE_SV_KEY[resolveZodiacKey(zodiacAnimalRaw || zodiacAnimal)] ||
        ZODIAC_STYLE_SV[zodiacAnimalRaw] ||
        "din unika sociala ton";
      setHighlightedText("cover-quote", t(
        `${displayName} bär en karta där Sol, Måne och Ascendent tecknar riktningen. Tillsammans med ${zodiacStyle} och Human Design-signaturen skapas en personlig kompass för relationer, arbete och livsval.`,
        `${displayName} carries a chart where Sun, Moon, and Ascendant sketch direction. Together with Human Design and Chinese zodiac, it forms a personal compass for relationships, work, and life choices.`
      ));
    };

    const setCore = () => {
      setText("core-eyebrow", t("Kärna", "Core"));
      setText("core-title", t("Din kosmiska grundton", "Your Cosmic Baseline"));
      setText("core-kicker", t(
        "Tre nycklar som formar hur du känner, väljer och blir upplevd.",
        "Three keys that shape how you feel, decide, and are perceived."
      ));

      setText("triad-sun-label", t("Solen", "Sun"));
      setText("triad-moon-label", t("Månen", "Moon"));
      setText("triad-asc-label", t("Ascendent", "Ascendant"));

      setText("triad-sun-value", localizeSign(data?.astrology?.sun));
      setText("triad-moon-value", localizeSign(data?.astrology?.moon));
      setText("triad-asc-value", localizeSign(data?.astrology?.ascendant));

      const sunSign = data?.astrology?.sun;
      const moonSign = data?.astrology?.moon;
      const ascSign = data?.astrology?.ascendant;

      setHighlightedText("triad-sun-note", t(
        sunSign ? `Din livseld i ${localizeSign(sunSign)} vill ${signTone(sunSign)}.` : "Din livseld blir tydligare när soltecknet finns tillgängligt.",
        sunSign ? `Your life force in ${localizeSign(sunSign)} tends to feel ${signTone(sunSign)}.` : "Your life force reads clearer when Sun sign data is available."
      ));
      setHighlightedText("triad-moon-note", t(
        moonSign ? `Känslorytmen i ${localizeSign(moonSign)} söker att ${signTone(moonSign)}.` : "Måntecknet ger nyckeln till känslomässig återhämtning.",
        moonSign ? `Your emotional rhythm in ${localizeSign(moonSign)} tends to be ${signTone(moonSign)}.` : "Moon sign data gives a key to emotional recovery."
      ));
      setHighlightedText("triad-asc-note", t(
        ascSign ? `Första intrycket genom ${localizeSign(ascSign)} blir ofta att ${signTone(ascSign)}.` : "Ascendenten visar hur andra först läser din närvaro.",
        ascSign ? `First impression through ${localizeSign(ascSign)} often feels ${signTone(ascSign)}.` : "Ascendant shows how others first read your presence."
      ));

      setHighlightedText("core-narrative", buildCoreNarrative());
    };

    const renderNatalWheel = () => {
      const stage = document.getElementById("natal-wheel-stage");
      const coverStage = document.getElementById("cover-natal-wheel-stage");
      if (!stage && !coverStage) return;
      if (stage) stage.innerHTML = "";
      if (coverStage) coverStage.innerHTML = "";

      const housesRaw = Array.isArray(data?.astrology?.houses) ? data.astrology.houses : [];
      const cusps = housesRaw
        .sort((a, b) => Number(a?.house || 0) - Number(b?.house || 0))
        .map((house) => Number(house?.lon))
        .filter(Number.isFinite)
        .slice(0, 12);
      const planetsRaw = Array.isArray(data?.astrology?.planets) ? data.astrology.planets : [];

      const astrodrawPlanetMap = {
        Sun: "Sun",
        Moon: "Moon",
        Mercury: "Mercury",
        Venus: "Venus",
        Mars: "Mars",
        Jupiter: "Jupiter",
        Saturn: "Saturn",
        Uranus: "Uranus",
        Neptune: "Neptune",
        Pluto: "Pluto",
        Chiron: "Chiron",
        Lilith: "Lilith",
        "North Node": "NNode",
        "South Node": "SNode",
      };
      const wheelPlanets = {};
      planetsRaw.forEach((planet) => {
        const key = astrodrawPlanetMap[String(planet?.name || "").trim()];
        const lon = Number(planet?.lon);
        if (!key || !Number.isFinite(lon) || wheelPlanets[key]) return;
        const normalized = ((lon % 360) + 360) % 360;
        wheelPlanets[key] = [normalized];
      });

      if (cusps.length !== 12 || !Object.keys(wheelPlanets).length) {
        const noteText = t(
          "Natalchart kunde inte ritas: saknar full planet- eller husdata.",
          "Could not render natal wheel: missing full planet or house data."
        );
        const emptyHtml = `<div class="empty">${esc(t("Ingen tillräcklig astrologidata ännu.", "Not enough astrology data yet."))}</div>`;
        setText("natal-wheel-note", noteText);
        setText("cover-natal-wheel-note", noteText);
        if (stage) stage.innerHTML = emptyHtml;
        if (coverStage) coverStage.innerHTML = emptyHtml;
        return;
      }

      const ChartCtor = window?.astrochart?.Chart || window?.Chart;
      if (typeof ChartCtor !== "function") {
        const noteText = t(
          "AstroDraw kunde inte laddas i den här miljön. Försök ladda om sidan.",
          "AstroDraw did not load in this environment. Try reloading the page."
        );
        const emptyHtml = `<div class="empty">${esc(t("Biblioteket för natalchart saknas tillfälligt.", "Natal chart library is temporarily unavailable."))}</div>`;
        setText("natal-wheel-note", noteText);
        setText("cover-natal-wheel-note", noteText);
        if (stage) stage.innerHTML = emptyHtml;
        if (coverStage) coverStage.innerHTML = emptyHtml;
        return;
      }

      const signPalette = [
        "#8c7cff",
        "#7f8dff",
        "#739cff",
        "#68aaff",
        "#60b6ff",
        "#67c0ff",
        "#73c8ff",
        "#82cbf0",
        "#93c3e6",
        "#9eb5e2",
        "#a59fde",
        "#a88ad8",
      ];

      const retoneNatalSvg = (svg) => {
        if (!svg) return;
        const darkTones = new Set(["#000", "#000000", "black", "#111", "#111111", "#333", "#333333"]);
        const inkLight = "#f4e8d6";
        const lineLight = "#e2d2b5";

        svg.querySelectorAll("[stroke]").forEach((node) => {
          const stroke = String(node.getAttribute("stroke") || "").trim().toLowerCase();
          if (darkTones.has(stroke)) node.setAttribute("stroke", lineLight);
        });

        svg.querySelectorAll("text").forEach((node) => {
          const fill = String(node.getAttribute("fill") || "").trim().toLowerCase();
          if (!fill || darkTones.has(fill)) node.setAttribute("fill", inkLight);
        });

        svg.querySelectorAll("[fill]").forEach((node) => {
          const fill = String(node.getAttribute("fill") || "").trim().toLowerCase();
          if (darkTones.has(fill)) node.setAttribute("fill", inkLight);
        });
      };

      const styleSignRing = (svg) => {
        if (!svg) return false;
        const signLayer = svg.querySelector('[id$="-signs"]');
        if (!signLayer) return false;
        const signSegments = [...signLayer.querySelectorAll("path")].filter((path) => {
          const fill = String(path.getAttribute("fill") || "").trim().toLowerCase();
          return fill && fill !== "none";
        });
        if (signSegments.length < 12) return false;

        signSegments.slice(0, 12).forEach((segment, idx) => {
          segment.setAttribute("fill", signPalette[idx % signPalette.length]);
          segment.setAttribute("stroke", "#f7eddc");
          segment.setAttribute("stroke-width", "2.3");
          segment.setAttribute("stroke-linejoin", "round");
          segment.setAttribute("paint-order", "stroke fill");
          segment.setAttribute("opacity", "0.99");
        });
        return true;
      };

      const drawAspectWeb = (svg, fallbackSize, planetsMap) => {
        if (!svg || !planetsMap) return;
        const ns = "http://www.w3.org/2000/svg";
        const vb = String(svg.getAttribute("viewBox") || "")
          .split(/\s+/)
          .map(Number)
          .filter(Number.isFinite);
        const width = vb.length === 4 ? vb[2] : fallbackSize;
        const height = vb.length === 4 ? vb[3] : fallbackSize;
        const cx = width / 2;
        const cy = height / 2;

        const radii = [...svg.querySelectorAll("circle")]
          .map((circle) => Number(circle.getAttribute("r")))
          .filter((r) => Number.isFinite(r) && r > 0)
          .sort((a, b) => b - a);
        const uniqueRadii = radii.filter((r, idx) => idx === 0 || Math.abs(r - radii[idx - 1]) > 1.5);
        const signInnerR = uniqueRadii[1] || Math.min(width, height) * 0.38;
        const aspectR = signInnerR - 10;

        const oldLayer = svg.querySelector("#sputnet-aspect-web");
        if (oldLayer) oldLayer.remove();

        const entries = Object.entries(planetsMap)
          .map(([name, values]) => {
            const lon = Number(Array.isArray(values) ? values[0] : NaN);
            if (!Number.isFinite(lon)) return null;
            const rad = (lon * Math.PI) / 180;
            return {
              name,
              lon,
              x: cx + aspectR * Math.cos(rad),
              y: cy - aspectR * Math.sin(rad),
            };
          })
          .filter(Boolean);
        if (entries.length < 2) return;

        const angleDist = (a, b) => {
          const raw = Math.abs(((a - b) % 360 + 360) % 360);
          return raw > 180 ? 360 - raw : raw;
        };
        const classifyAspect = (d) => {
          if (Math.abs(d - 180) <= 8) return "opposition";
          if (Math.abs(d - 120) <= 7) return "trine";
          if (Math.abs(d - 90) <= 7) return "square";
          if (Math.abs(d - 60) <= 6) return "sextile";
          if (Math.abs(d - 0) <= 8) return "conjunction";
          return "minor";
        };
        const styleByType = {
          opposition: { stroke: "#ffa3d8", width: 1.9, opacity: 0.82, dash: "" },
          trine: { stroke: "#87dbff", width: 1.7, opacity: 0.78, dash: "" },
          square: { stroke: "#ffd5a4", width: 1.65, opacity: 0.76, dash: "" },
          sextile: { stroke: "#a7efcd", width: 1.55, opacity: 0.72, dash: "" },
          conjunction: { stroke: "#d4c4ff", width: 1.35, opacity: 0.66, dash: "3.5 3.5" },
          minor: { stroke: "#8ea7d8", width: 0.9, opacity: 0.34, dash: "2.4 3.2" },
        };

        const layer = document.createElementNS(ns, "g");
        layer.setAttribute("id", "sputnet-aspect-web");
        layer.setAttribute("pointer-events", "none");
        layer.setAttribute("style", "mix-blend-mode:screen");

        for (let i = 0; i < entries.length; i += 1) {
          for (let j = i + 1; j < entries.length; j += 1) {
            const a = entries[i];
            const b = entries[j];
            const type = classifyAspect(angleDist(a.lon, b.lon));
            const style = styleByType[type] || styleByType.minor;
            const line = document.createElementNS(ns, "line");
            line.setAttribute("x1", a.x.toFixed(2));
            line.setAttribute("y1", a.y.toFixed(2));
            line.setAttribute("x2", b.x.toFixed(2));
            line.setAttribute("y2", b.y.toFixed(2));
            line.setAttribute("stroke", style.stroke);
            line.setAttribute("stroke-width", String(style.width));
            line.setAttribute("stroke-opacity", String(style.opacity));
            line.setAttribute("stroke-linecap", "round");
            if (style.dash) line.setAttribute("stroke-dasharray", style.dash);
            layer.appendChild(line);
          }
        }

        const pointsLayer = svg.querySelector('[id$="-points"]');
        if (pointsLayer && pointsLayer.parentNode) {
          pointsLayer.parentNode.insertBefore(layer, pointsLayer);
        } else {
          svg.appendChild(layer);
        }
      };

      const drawSignSeparators = (svg, fallbackSize) => {
        if (!svg) return;
        const ns = "http://www.w3.org/2000/svg";
        const vb = String(svg.getAttribute("viewBox") || "")
          .split(/\s+/)
          .map(Number)
          .filter(Number.isFinite);
        const width = vb.length === 4 ? vb[2] : fallbackSize;
        const height = vb.length === 4 ? vb[3] : fallbackSize;
        const cx = width / 2;
        const cy = height / 2;

        const radii = [...svg.querySelectorAll("circle")]
          .map((circle) => Number(circle.getAttribute("r")))
          .filter((r) => Number.isFinite(r) && r > 0)
          .sort((a, b) => b - a);
        const uniqueRadii = radii.filter((r, idx) => idx === 0 || Math.abs(r - radii[idx - 1]) > 1.5);
        const outerR = uniqueRadii[0] || Math.min(width, height) * 0.45;
        const innerR = uniqueRadii[1] || outerR - Math.max(26, outerR * 0.12);

        const oldLayer = svg.querySelector("#sputnet-sign-separators");
        if (oldLayer) oldLayer.remove();

        const layer = document.createElementNS(ns, "g");
        layer.setAttribute("id", "sputnet-sign-separators");
        layer.setAttribute("opacity", "0.92");

        for (let i = 0; i < 12; i += 1) {
          const angle = (i * 30 * Math.PI) / 180;
          const x1 = cx + innerR * Math.cos(angle);
          const y1 = cy + innerR * Math.sin(angle);
          const x2 = cx + outerR * Math.cos(angle);
          const y2 = cy + outerR * Math.sin(angle);
          const line = document.createElementNS(ns, "line");
          line.setAttribute("x1", x1.toFixed(2));
          line.setAttribute("y1", y1.toFixed(2));
          line.setAttribute("x2", x2.toFixed(2));
          line.setAttribute("y2", y2.toFixed(2));
          line.setAttribute("stroke", "#f7eddc");
          line.setAttribute("stroke-width", "2.1");
          line.setAttribute("stroke-linecap", "round");
          layer.appendChild(line);
        }

        svg.appendChild(layer);
      };

      const wheelData = {
        planets: wheelPlanets,
        cusps,
      };

      const cloneWheelSvg = (sourceSvg, target, maxWidth) => {
        if (!sourceSvg || !target) return false;
        const clone = sourceSvg.cloneNode(true);
        if (!clone) return false;
        clone.removeAttribute("id");
        if (!clone.getAttribute("viewBox")) {
          const width = Number(sourceSvg.getAttribute("width")) || 560;
          const height = Number(sourceSvg.getAttribute("height")) || width;
          clone.setAttribute("viewBox", `0 0 ${width} ${height}`);
        }
        clone.setAttribute("preserveAspectRatio", "xMidYMid meet");
        clone.style.width = "100%";
        clone.style.height = "auto";
        if (Number(maxWidth) > 0) clone.style.maxWidth = `${Number(maxWidth)}px`;
        clone.style.display = "block";
        target.innerHTML = "";
        target.appendChild(clone);
        return true;
      };

      const renderWheelInto = (target, opts) => {
        if (!target || !target.id) return false;
        target.innerHTML = "";
        const minSize = Number(opts?.minSize) || 300;
        const maxSize = Number(opts?.maxSize) || 640;
        const fallbackSize = Number(opts?.fallbackSize) || minSize;
        const size = Math.max(minSize, Math.min(maxSize, target.clientWidth || fallbackSize));
        try {
          const chart = new ChartCtor(target.id, size, size, {
            MARGIN: 34,
            POINTS_COLOR: "#f4e8d6",
            POINTS_TEXT_SIZE: 9.5,
            POINTS_STROKE: 1.8,
            SYMBOL_SCALE: 1,
            SYMBOL_AXIS_FONT_COLOR: "#f0dfc3",
            COLOR_BACKGROUND: "transparent",
            CIRCLE_COLOR: "#f1e3ca",
            LINE_COLOR: "#dfcfb4",
            SIGNS_COLOR: "#f1e3ca",
            SIGNS_STROKE: 2.3,
            CUSPS_FONT_COLOR: "#f1e3ca",
            COLOR_ARIES: signPalette[0],
            COLOR_TAURUS: signPalette[1],
            COLOR_GEMINI: signPalette[2],
            COLOR_CANCER: signPalette[3],
            COLOR_LEO: signPalette[4],
            COLOR_VIRGO: signPalette[5],
            COLOR_LIBRA: signPalette[6],
            COLOR_SCORPIO: signPalette[7],
            COLOR_SAGITTARIUS: signPalette[8],
            COLOR_CAPRICORN: signPalette[9],
            COLOR_AQUARIUS: signPalette[10],
            COLOR_PISCES: signPalette[11],
            COLORS_SIGNS: signPalette,
          });
          chart.radix(wheelData);
          const svg = target.querySelector("svg");
          if (!svg) return false;
          retoneNatalSvg(svg);
          const signRingStyled = styleSignRing(svg);
          if (!signRingStyled) drawSignSeparators(svg, size);
          drawAspectWeb(svg, size, wheelPlanets);
          return true;
        } catch (err) {
          console.error("natal_wheel_render_error", err);
          target.innerHTML = `<div class="empty">${esc(t("Fel vid rendering av natalchart.", "Error while rendering natal wheel."))}</div>`;
          return false;
        }
      };

      const stageOk = renderWheelInto(stage, { minSize: 420, maxSize: 640, fallbackSize: 560 });
      let coverOk = false;

      if (coverStage && stageOk) {
        const stageSvg = stage ? stage.querySelector("svg") : null;
        coverOk = cloneWheelSvg(stageSvg, coverStage, 292);
      }

      if (coverStage && !coverOk) {
        const tempHost = document.createElement("div");
        tempHost.id = `natal-wheel-cover-temp-${Math.random().toString(36).slice(2, 10)}`;
        tempHost.style.position = "absolute";
        tempHost.style.left = "-10000px";
        tempHost.style.top = "-10000px";
        tempHost.style.width = "300px";
        tempHost.style.height = "300px";
        tempHost.style.pointerEvents = "none";
        tempHost.style.opacity = "0";
        tempHost.style.overflow = "hidden";
        document.body.appendChild(tempHost);
        const tempOk = renderWheelInto(tempHost, { minSize: 220, maxSize: 320, fallbackSize: 280 });
        if (tempOk) {
          const tempSvg = tempHost.querySelector("svg");
          coverOk = cloneWheelSvg(tempSvg, coverStage, 292);
        }
        tempHost.remove();
      }

      if (coverStage && !coverOk) {
        coverStage.innerHTML = `<div class="empty">${esc(t("Kunde inte rendera cover-hjulet.", "Could not render cover wheel."))}</div>`;
      }

      if (!stageOk && !coverOk) {
        const noteText = t(
          "Natalchart kunde inte ritas just nu. Kontrollera data och försök igen.",
          "Natal wheel could not be rendered right now. Check data and try again."
        );
        setText("natal-wheel-note", noteText);
        setText("cover-natal-wheel-note", noteText);
      } else {
        const noteText = t(
          "Rund karta ritad med AstroDraw från dina planetpositioner och huscusper.",
          "Round wheel rendered with AstroDraw from your planetary positions and house cusps."
        );
        setText("natal-wheel-note", noteText);
        setText("cover-natal-wheel-note", noteText);
      }
    };

    const setPlanets = () => {
      setText("planet-eyebrow", t("Planetberättelser", "Planet Stories"));
      setText("planet-title", t("Varje planet, en egen scen", "Every Planet, Its Own Stage"));
      setText("planet-kicker", t(
        "Här möts planetens tema, tecknets ton och husets livsområde i en mer personlig tolkning.",
        "Here, planet theme, sign tone, and house focus merge into a more personal interpretation."
      ));
      setText("natal-wheel-title", t("Runt natalchart", "Round natal chart"));
      setText("cover-natal-title", t("Runt natalchart", "Round natal chart"));
      setText(
        "natal-wheel-subtitle",
        t(
          "En klassisk hjulvy över tecken, hus och planeter från din födelsedata.",
          "A classic wheel view of signs, houses, and planets from your birth data."
        )
      );

      setText("aspect-title", t("Aspekter som färgar dynamiken", "Aspects Coloring the Dynamics"));
      renderNatalWheel();

      const order = [
        "Sun",
        "Moon",
        "Mercury",
        "Venus",
        "Mars",
        "Jupiter",
        "Saturn",
        "Uranus",
        "Neptune",
        "Pluto",
        "North Node",
        "Lilith",
        "Chiron",
      ];

      const planetsRaw = Array.isArray(data?.astrology?.planets) ? data.astrology.planets : [];
      const planets = order
        .map((name) => planetsRaw.find((p) => String(p?.name || "") === name))
        .filter(Boolean);

      const planetGrid = document.getElementById("planet-grid");
      if (!planetGrid) return;

      if (!planets.length) {
        planetGrid.innerHTML = `<div class="empty">${esc(t("Inga planetplaceringar tillgängliga ännu.", "No planet placements available yet."))}</div>`;
      } else {
        planetGrid.innerHTML = planets.map((planet) => {
          const name = String(planet.name || "");
          const planetName = localizePlanet(name);
          const signName = localizeSign(planet.sign || null);
          const houseTxt = Number.isFinite(Number(planet.house)) ? houseLabel(planet.house) : t("okänt hus", "unknown house");
          const degree = safe(planet.degree);
          const retro = planet.retrograde ? t("retrograd", "retrograde") : t("direkt", "direct");
          const meta = `${signName} · ${houseTxt} · ${degree} · ${retro}`;
          return `
            <article class="planet-card">
              <div class="planet-head">
                <span class="planet-symbol">${esc(PLANET_SYMBOL[name] || "•")}</span>
                <h3 class="planet-name">${esc(planetName)}</h3>
              </div>
              <p class="planet-meta">${esc(meta)}</p>
              <p class="planet-text">${highlightAttributeText(planetNarrative(planet))}</p>
            </article>
          `;
        }).join("");
      }

      const aspects = Array.isArray(data?.astrology?.aspects) ? data.astrology.aspects : [];
      const aspectTags = document.getElementById("aspect-tags");
      if (!aspectTags) return;

      aspectTags.innerHTML = aspects.length
        ? aspects.slice(0, 18).map((aspect) => {
            const a = localizePlanet(aspect?.a || "");
            const b = localizePlanet(aspect?.b || "");
            const type = safe(aspect?.type || t("aspekt", "aspect"));
            const orb = typeof aspect?.orb === "number" ? ` • orb ${Number(aspect.orb).toFixed(2)}°` : "";
            return `<span class="tag">${esc(`${a} ${type} ${b}${orb}`)}</span>`;
          }).join("")
        : `<span class="tag">${esc(t("Inga aspekter tillgängliga ännu", "No aspects available yet"))}</span>`;
    };

    const setIntegration = () => {
      setText("integration-eyebrow", t("Integrering", "Integration"));
      setText("integration-title", t("Helhetsbild för vardag och riktning", "Integrated Map for Daily Life and Direction"));
      setText("integration-kicker", t(
        "En sammanvägd läsning av beslutstempo, energi och relationell stil.",
        "A combined reading of decision rhythm, energy mechanics, and relational style."
      ));

	      setText("hd-title", t("Human Design-signatur", "Human Design Signature"));
	      setText("zodiac-title", t("Kinesisk zodiak", "Chinese Zodiac"));
	      setText("synthesis-title", t("Praktisk vägledning", "Practical Guidance"));
	      setText("life-areas-title", t("Beslut, relationer, arbete, hälsa", "Decision, Relationships, Work, Health"));
	      setText("life-area-decision-title", t("Beslutstips", "Decision Tips"));
	      setText("life-area-relationships-title", t("Relationer", "Relationships"));
	      setText("life-area-work-title", t("Arbete", "Work"));
	      setText("life-area-health-title", t("Hälsa", "Health"));
	      setText("hd-modal-full-title", t("Human Design · Komplett modalinnehåll", "Human Design · Complete modal content"));
	      setText(
	        "hd-modal-full-note",
	        t(
	          "Detta block speglar innehållet i Human Design-modalens standalone-rapport, så allt finns samlat även i natalanalysrapporten.",
	          "This block mirrors the Human Design modal standalone report, so everything is also included in the Natal Analysis Report."
	        )
	      );
	      setText("hd-modal-essence-title", t("Essens", "Essence"));
	      setText(
	        "hd-modal-core-title",
	        t("Typ, strategi, auktoritet, profil, inkarnationskors", "Type, strategy, authority, profile, incarnation cross")
	      );
	      setText("hd-modal-report-for-title", t("Rapport för", "Report for"));
	      setText("hd-modal-defined-title", t("Definierade center", "Defined centers"));
	      setText("hd-modal-undefined-title", t("Odefinierade center", "Undefined centers"));
	      setText("hd-modal-channels-title", t("Definierade kanaler", "Defined channels"));
	      setText("hd-modal-gates-personality-title", t("Personlighet-gates", "Personality gates"));
	      setText("hd-modal-gates-design-title", t("Design-gates", "Design gates"));

      const hdTypeRaw = data?.humanDesign?.type;
      const hdStrategyRaw = data?.humanDesign?.strategy;
      const hdAuthorityRaw = data?.humanDesign?.authority;
      const hdProfileRaw = data?.humanDesign?.profile;
      const hdRoleRaw = data?.humanDesign?.role;
      const hdDefinitionRaw = data?.humanDesign?.definition;
      const hdCrossRaw = data?.humanDesign?.incarnationCross;
      const hdNotSelfRaw = data?.humanDesign?.notSelf;
      const hdSignatureRaw = data?.humanDesign?.signature;

      const hdType = localizeHdType(hdTypeRaw);
      const hdStrategy = localizeHdStrategy(hdStrategyRaw);
      const hdAuthority = localizeHdAuthority(hdAuthorityRaw);
      const hdDefinition = localizeHdDefinition(hdDefinitionRaw);
      const hdNotSelf = localizeHdNotSelf(hdNotSelfRaw);
      const hdSignature = localizeHdSignature(hdSignatureRaw);
      const hdCross = localizeHdCross(hdCrossRaw);
      const hdRole = localizeHdRole(hdRoleRaw);
      const hdProfileCode = rawText(hdProfileRaw);
      const hdProfileDisplay = [hdProfileCode, hdRole].filter(Boolean).join(" / ") || "—";

      const hdKv = document.getElementById("hd-kv");
      if (hdKv) {
        const items = [
          [t("Typ", "Type"), hdType],
          [t("Strategi", "Strategy"), hdStrategy],
          [t("Auktoritet", "Authority"), hdAuthority],
          [t("Profil", "Profile"), hdProfileDisplay],
          [t("Definition", "Definition"), hdDefinition],
          [t("Inkarnationskors", "Incarnation Cross"), hdCross],
          [t("Icke-jag-tema", "Not-Self"), hdNotSelf],
          [t("Signatur", "Signature"), hdSignature],
        ];
        hdKv.innerHTML = items
          .map(([label, value]) => `<div class="kv-item"><label>${esc(label)}</label><span>${esc(value)}</span></div>`)
          .join("");
      }

      const hdNote = document.getElementById("hd-note");
      if (hdNote) {
        hdNote.innerHTML = highlightAttributeText(t(
          "Din typ visar hur energin är byggd, strategin visar timing, och auktoriteten visar hur beslut blir rätt i kroppen. När de tre samspelar blir livet både lugnare och kraftfullare.",
          "Your type shows your energy mechanics, strategy shows timing, and authority shows decision alignment. When these work together, life gets both calmer and more powerful."
        ));
      }

      const hdDeep = document.getElementById("hd-deep");
      if (hdDeep) {
        const typeDetail = hdDetailText(
          hdTypeRaw,
          HD_TYPE_DETAIL_SV,
          "Din typ beskriver hur din livskraft fungerar mest naturligt i vardagen.",
          "Type describes how your life force works most naturally."
        );
        const strategyDetail = hdDetailText(
          hdStrategyRaw,
          HD_STRATEGY_DETAIL_SV,
          "Strategin beskriver rätt timing i kontakt med människor, arbete och möjligheter.",
          "Strategy describes timing in relationships, work, and opportunities."
        );
        const authorityDetail = hdDetailText(
          hdAuthorityRaw,
          HD_AUTHORITY_DETAIL_SV,
          "Auktoriteten visar hur du landar beslut som känns hållbara i längden.",
          "Authority shows how to make sustainable long-term decisions."
        );
        const definitionDetail = hdDetailText(
          hdDefinitionRaw,
          HD_DEFINITION_DETAIL_SV,
          "Definitionen visar hur dina energidelar kopplar ihop sig internt.",
          "Definition describes how your inner energetic circuitry connects."
        );
        const profileDetail = describeHdProfile(hdProfileRaw);
        const signalOne = hdNotSelf !== "—"
          ? t(
              `Varningssignal: ${hdNotSelf}. När den dyker upp är det ofta ett tecken på fel timing eller att beslut inte var i linje med auktoriteten.`,
              `Warning signal: ${hdNotSelf}. When this appears, timing or decision process is often off.`
            )
          : t(
              "Observera friktion i vardagen som vägvisare till vad som behöver justeras.",
              "Use daily friction as a signal for what needs adjustment."
            );
        const signalTwo = hdSignature !== "—"
          ? t(
              `Kompassignal: ${hdSignature}. När den känslan ökar brukar du vara på rätt spår.`,
              `Compass signal: ${hdSignature}. When this feeling increases, you are usually in alignment.`
            )
          : t(
              "Lägg märke till när beslut känns lugna och konsekventa över tid.",
              "Notice when decisions feel calm and consistent over time."
            );
        const signalThree = t(
          "Praktik: planera större beslut i två steg - först respons/auktoritet, sedan kommunikation till berörda.",
          "Practice: run big decisions in two steps - first authority response, then communication to affected people."
        );

        hdDeep.innerHTML = [
          `<article class="deep-block"><h4>${esc(t("Typens kärna", "Type core"))}</h4><p>${highlightAttributeText(typeDetail)}</p></article>`,
          `<article class="deep-block"><h4>${esc(t("Strategi och timing", "Strategy and timing"))}</h4><p>${highlightAttributeText(strategyDetail)}</p></article>`,
          `<article class="deep-block"><h4>${esc(t("Auktoritet och beslut", "Authority and decisions"))}</h4><p>${highlightAttributeText(authorityDetail)}</p></article>`,
          `<article class="deep-block"><h4>${esc(t("Profil och mognadsväg", "Profile and growth path"))}</h4><p>${highlightAttributeText(profileDetail)}</p></article>`,
          `<article class="deep-block"><h4>${esc(t("Definition och energi-flöde", "Definition and energy flow"))}</h4><p>${highlightAttributeText(definitionDetail)}</p></article>`,
          `<article class="deep-block"><h4>${esc(t("Praktiska signaler", "Practical signals"))}</h4><ul class="deep-list"><li>${highlightAttributeText(signalOne)}</li><li>${highlightAttributeText(signalTwo)}</li><li>${highlightAttributeText(signalThree)}</li></ul></article>`,
        ].join("");
      }

      const hdStandalone = document.getElementById("hd-standalone");
      if (hdStandalone) {
        const sourceSummary = data?.humanDesignStandalone?.summary || null;
        const sourceNarrative = rawText(data?.humanDesignStandalone?.narrative);
        if (!sourceSummary && !sourceNarrative) {
          hdStandalone.innerHTML = "";
        } else {
          const sourceChart = data?.humanDesignStandalone?.chart || null;
          const sourceType = localizeHdType(sourceSummary?.type);
          const sourceStrategy = localizeHdStrategy(sourceSummary?.strategy);
          const sourceAuthority = localizeHdAuthority(sourceSummary?.authority);
          const sourceProfile = rawText(sourceSummary?.profile) || "—";
          const sourceDefinition = localizeHdDefinition(sourceSummary?.definition);
          const sourceNotSelf = localizeHdNotSelf(sourceSummary?.notSelf);
          const sourceCross = localizeHdCross(sourceSummary?.incarnationCross);
          const sourceSignature = localizeHdSignature(data?.humanDesign?.signature);
          const sourceCenters = Array.isArray(sourceChart?.definedCenters)
            ? sourceChart.definedCenters.map((center) => localizeHdCenter(center))
            : [];
          const sourceChannels = Array.isArray(sourceChart?.activeChannels)
            ? sourceChart.activeChannels.slice(0, 10).map((channel) => {
                const gates = Array.isArray(channel?.gates) ? channel.gates.join("–") : "";
                const centersTxt = Array.isArray(channel?.centers)
                  ? channel.centers.map((center) => localizeHdCenter(center)).join(" ↔ ")
                  : "";
                return [gates, centersTxt].filter(Boolean).join(" • ");
              }).filter(Boolean)
            : [];
          const sourcePersonalityGates = Array.isArray(sourceChart?.personalityGates)
            ? sourceChart.personalityGates.slice(0, 12).map((gate) =>
                `${safe(gate?.gate)}${gate?.line ? `.${safe(gate?.line)}` : ""}`
              )
            : [];
          const sourceDesignGates = Array.isArray(sourceChart?.designGates)
            ? sourceChart.designGates.slice(0, 12).map((gate) =>
                `${safe(gate?.gate)}${gate?.line ? `.${safe(gate?.line)}` : ""}`
              )
            : [];
          const summaryLine = t(
            `Utdrag från Human Design-rapporten: typ ${sourceType}, strategi ${sourceStrategy}, auktoritet ${sourceAuthority}, profil ${sourceProfile}, definition ${sourceDefinition}.`,
            `Excerpt from the Human Design report: type ${sourceType}, strategy ${sourceStrategy}, authority ${sourceAuthority}, profile ${sourceProfile}, definition ${sourceDefinition}.`
          );
          const crossLine = t(
            `Inkarnationskors: ${sourceCross}.`,
            `Incarnation cross: ${sourceCross}.`
          );
          const interpretationRows = [
            {
              label: t("Typ", "Type"),
              value: sourceType,
              explanation: t(
                "Visar hur din energi fungerar över tid. Tolka detta som din grundmotor: hur du mår bäst när du använder kraft, återhämtning och fokus.",
                "Shows how your energy works over time. Read this as your baseline engine for effort, recovery, and focus."
              ),
            },
            {
              label: t("Strategi", "Strategy"),
              value: sourceStrategy,
              explanation: t(
                "Visar rätt timing i mötet med livet. Tolka strategin som när du ska agera för minst motstånd och bäst flyt.",
                "Shows timing for action. Read strategy as when to move for less resistance and better flow."
              ),
            },
            {
              label: t("Auktoritet", "Authority"),
              value: sourceAuthority,
              explanation: t(
                "Visar hur du fattar hållbara beslut. Tolka detta som din inre beslutsmetod, särskilt vid större val.",
                "Shows how to make sustainable decisions. Read this as your internal decision method, especially for bigger choices."
              ),
            },
            {
              label: t("Profil", "Profile"),
              value: sourceProfile,
              explanation: t(
                "Visar din lärstil och sociala roll. Tolka profilen som hur du utvecklas genom relationer, erfarenheter och livsfaser.",
                "Shows your learning style and social role. Read profile as how you grow through relationships, experience, and phases."
              ),
            },
            {
              label: t("Definition", "Definition"),
              value: sourceDefinition,
              explanation: t(
                "Visar hur dina center är kopplade internt. Tolka detta som hur självständigt du processar energi och när du behöver rätt miljö för klarhet.",
                "Shows how your centers connect internally. Read this as how independently you process energy and when context supports clarity."
              ),
            },
            {
              label: t("Icke-jag-tema", "Not-Self"),
              value: sourceNotSelf,
              explanation: t(
                "Visar varningssignal vid fel timing. Tolka detta som ett tidigt tecken på att något behöver justeras i riktning, tempo eller beslut.",
                "Shows a warning signal when timing is off. Read this as an early cue to adjust direction, pace, or decision process."
              ),
            },
            {
              label: t("Signatur", "Signature"),
              value: sourceSignature,
              explanation: t(
                "Visar känslan av att vara i linje. Tolka detta som din kompass för när vardagen faktiskt fungerar rätt för dig.",
                "Shows the feeling of alignment. Read this as your compass for when daily life is working in a correct way for you."
              ),
            },
            {
              label: t("Inkarnationskors", "Incarnation Cross"),
              value: sourceCross,
              explanation: t(
                "Visar ett övergripande livstema. Tolka detta som den berättelse som ofta återkommer i olika livsområden över tid.",
                "Shows an overarching life theme. Read this as the repeating storyline across life areas over time."
              ),
            },
          ];
          const practicalDecision = t(
            `Beslut: använd ${sourceAuthority} som metod och ${sourceStrategy} som timing. Om något är oklart, vänta tills kroppens signal är stabil.`,
            `Decisions: use ${sourceAuthority} as method and ${sourceStrategy} as timing. If unclear, wait until your body signal is stable.`
          );
          const practicalRelationship = t(
            "Relationer: tolkningen blir starkast när du först hedrar din egen rytm. Rätt personer känns ofta tydliga utan att du behöver forcera.",
            "Relationships: interpretation is strongest when you honor your own rhythm first. Right people usually feel clear without forcing."
          );
          const practicalWork = t(
            "Arbete: välj roller och miljöer där din typ och strategi får styra arbetsflödet. Då ökar både kvalitet och hållbar energi.",
            "Work: choose roles and environments where type and strategy shape your workflow. This improves both quality and sustainable energy."
          );
          const practicalHealth = t(
            "Hälsa: följ kroppens tempo. Icke-jag-temat fungerar som tidig signal om överstyrning, och signaturen visar när du är tillbaka i balans.",
            "Health: follow your body pace. Not-Self is an early signal of strain, and Signature shows when you are back in balance."
          );
          const centersLine = sourceCenters.length
            ? t(
                `Definierade center: ${sourceCenters.join(", ")}. Tolka definierade center som stabila resurser du kan luta dig mot.`,
                `Defined centers: ${sourceCenters.join(", ")}. Read defined centers as stable resources you can rely on.`
              )
            : t(
                "Inga definierade center registrerade. Tolka detta som att miljö och relationer blir extra viktiga för dagsform och klarhet.",
                "No defined centers registered. Read this as environment and relationships being especially important for daily clarity."
              );
          const channelsLine = sourceChannels.length
            ? t(
                `Aktiva kanaler: ${sourceChannels.join(", ")}. Tolka kanaler som återkommande styrkor där energi naturligt vill röra sig.`,
                `Active channels: ${sourceChannels.join(", ")}. Read channels as recurring strengths where energy naturally wants to move.`
              )
            : t(
                "Inga aktiva kanaler registrerade i utdraget. Tolka detta som att fokus ligger mer på timing och kontext än på fasta energimönster i detta underlag.",
                "No active channels were registered in this excerpt. Read this as timing and context carrying more weight than fixed channel patterns in this data."
              );
          const gatesLine = t(
            `Personlighets-gates: ${sourcePersonalityGates.length ? sourcePersonalityGates.join(", ") : "—"} | Design-gates: ${sourceDesignGates.length ? sourceDesignGates.join(", ") : "—"}. Tolka gate.numret som tema och linjen (.1-.6) som hur temat uttrycks i praktiken.`,
            `Personality gates: ${sourcePersonalityGates.length ? sourcePersonalityGates.join(", ") : "—"} | Design gates: ${sourceDesignGates.length ? sourceDesignGates.join(", ") : "—"}. Read gate number as theme and line (.1-.6) as expression style.`
          );
          hdStandalone.innerHTML = [
            `<article class="deep-block"><h4>${esc(t("Rapportutdrag", "Report excerpt"))}</h4><p>${highlightAttributeText(summaryLine)}</p></article>`,
            sourceNarrative
              ? `<article class="deep-block"><h4>${esc(t("Narrativ från HD-rapport", "Narrative from HD report"))}</h4><p>${highlightAttributeText(sourceNarrative)}</p></article>`
              : "",
            `<article class="deep-block"><h4>${esc(t("Tolkning del för del", "How To Interpret Each Part"))}</h4><ul class="deep-list">${interpretationRows.map((row) => `<li><strong>${esc(row.label)}:</strong> ${highlightAttributeText(`${row.value}. ${row.explanation}`)}</li>`).join("")}</ul></article>`,
            `<article class="deep-block"><h4>${esc(t("Från rapport till vardag", "From Report To Daily Life"))}</h4><ul class="deep-list"><li>${highlightAttributeText(practicalDecision)}</li><li>${highlightAttributeText(practicalRelationship)}</li><li>${highlightAttributeText(practicalWork)}</li><li>${highlightAttributeText(practicalHealth)}</li></ul></article>`,
            `<article class="deep-block"><h4>${esc(t("Center, kanaler och gates", "Centers, Channels, and Gates"))}</h4><ul class="deep-list"><li>${highlightAttributeText(centersLine)}</li><li>${highlightAttributeText(channelsLine)}</li><li>${highlightAttributeText(gatesLine)}</li></ul></article>`,
            `<article class="deep-block"><h4>${esc(t("Livstema", "Life theme"))}</h4><p>${highlightAttributeText(crossLine)}</p></article>`,
          ]
            .filter(Boolean)
            .join("");
        }
      }

      const centers = Array.isArray(data?.humanDesign?.definedCenters) ? data.humanDesign.definedCenters : [];
      const centerTags = document.getElementById("center-tags");
      if (centerTags) {
        centerTags.innerHTML = centers.length
          ? centers.map((center) => `<span class="tag">${esc(localizeHdCenter(center))}</span>`).join("")
          : `<span class="tag">${esc(t("Inga definierade center registrerade", "No defined centers registered"))}</span>`;
      }

      const channels = Array.isArray(data?.humanDesign?.channels) ? data.humanDesign.channels : [];
      const channelTags = document.getElementById("channel-tags");
      if (channelTags) {
        channelTags.innerHTML = channels.length
          ? channels.slice(0, 18).map((channel) => {
              const gates = Array.isArray(channel?.gates) ? channel.gates.join("-") : "";
              const centersTxt = Array.isArray(channel?.centers) && channel.centers.length
                ? ` (${channel.centers.map((center) => localizeHdCenter(center)).join(" ↔ ")})`
                : "";
              return `<span class="tag">${esc(`${gates}${centersTxt}`)}</span>`;
            }).join("")
          : `<span class="tag">${esc(t("Inga aktiva kanaler registrerade", "No active channels registered"))}</span>`;
      }

      const zodiacAnimal = localizeZodiacAnimal(data?.chineseZodiac?.animal);
      const zodiacElement = localizeZodiacElement(data?.chineseZodiac?.element);
      const zodiacYinYang = localizeZodiacYinYang(data?.chineseZodiac?.yinYang);
      const zodiacTrine = localizeZodiacTrine(data?.chineseZodiac?.trine);
      const zodiacRawAnimal = rawText(data?.chineseZodiac?.animal);
      const zodiacKey = resolveZodiacKey(zodiacRawAnimal || zodiacAnimal);
      const zodiacIcon = ZODIAC_ICON[zodiacKey] || "🐉";
      const zodiacChar = rawText(data?.chineseZodiac?.animalChar) || ZODIAC_CHAR[zodiacKey] || "龍";
      const zodiacAnimalPinyin = ZODIAC_PINYIN[zodiacKey] || "";
      const zodiacElementKey = resolveElementKey(data?.chineseZodiac?.element || zodiacElement);
      const zodiacElementCn = ZODIAC_ELEMENT_CN[zodiacElementKey] || "—";
      const zodiacYinYangKey = resolveYinYangKey(data?.chineseZodiac?.yinYang || zodiacYinYang);
      const zodiacYinYangCn = ZODIAC_YINYANG_CN[zodiacYinYangKey] || "—";
      const zodiacTrineKey = resolveTrineKey(data?.chineseZodiac?.trine || zodiacTrine, zodiacKey);
      const zodiacTrineCn = ZODIAC_TRINE_CN[zodiacTrineKey] || "—";
      const zodiacEarthlyBranch = rawText(data?.chineseZodiac?.earthlyBranch) || ZODIAC_EARTHLY_BRANCH[zodiacKey] || "—";
      const zodiacStyle = isSwedish
        ? ZODIAC_STYLE_SV_KEY[zodiacKey] || ZODIAC_STYLE_SV[rawText(data?.chineseZodiac?.animal)] || "ett eget socialt grundtempo"
        : "a distinct social baseline";

      const zodiacKv = document.getElementById("zodiac-kv");
      if (zodiacKv) {
        const items = [
          [t("Årsdjur", "Year animal"), `${zodiacAnimal} · ${zodiacChar}${zodiacAnimalPinyin ? ` (${zodiacAnimalPinyin})` : ""}`],
          ["Yin/Yang", `${zodiacYinYang} · ${zodiacYinYangCn}`],
          [t("Element", "Element"), `${zodiacElement} · ${zodiacElementCn}`],
          [t("Trigon", "Trine"), `${zodiacTrine} · ${zodiacTrineCn}`],
          [t("Jordgren", "Earthly branch"), zodiacEarthlyBranch],
          [t("Tecken", "Character"), `${zodiacChar}${zodiacAnimalPinyin ? ` (${zodiacAnimalPinyin})` : ""}`],
        ];
        zodiacKv.innerHTML = items
          .map(([label, value]) => `<div class="kv-item"><label>${esc(label)}</label><span>${esc(value)}</span></div>`)
          .join("");
      }

      const zodiacExplain = document.getElementById("zodiac-explain");
      if (zodiacExplain) {
        const explainItems = [
          {
            label: t("Årsdjur", "Year animal"),
            value: `${zodiacAnimal} · ${zodiacChar}${zodiacAnimalPinyin ? ` (${zodiacAnimalPinyin})` : ""}`,
            text: t(
              `Årsdjuret beskriver din sociala grundton. För ${zodiacAnimal} betyder det ofta hur du spontant tar plats, bygger relationer och reagerar när tempot ökar.`,
              `The year animal describes your social baseline. For ${zodiacAnimal}, this often shows how you naturally enter groups, build bonds, and react under pressure.`
            ),
          },
          {
            label: "Yin/Yang",
            value: `${zodiacYinYang} · ${zodiacYinYangCn}`,
            text: t(
              `${zodiacYinYang} visar energins riktning: mer mottagande och inåtvänd (Yin) eller mer utåtriktad och initierande (Yang). Tolka detta som din naturliga startväxel i vardagen.`,
              `${zodiacYinYang} shows energy direction: more receptive and inward (Yin) or more outward and initiating (Yang). Read this as your natural starting gear in daily life.`
            ),
          },
          {
            label: t("Element", "Element"),
            value: `${zodiacElement} · ${zodiacElementCn}`,
            text: t(
              `Elementet färgar temperament och stressrespons. ${zodiacElement} visar hur energi byggs, hålls och släpps över tid - i arbete, relationer och återhämtning.`,
              `The element colors temperament and stress response. ${zodiacElement} indicates how energy is built, sustained, and released over time in work, relationships, and recovery.`
            ),
          },
          {
            label: t("Trigon", "Trine"),
            value: `${zodiacTrine} · ${zodiacTrineCn}`,
            text: t(
              "Trigon visar vilken tregrupp i zodiaken du tillhör (sanhe). Det säger något om vilka sociala rytmer och samarbetsmönster som brukar kännas mest naturliga.",
              "Trine shows your three-animal alliance group (sanhe). It indicates which social rhythms and collaboration styles tend to feel most natural."
            ),
          },
          {
            label: t("Jordgren", "Earthly branch"),
            value: zodiacEarthlyBranch,
            text: t(
              "Jordgrenen är den klassiska kinesiska markören i 12-cykeln. För den erfarna läsaren kopplar den till timing, säsongskvalitet och underliggande rörelse i livsfasen.",
              "Earthly branch is the classical marker in the 12-cycle. For advanced reading, it links to timing, seasonal quality, and underlying life-phase movement."
            ),
          },
        ];
        zodiacExplain.innerHTML = explainItems
          .map((item) =>
            `<article class="zodiac-explain-item"><p class="zodiac-explain-head">${esc(item.label)}</p><p class="zodiac-explain-value">${highlightAttributeText(item.value)}</p><p class="zodiac-explain-text">${highlightAttributeText(item.text)}</p></article>`
          )
          .join("");
      }

      setText("zodiac-icon", zodiacIcon);
      setText("zodiac-char-large", zodiacChar);
      setText("zodiac-animal-line", zodiacAnimal);
      const zodiacMetaBits = [
        zodiacElement !== "—" ? zodiacElement : "",
        zodiacYinYang !== "—" ? zodiacYinYang : "",
        zodiacTrine !== "—" ? `${zodiacTrine} ${t("trigon", "trine")}` : "",
      ].filter(Boolean);
      setText(
        "zodiac-meta-line",
        zodiacMetaBits.length
          ? zodiacMetaBits.join(" · ")
          : t("Social arketyp från den kinesiska zodiaken", "Social archetype from the Chinese zodiac")
      );
      setHighlightedText(
        "zodiac-style-line",
        t(
          `Arketyp: ${zodiacStyle}.`,
          `Archetype: ${zodiacStyle}.`
        )
      );
      setHighlightedText("zodiac-note", t(
        `I sociala skiften visar ${zodiacAnimal} ofta ${zodiacStyle}. Se detta som din naturliga startpunkt, inte som en begränsning.`,
        `In social transitions, ${zodiacAnimal} often shows ${zodiacStyle}. Treat this as a natural baseline, not a limitation.`
      ));

      const synthesis = document.getElementById("synthesis-list");
      if (synthesis) {
        const points = buildSynthesis();
        synthesis.innerHTML = points.length
          ? points.map((p) => `<li>${highlightAttributeText(p)}</li>`).join("")
          : `<li>${esc(t("Spara profil och kör ny beräkning för full vägledning.", "Save profile and recalculate for full guidance."))}</li>`;
      }

	      const lifeAreaName = displayName || t("du", "you");
	      const lifeAreaDecision = isSwedish
	        ? `${lifeAreaName}, använd ${hdAuthority} som beslutsrytm. Om du är osäker: sakta ner. Det tydligaste ja:et är det som fortfarande känns sant efter att känslan har lagt sig.`
	        : `${lifeAreaName}, use ${hdAuthority} as your decision rhythm. If you’re unsure, slow down. Your clearest yes is the one that stays true after the emotional tide passes.`;
	      const lifeAreaRelationships = isSwedish
	        ? `${lifeAreaName}, du blir mest magnetisk när du inte försöker prestera en roll. Låt rätt människor känna igen dig först och svara därifrån.`
	        : `${lifeAreaName}, you’re most magnetic when you’re not performing. Let the right people recognize you first - then respond.`;
	      const lifeAreaWork = isSwedish
	        ? `${lifeAreaName}, arbetet flyter bäst i roller som respekterar din strategi och ger dig utrymme att förfina och påverka med kvalitet.`
	        : `${lifeAreaName}, work thrives when you’re in the right role. Choose environments that respect your strategy and give you room to refine, guide, and shape outcomes.`;
	      const lifeAreaHealth = isSwedish
	        ? `${lifeAreaName}, kroppen är din sanningsmätare. När du är i linje känns energin ren och hållbar. När du är ur linje signalerar kroppen det tidigt.`
	        : `${lifeAreaName}, your body is your truth barometer. When you’re aligned, energy feels clean and sustainable. When you’re off, your body signals it early.`;
      setHighlightedText("life-area-decision", lifeAreaDecision);
      setHighlightedText("life-area-relationships", lifeAreaRelationships);
      setHighlightedText("life-area-work", lifeAreaWork);
      setHighlightedText("life-area-health", lifeAreaHealth);

	      const setListHtml = (id, items) => {
	        const el = document.getElementById(id);
	        if (!el) return;
	        const rows = Array.isArray(items)
	          ? items.map((item) => rawText(item)).filter(Boolean)
	          : [];
	        el.innerHTML = rows.length
	          ? rows.map((row) => `<li>${esc(row)}</li>`).join("")
	          : `<li>${esc("—")}</li>`;
	      };

	      const modalSummary = data?.humanDesignStandalone?.summary || {};
	      const modalChart = data?.humanDesignStandalone?.chart || {};
	      const modalType = localizeHdType(modalSummary?.type || hdTypeRaw);
	      const modalStrategy = localizeHdStrategy(modalSummary?.strategy || hdStrategyRaw);
	      const modalAuthority = localizeHdAuthority(modalSummary?.authority || hdAuthorityRaw);
	      const modalProfile = rawText(modalSummary?.profile || hdProfileRaw) || "—";
	      const modalDefinition = localizeHdDefinition(modalSummary?.definition || hdDefinitionRaw);
	      const modalNotSelf = localizeHdNotSelf(modalSummary?.notSelf || hdNotSelfRaw);
	      const modalCross = localizeHdCross(modalSummary?.incarnationCross || hdCrossRaw);
	      const modalName = rawText(data?.user?.username) || rawText(data?.user?.name) || t("du", "you");
	      const modalEssence = isSwedish
	        ? `${modalName}, din Human Design-karta fungerar som en levande kompass. Som ${modalType} rör sig din energi bäst i rätt timing, inte genom att forcera. När du följer din strategi (${String(modalStrategy).toLowerCase()}) uppstår mer flyt och färre onödiga stopp.`
	        : `${modalName}, your Human Design chart acts as a living compass. As a ${modalType}, your energy moves best in right timing, not by force. When you follow your strategy (${String(modalStrategy).toLowerCase()}), life gains flow with less friction.`;
      setHighlightedText("hd-modal-essence", modalEssence);

	      const modalCoreKv = document.getElementById("hd-modal-core-kv");
	      if (modalCoreKv) {
	        modalCoreKv.innerHTML = [
	          [t("Typ", "Type"), modalType],
	          [t("Strategi", "Strategy"), modalStrategy],
	          [t("Auktoritet", "Authority"), modalAuthority],
	          [t("Profil", "Profile"), modalProfile],
	          [t("Definition", "Definition"), modalDefinition],
	          [t("Icke-jag-tema", "Not-Self"), modalNotSelf],
	          [t("Inkarnationskors", "Incarnation Cross"), modalCross],
	        ]
	          .map(([label, value]) => `<div class="kv-item"><label>${esc(label)}</label><span>${esc(value || "—")}</span></div>`)
	          .join("");
	      }

	      const modalDefinedCentersRaw = Array.isArray(modalChart?.definedCenters)
	        ? modalChart.definedCenters
	        : Array.isArray(data?.humanDesign?.definedCenters)
	          ? data.humanDesign.definedCenters
	          : [];
	      const modalDefinedCenterKeys = Array.from(
	        new Set(
	          modalDefinedCentersRaw
	            .map((center) => normalizeHdCenterKey(center))
	            .filter(Boolean)
	        )
	      );
	      const allCenterKeys = ["head", "ajna", "throat", "g", "ego", "spleen", "sacral", "solar", "root"];
	      const modalUndefinedCenterKeys = allCenterKeys.filter((key) => !modalDefinedCenterKeys.includes(key));
	      setListHtml("hd-modal-defined-list", modalDefinedCenterKeys.map((key) => localizeHdCenter(key)));
	      setListHtml("hd-modal-undefined-list", modalUndefinedCenterKeys.map((key) => localizeHdCenter(key)));

	      const modalChannelsRaw = Array.isArray(modalChart?.activeChannels)
	        ? modalChart.activeChannels
	        : Array.isArray(data?.humanDesign?.channels)
	          ? data.humanDesign.channels
	          : [];
	      const modalChannels = modalChannelsRaw
	        .map((channel) => {
	          const gates = Array.isArray(channel?.gates)
	            ? channel.gates.map((gate) => Number(gate)).filter(Number.isFinite).join("–")
	            : "";
	          const centersTxt = Array.isArray(channel?.centers)
	            ? channel.centers.map((center) => localizeHdCenter(center)).filter(Boolean).join(" ↔ ")
	            : "";
	          return [gates, centersTxt].filter(Boolean).join(" · ");
	        })
	        .filter(Boolean);
	      setListHtml("hd-modal-channels-list", modalChannels);

	      const modalPersonalityGatesRaw = Array.isArray(modalChart?.personalityGates) ? modalChart.personalityGates : [];
	      const modalDesignGatesRaw = Array.isArray(modalChart?.designGates) ? modalChart.designGates : [];
	      const modalPersonalityGates = modalPersonalityGatesRaw
	        .map((gate) => `${safe(gate?.gate)}${gate?.line ? `.${safe(gate?.line)}` : ""}`)
	        .filter((gate) => gate && gate !== "—");
	      const modalDesignGates = modalDesignGatesRaw
	        .map((gate) => `${safe(gate?.gate)}${gate?.line ? `.${safe(gate?.line)}` : ""}`)
	        .filter((gate) => gate && gate !== "—");
	      setListHtml("hd-modal-gates-personality-list", modalPersonalityGates);
	      setListHtml("hd-modal-gates-design-list", modalDesignGates);

	      const formatUtcOffset = (minutesValue) => {
	        const minutes = Number(minutesValue);
	        if (!Number.isFinite(minutes)) return "—";
	        const sign = minutes >= 0 ? "+" : "-";
	        const abs = Math.abs(minutes);
	        const hours = Math.floor(abs / 60);
	        const rem = abs % 60;
	        return `UTC${sign}${hours}${rem ? `:${String(rem).padStart(2, "0")}` : ""}`;
	      };
	      const formatCoord = (value, positive, negative) => {
	        const num = Number(value);
	        if (!Number.isFinite(num)) return "—";
	        const dir = num >= 0 ? positive : negative;
	        return `${Math.abs(num).toFixed(4)}° ${dir}`;
	      };
	      const modalReportFor = [
	        `${t("Födelsedatum", "Date of birth")}: ${safe(data?.user?.birthDate)}`,
	        `${t("Födelsetid", "Time of birth")}: ${safe(data?.user?.birthTime)}`,
	        `${t("UTC-offset", "UTC offset")}: ${formatUtcOffset(data?.user?.tzOffsetMinutes)}`,
	        `${t("Födelseort", "City of birth")}: ${safe(shortBirthPlace(data?.user?.birthPlace) || "—")}`,
	        `${t("Koordinater", "Coordinates")}: ${(() => {
	          const lat = formatCoord(data?.user?.lat, "N", "S");
	          const lng = formatCoord(data?.user?.lng, "E", "W");
	          return lat !== "—" && lng !== "—" ? `${lat}, ${lng}` : "—";
	        })()}`,
	        `${t("Rapport genererad", "Report generated")}: ${fmtDate(data?.generatedAt)}`,
	      ];
	      setListHtml("hd-modal-report-for-list", modalReportFor);

	      setText("report-guide-title", t("Så läser du rapporten", "How to read this report"));
	      setText("guide-beginner-title", t("För dig som är ny", "Beginner interpretation"));
	      setText("guide-expert-title", t("För dig som är expert", "Expert interpretation"));
      setText("report-tables-title", t("Charts och tabeller", "Charts and tables"));
      setText("table-planets-title", t("Astrologi · Planetplaceringar", "Astrology · Planet placements"));
      setText("table-aspects-title", t("Astrologi · Aspekter", "Astrology · Aspects"));
      setText("table-houses-title", t("Astrologi · Hus", "Astrology · Houses"));
      setText("table-centers-title", t("Human Design · Center", "Human Design · Centers"));
      setText("table-channels-title", t("Human Design · Kanaler", "Human Design · Channels"));
      setText("table-gates-title", t("Human Design · Gates", "Human Design · Gates"));
      setText("table-zodiac-title", t("Kinesisk zodiak · Översikt", "Chinese Zodiac · Overview"));

      const renderParagraphs = (id, paragraphs) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = (paragraphs || [])
          .filter(Boolean)
          .map((paragraph) => `<p>${highlightAttributeText(paragraph)}</p>`)
          .join("");
      };

      const renderTable = (id, columns, rows) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (!rows || !rows.length) {
          el.innerHTML = `<p class="table-empty">${esc(t("Ingen data tillgänglig i detta underlag.", "No data available in this dataset."))}</p>`;
          return;
        }
        el.innerHTML = `
          <table class="data-table">
            <thead>
              <tr>${columns.map((column) => `<th>${esc(column)}</th>`).join("")}</tr>
            </thead>
            <tbody>
              ${rows
                .map((row) => `<tr>${row.map((cell) => `<td>${esc(cell)}</td>`).join("")}</tr>`)
                .join("")}
            </tbody>
          </table>
        `;
      };

      const beginnerParagraphs = [
        t(
          `Börja med kärnan: Sol i ${localizeSign(data?.astrology?.sun)}, Måne i ${localizeSign(data?.astrology?.moon)} och Ascendent i ${localizeSign(data?.astrology?.ascendant)}. De tre berättar vem personen är, hur känslor regleras och hur omgivningen först uppfattar energin.`,
          `Start with the core triad: Sun in ${localizeSign(data?.astrology?.sun)}, Moon in ${localizeSign(data?.astrology?.moon)}, and Ascendant in ${localizeSign(data?.astrology?.ascendant)}. Together they describe identity, emotional rhythm, and first impression.`
        ),
        t(
          `Gå sedan till Human Design: typ ${localizeHdType(data?.humanDesign?.type)}, strategi ${localizeHdStrategy(data?.humanDesign?.strategy)} och auktoritet ${localizeHdAuthority(data?.humanDesign?.authority)}. Läs detta som en praktisk beslutsmanual: hur personen får bäst timing och minst friktion i vardagen.`,
          `Then move to Human Design: type ${localizeHdType(data?.humanDesign?.type)}, strategy ${localizeHdStrategy(data?.humanDesign?.strategy)}, and authority ${localizeHdAuthority(data?.humanDesign?.authority)}. Read this as a practical decision manual for timing and reduced friction.`
        ),
        t(
          `Använd tabellerna stegvis: planettabellen visar tema per planet, aspekt-tabellen visar inre dialoger mellan teman, och center/kanaler/gates visar var energin är stabil respektive känslig för påverkan.`,
          `Use the tables in sequence: planet table for themes, aspect table for internal dialogues, and center/channel/gate tables for stable vs sensitive energetic zones.`
        ),
        t(
          `Slutligen: kinesisk zodiak med ${localizeZodiacAnimal(data?.chineseZodiac?.animal)} och ${localizeZodiacElement(data?.chineseZodiac?.element)} ger social ton och stressrespons. Tolka det som bakgrundstempo, inte som ett låst öde.`,
          `Finally: Chinese zodiac with ${localizeZodiacAnimal(data?.chineseZodiac?.animal)} and ${localizeZodiacElement(data?.chineseZodiac?.element)} adds social tone and stress response. Treat it as baseline rhythm, not fixed fate.`
        ),
      ];

      const expertParagraphs = [
        t(
          `Expertläsning: prioritera korrelation mellan dominant sign/house, HD-definition (${localizeHdDefinition(data?.humanDesign?.definition)}) och antal definierade center (${Array.isArray(data?.humanDesign?.definedCenters) ? data.humanDesign.definedCenters.length : 0}). Det ger kärnmodell för autonomi kontra kontextberoende.`,
          `Expert read: prioritize correlation between dominant sign/house, HD definition (${localizeHdDefinition(data?.humanDesign?.definition)}), and defined center count (${Array.isArray(data?.humanDesign?.definedCenters) ? data.humanDesign.definedCenters.length : 0}). This forms the autonomy vs context-dependency model.`
        ),
        t(
          `Synka beslutslagret: auktoritet (${localizeHdAuthority(data?.humanDesign?.authority)}) ska valideras mot icke-jag-tema (${localizeHdNotSelf(data?.humanDesign?.notSelf)}) och signatur (${localizeHdSignature(data?.humanDesign?.signature)}). Diskrepans mellan dessa tre markerar fel timing eller miljömissmatch.`,
          `Synchronize decision layer: authority (${localizeHdAuthority(data?.humanDesign?.authority)}) should be validated against Not-Self (${localizeHdNotSelf(data?.humanDesign?.notSelf)}) and Signature (${localizeHdSignature(data?.humanDesign?.signature)}). Divergence marks mistiming or environmental mismatch.`
        ),
        t(
          `Aspekt- och kanalnivå: jämför ledande aspekter med aktiva kanaler för att se om psykologisk dynamik har energimässig bäring. När båda pekar åt samma håll ökar prediktiv stabilitet i tolkningen.`,
          `Aspect/channel layer: compare leading aspects with active channels to test whether psychological dynamics have energetic backing. Convergence increases interpretive stability.`
        ),
        t(
          `Inkarnationskors (${localizeHdCross(data?.humanDesign?.incarnationCross || data?.humanDesign?.incarnationCrossRaw)}) används här som långcykliskt tema. Läs det inte isolerat, utan som överliggande riktning som filtreras genom profil, definition och social kontext.`,
          `Incarnation Cross (${localizeHdCross(data?.humanDesign?.incarnationCross || data?.humanDesign?.incarnationCrossRaw)}) is used here as long-cycle thematic axis. Do not read it in isolation; interpret it through profile, definition, and social context.`
        ),
      ];

      renderParagraphs("guide-beginner-body", beginnerParagraphs);
      renderParagraphs("guide-expert-body", expertParagraphs);

      const planetsRows = (Array.isArray(data?.astrology?.planets) ? data.astrology.planets : []).map((planet) => [
        localizePlanet(planet?.name || ""),
        localizeSign(planet?.sign || null),
        Number.isFinite(Number(planet?.house)) ? houseLabel(Number(planet.house)) : "—",
        safe(planet?.degree),
        planet?.retrograde ? t("Ja", "Yes") : t("Nej", "No"),
      ]);
      renderTable(
        "table-planets",
        [t("Planet", "Planet"), t("Tecken", "Sign"), t("Hus", "House"), t("Grad", "Degree"), t("Retrograd", "Retrograde")],
        planetsRows
      );

      const aspectRows = (Array.isArray(data?.astrology?.aspects) ? data.astrology.aspects : []).slice(0, 36).map((aspect) => [
        localizePlanet(aspect?.a || ""),
        safe(aspect?.type || t("Aspekt", "Aspect")),
        localizePlanet(aspect?.b || ""),
        typeof aspect?.orb === "number" ? `${Number(aspect.orb).toFixed(2)}°` : "—",
      ]);
      renderTable(
        "table-aspects",
        [t("Punkt A", "Point A"), t("Aspekt", "Aspect"), t("Punkt B", "Point B"), "Orb"],
        aspectRows
      );

      const housesRows = (Array.isArray(data?.astrology?.houses) ? data.astrology.houses : []).map((house) => [
        safe(house?.house),
        localizeSign(house?.sign || null),
        typeof house?.lon === "number" ? `${Number(house.lon).toFixed(2)}°` : "—",
        houseTheme(house?.house),
      ]);
      renderTable(
        "table-houses",
        [t("Hus", "House"), t("Tecken", "Sign"), t("Longitud", "Longitude"), t("Tema", "Theme")],
        housesRows
      );

      const centerThemes = {
        head: t("Inspiration, frågor och mentalt tryck.", "Inspiration, questions, and mental pressure."),
        ajna: t("Begrepp, analys och inre logik.", "Conceptual processing and inner logic."),
        throat: t("Uttryck, kommunikation och timing i handling.", "Expression, communication, and timing of action."),
        g: t("Identitet, riktning och kärlekens kompass.", "Identity, direction, and the compass of love."),
        ego: t("Vilja, löfte och resurshantering.", "Willpower, commitment, and resource handling."),
        spleen: t("Instinkt, immunitet och nu-säkerhet.", "Instinct, immunity, and present-moment safety."),
        sacral: t("Livskraft, arbete och hållbar energi.", "Life force, work capacity, and sustainable energy."),
        solar: t("Känslovåg, behov och emotionell klarhet.", "Emotional wave, needs, and emotional clarity."),
        root: t("Stressmotor, drift och underliggande tryck.", "Stress motor, drive, and baseline pressure."),
      };
      const definedSet = new Set(
        (Array.isArray(data?.humanDesign?.definedCenters) ? data.humanDesign.definedCenters : [])
          .map((center) => norm(center))
      );
      const allCenters = ["head", "ajna", "throat", "g", "ego", "spleen", "sacral", "solar", "root"];
      const centerRows = allCenters.map((center) => {
        const isDefined = definedSet.has(norm(center));
        return [
          localizeHdCenter(center),
          isDefined ? t("Definierad", "Defined") : t("Odefinierad", "Undefined"),
          centerThemes[center],
          isDefined
            ? t("Tolka som stabil resurs och konsekvent uttryck.", "Interpret as stable resource and consistent expression.")
            : t("Tolka som lärzon där miljö och relationer påverkar mer.", "Interpret as learning zone with stronger environmental influence."),
        ];
      });
      renderTable(
        "table-centers",
        [t("Center", "Center"), t("Status", "Status"), t("Nyckeltema", "Key Theme"), t("Tolkning", "Interpretation")],
        centerRows
      );

      const channelRows = (Array.isArray(data?.humanDesign?.channels) ? data.humanDesign.channels : [])
        .slice(0, 24)
        .map((channel) => {
          const gates = Array.isArray(channel?.gates) ? channel.gates.join("–") : "—";
          const centersTxt = Array.isArray(channel?.centers)
            ? channel.centers.map((center) => localizeHdCenter(center)).join(" ↔ ")
            : "—";
          return [
            gates,
            centersTxt,
            t("Återkommande energibana mellan center.", "Recurring energetic pathway between centers."),
          ];
        });
      renderTable(
        "table-channels",
        [t("Gate-par", "Gate Pair"), t("Center-koppling", "Center Link"), t("Tolkning", "Interpretation")],
        channelRows
      );

      const pGates = Array.isArray(data?.humanDesignStandalone?.chart?.personalityGates)
        ? data.humanDesignStandalone.chart.personalityGates
        : [];
      const dGates = Array.isArray(data?.humanDesignStandalone?.chart?.designGates)
        ? data.humanDesignStandalone.chart.designGates
        : [];
      const maxGateRows = Math.max(pGates.length, dGates.length, 1);
      const gateRows = Array.from({ length: maxGateRows }, (_, idx) => {
        const p = pGates[idx];
        const d = dGates[idx];
        const pText = p ? `${safe(p.gate)}${p.line ? `.${safe(p.line)}` : ""}` : "—";
        const dText = d ? `${safe(d.gate)}${d.line ? `.${safe(d.line)}` : ""}` : "—";
        const pPlanet = p ? safe(p.planet) : "—";
        const dPlanet = d ? safe(d.planet) : "—";
        const interpretation = t(
          "Gate-nummer visar huvudtema; linjen (.1-.6) visar uttrycksnivå i vardagen.",
          "Gate number shows core theme; line (.1-.6) shows expression style in daily life."
        );
        return [pText, pPlanet, dText, dPlanet, interpretation];
      });
      renderTable(
        "table-gates",
        [t("Personlighet", "Personality"), t("Planet (P)", "Planet (P)"), t("Design", "Design"), t("Planet (D)", "Planet (D)"), t("Tolkning", "Interpretation")],
        gateRows
      );

      const zodiacRows = [
        [t("Årsdjur", "Year animal"), localizeZodiacAnimal(data?.chineseZodiac?.animal), t("Social grundton och instinktiv stil.", "Social baseline and instinctive style.")],
        ["Yin/Yang", localizeZodiacYinYang(data?.chineseZodiac?.yinYang), t("Visar om uttrycket tenderar mer mottagande eller utåtriktat.", "Indicates whether expression tends toward receptive or outward style.")],
        [t("Element", "Element"), localizeZodiacElement(data?.chineseZodiac?.element), t("Färgar temperament, stressrespons och mognadstempo.", "Colors temperament, stress response, and maturation pace.")],
        [t("Trigon", "Trine"), localizeZodiacTrine(data?.chineseZodiac?.trine), t("Gruppdynamik: djur med liknande rytm och elementfamilj.", "Group dynamics: animals with similar rhythm and element family.")],
        [t("Jordgren", "Earthly branch"), safe(data?.chineseZodiac?.earthlyBranch), t("Traditionell klassificering i den kinesiska cykeln.", "Traditional classification in the Chinese cycle.")],
      ];
      renderTable(
        "table-zodiac",
        [t("Fält", "Field"), t("Värde", "Value"), t("Hur du tolkar det", "How to Interpret It")],
        zodiacRows
      );

      setText("life-summary-title", t("Möjlig livsresa", "Possible Life Trajectory"));
      setText(
        "life-summary-lead",
        t(
          "Den här sammanfattningen är en helsidesläsning för en nyfödd, baserad på astrologi, Human Design och kinesisk zodiak.",
          "This section is a full-page integrated newborn reading based on astrology, Human Design, and Chinese zodiac."
        )
      );
      const lifeSummaryBody = document.getElementById("life-summary-body");
      if (lifeSummaryBody) {
        const paragraphs = buildLifeJourneySummary();
        lifeSummaryBody.innerHTML = paragraphs.map((paragraph) => `<p>${highlightAttributeText(paragraph)}</p>`).join("");
      }

      setText(
        "footer-line",
        `${t("Genererad", "Generated")} ${fmtDate(data?.generatedAt)} • ${t("Sputnet World Profile Engine", "Sputnet Space Profile Engine")}`
      );

      renderHdVisuals();
    };

    const bindActions = () => {
      const printBtn = document.getElementById("print-btn");
      const closeBtn = document.getElementById("close-btn");

      if (printBtn) {
        printBtn.textContent = t("Skriv ut / Spara PDF", "Print / Save PDF");
        printBtn.addEventListener("click", () => window.print());
      }

      if (closeBtn) {
        closeBtn.textContent = t("Stäng", "Close");
        closeBtn.addEventListener("click", () => {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.close();
          }
        });
      }
    };

    setCover();
    setCore();
    setPlanets();
    setIntegration();
    bindActions();

    if (shouldPrint) {
      window.addEventListener("load", () => {
        setTimeout(() => window.print(), 220);
      });
    }
  </script>
</body>
</html>
